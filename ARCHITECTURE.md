# UIpowershell - アーキテクチャドキュメント

**最終更新:** 2025-10-29
**理解度:** 88%

---

## 📋 プロジェクト概要

**種類:** PowerShellベースの視覚的RPAプラットフォーム
**目的:** ドラッグ&ドロップでワークフローを構築できる自動化ツール
**規模:** 37ファイル、8,091行のコード

---

## 🏗️ アーキテクチャ概要

### メインフロー
```
起動
  ↓
01_メインフォーム_メイン.ps1（エントリーポイント）
  ↓
全.ps1ファイル読み込み（ドットソーシング）
  ↓
UI初期化
  ↓
ボタン配置（JSONから生成）
  ↓
イベント登録
  ↓
ShowDialog（メインループ）
```

---

## 🎨 主要機能

### 1. レイヤーシステム（階層表現）

**目的:** 深い階層のワークフローを視覚的に表現

```
レイヤー0 ← レイヤー1 ← レイヤー2 ← レイヤー3 ← ... レイヤー6
(非表示)   (表示中)   (表示中)   (非表示)

左ボタン(▶): 右にスライド → 深い階層へドリルダウン
右ボタン(◀): 左にスライド → 浅い階層へ戻る
```

**実装:**
- `$Global:可視左パネル`: 現在表示中の左パネル
- `$Global:可視右パネル`: 現在表示中の右パネル
- `$Global:不可視左の左パネル`: 非表示の左パネル
- `$Global:不可視右の右パネル`: 非表示の右パネル

**関連ファイル:** 06_メインフォームUI_フレーム移動.ps1

---

### 2. ピンク選択機能（スクリプト化）

**目的:** 複数ノードをグループ化してサブルーチン化

**使い方:**
1. SHIFTキー押下
2. ノードを複数選択
3. レイヤーボタン押下
4. 選択したノードがピンク色に変わる
5. 右側のレイヤーにスクリプト詳細が表示される

**データ構造:**
```powershell
$Global:Pink選択配列 = @(
    [PSCustomObject]@{
        レイヤー = 0
        Y座標 = 0
        値 = 0
        展開ボタン = 0
    },
    # ... レイヤー1-6
)

$Global:Pink選択中 = $false  # 現在選択中かどうか
```

**用途:**
- 複雑なワークフローを折りたたむ
- サブルーチンのような機能
- 右レイヤーで詳細を展開

---

### 3. ドラッグ&ドロップシステム

**機能:**
- ノード（ボタン）をドラッグして配置
- 自動スナップ（中央揃え）
- 衝突検知
- ネスト規制

**イベントフロー:**
```
MouseDown → ドラッグ開始
   ↓
DragEnter → ドロップ可能か判定
   ↓
DragDrop → 配置処理
   ↓
ネスト規制チェック
   ↓
配置 or 拒否
   ↓
00_ボタンの上詰め再配置関数（整列）
   ↓
00_矢印追記処理（接続線描画）
```

**関連ファイル:** 02_メインフォームUI_foam関数.ps1

---

### 4. ネスト規制（レイアウト保護）

**目的:** 中途半端な配置でレイアウトやコード生成が崩れるのを防ぐ

**ルール:**

#### ❌ 禁止パターン
```
ループ開始
  ├─ ノードA
  ├─ 条件分岐開始  ← 一部だけループ内
  │    └─ ノードB
ループ終了
  └─ 条件分岐終了  ← 一部がループ外
```

#### ✅ OKパターン
```
ループ開始
  ├─ ノードA
  ├─ 条件分岐開始  ← 全体がループ内
  │    └─ ノードB
  └─ 条件分岐終了  ← 全体がループ内
ループ終了
```

**実装:** `ドロップ禁止チェック_ネスト規制`関数（282行）

**関連色:**
- 🟢 緑色（SpringGreen）: 条件分岐
- 🟡 黄色（LemonChiffon）: ループ

---

### 5. GroupID管理

**目的:** 開始/終了ボタンのペアを識別

**割り当てタイミング:**
- 条件分岐ノード生成時（`ShowConditionBuilder`）
- ループノード生成時（`ShowLoopBuilder`）

**使用箇所:**
- ネスト規制の判定
- グループ範囲の計算
- ボタンペアの追跡

**例:**
```powershell
条件分岐開始.Tag.GroupID = 1
条件分岐終了.Tag.GroupID = 1  # 同じID = ペア
```

---

### 6. JSON管理

#### 設定ファイル
- **ボタン設定.json**: ボタンの定義（処理番号、テキスト、色、関数名）
- **個々の履歴/メイン.json**: アクティブな履歴フォルダのパス
- **個々の履歴/[folder]/variables.json**: 変数データ
- **個々の履歴/[folder]/memory.json**: ワークフローの状態
- **個々の履歴/[folder]/コード.json**: 生成されたコード

#### JSON操作関数
```powershell
JSONストアを初期化          # 初期化
IDを生成する                # 新しいID取得
エントリを追加              # データ追加
IDでエントリを取得          # データ取得
IDでエントリを削除          # データ削除
```

**関連ファイル:** 09_変数機能_コードID管理JSON.ps1

---

### 7. 矢印描画システム

**目的:** ノード間の接続を視覚化

**描画対象:**
- 順次実行の矢印（白→白）
- 条件分岐の分岐線（緑→青/赤）
- ループの矢印（黄色→黄色）
- ピンクノードの展開矢印

**データ構造:**
```powershell
$フレームパネル.Tag.DrawObjects += [PSCustomObject]@{
    Type = "Line"
    StartPoint = [System.Drawing.Point]::new(x1, y1)
    EndPoint = [System.Drawing.Point]::new(x2, y2)
    Color = [System.Drawing.Color]::Blue
}
```

**関連ファイル:** 05_メインフォームUI_矢印処理.ps1

---

## 📁 ファイル構成

### エントリーポイント
- **実行.bat**: PowerShellを実行ポリシーバイパスで起動
- **01_メインフォーム_メイン.ps1**: メインスクリプト

### UI関連
- **02_メインフォームUI_foam関数.ps1** (2,292行): UI生成、ドラッグ&ドロップ
- **03_メインフォームUI_ノードボタンメニュー処理.ps1** (空): 未実装
- **04_メインフォームUI_スクリプト処理.ps1** (空): 未実装
- **05_メインフォームUI_矢印処理.ps1** (690行): 矢印描画ロジック
- **06_メインフォームUI_フレーム移動.ps1** (390行): レイヤー移動

### 機能関連
- **08_メインF機能_メインボタン処理.ps1** (490行): メインボタンイベント
- **09_変数機能_コードID管理JSON.ps1** (528行): JSON管理
- **10_変数機能_変数管理UI.ps1** (457行): 変数管理UI
- **11_変数機能_変数管理を外から読み込む関数.ps1**: 変数読み込み

### コード生成
- **12_コードメイン_コード本文.ps1**: コード生成メイン
- **13_コードサブ汎用関数.ps1**: 汎用関数
- **14_コードサブ_EXCEL.ps1**: Excel関連
- **15_コードサブ_if文条件式作成.ps1** (939行): 条件分岐ビルダー

### アクションモジュール（01_code/）
- **1-1_順次実行.ps1** - **1-8_指定時間待機.ps1**: 制御構文
- **2-1_マウス座標取得.ps1**, **2-2_マウス移動.ps1**: マウス操作
- **3-1_キー操作.ps1**, **3-2_キー入力.ps1**: キーボード操作
- **4-1_UI.ps1**, **4-2_UI2.ps1**: UI Automation
- **5-1_アプリ実行.ps1**: アプリケーション起動
- **8-1_Excel.ps1**: Excel操作
- **9-1_ウインドウ存在確認.ps1**: ウィンドウ検索
- **10-1_画像マッチング.ps1**: 画像認識
- **99-1_カスタム処理.ps1**: カスタムスクリプト

---

## 🎨 色の意味

| 色 | 用途 | RGB |
|----|------|-----|
| ⚪ White | 通常のノード | 255, 255, 255 |
| 🟢 SpringGreen | 条件分岐 | 0, 255, 127 |
| 🟡 LemonChiffon | ループ | 255, 250, 205 |
| 🔴 Salmon | 条件分岐の真（then）側 | 250, 128, 114 |
| 🔵 青色 | 条件分岐の偽（else）側 | 200, 220, 255 |
| 🩷 Pink | スクリプト化されたノード | 255, 192, 203 |
| 🩷 ピンク青色 | スクリプト内のelse側 | 227, 206, 229 |
| 🩷 ピンク赤色 | スクリプト内のthen側 | 252, 160, 158 |

---

## 🔧 重要なグローバル変数

### UI状態
```powershell
$global:レイヤー0 - $global:レイヤー6  # レイヤーパネル
$Global:可視左パネル                    # 現在表示中の左パネル
$Global:可視右パネル                    # 現在表示中の右パネル
$Global:不可視左の左パネル              # 非表示の左パネル
$Global:不可視右の右パネル              # 非表示の右パネル
```

### カウンター
```powershell
$global:ボタンカウンタ                  # ボタンID生成用
$global:黄色ボタングループカウンタ      # ループのGroupID
$global:緑色ボタングループカウンタ      # 条件分岐のGroupID
```

### ドラッグ状態
```powershell
$global:ドラッグ中のボタン              # 現在ドラッグ中のボタン
$global:drawObjects                     # 描画オブジェクトリスト
```

### ピンク選択
```powershell
$Global:Pink選択中                      # 選択モード中か
$Global:Pink選択配列                    # レイヤーごとの選択情報
$Global:現在展開中のスクリプト名        # 展開中のスクリプト
```

### パス
```powershell
$global:folderPath                      # 履歴フォルダパス
$global:JSONPath                        # variables.jsonのパス
```

---

## ⚠️ 既知の問題

### 1. ハードコードされたパス
```powershell
# 01_メインフォーム_メイン.ps1:13
Set-Location -Path "$env:USERPROFILE\Documents\WindowsPowerShell\chord"

# 01_メインフォーム_メイン.ps1:262
$jsonPath1 = "C:\Users\hello\Documents\WindowsPowerShell\chord\RPA-UI2\個々の履歴\AAAAAA111\コード.json"
```
→ 特定のユーザー名とパスに依存

### 2. 初期化されていない変数
```powershell
# 05_メインフォームUI_矢印処理.ps1:33
if (-not $hasProcessedPink -and ...) {
    # $hasProcessedPinkはどこで初期化されている？
}
```

### 3. 重複したグローバル変数定義
```powershell
# 01_メインフォーム_メイン.ps1:64, 195
$Global:表示スクリプト座標 = @{ X = 0; Y = 0 }  # 2回定義
```

### 4. デバッグコードが残っている
```powershell
# 01_メインフォーム_メイン.ps1:262-263
$jsonPath1 = "C:\Users\hello\..."
デバッグJSONファイル -jsonPath $jsonPath1  # 本番でも実行される
```

### 5. 空のファイル
- 03_メインフォームUI_ノードボタンメニュー処理.ps1
- 04_メインフォームUI_スクリプト処理.ps1

---

## 🚀 改善案

詳細は `REFACTORING_PLAN.md` を参照してください。

優先度の高い改善:
1. ハードコードされたパスの設定ファイル化
2. エラーハンドリングの追加
3. 大きい関数の分割（特に282行の`ドロップ禁止チェック_ネスト規制`）
4. グローバル変数の削減
5. コメントとドキュメントの充実

---

## 📚 参考情報

### 関連ドキュメント
- **REFACTORING_PLAN.md**: リファクタリング計画
- **ボタン設定.json**: ボタン定義
- **名前ルール.txt**: 命名規則

### 技術スタック
- PowerShell 5.0+
- System.Windows.Forms
- System.Drawing
- JSON
- DPI Awareness API

---

## 💡 次のステップ

このドキュメントを更新するには:
```bash
git add ARCHITECTURE.md
git commit -m "Update: アーキテクチャドキュメントを更新"
git push
```

次回Claude Codeセッションで、このファイルを読んでもらえば、理解度88%からスタートできます！

---

**最終更新:** 2025-10-29
**作成者:** Claude Code (AI-assisted)
**理解度:** 88% （良好な理解レベル）
