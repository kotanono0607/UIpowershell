# UIpowershell システム仕様書

**バージョン**: 1.0
**作成日**: 2025年11月1日
**システム名**: UIpowershell - ビジュアルRPAプラットフォーム
**開発言語**: PowerShell 5.1+
**フレームワーク**: Windows Forms (.NET Framework)

---

## 目次

1. [システム概要](#1-システム概要)
2. [機能仕様](#2-機能仕様)
3. [データ構造仕様](#3-データ構造仕様)
4. [UI仕様](#4-ui仕様)
5. [アーキテクチャ仕様](#5-アーキテクチャ仕様)
6. [技術仕様](#6-技術仕様)
7. [運用仕様](#7-運用仕様)
8. [非機能要件](#8-非機能要件)

---

## 1. システム概要

### 1.1 目的

UIpowershellは、プログラミング知識がないユーザーでもRPA（Robotic Process Automation）処理を視覚的に構築できるツールです。ノードをドラッグ&ドロップで配置し、フローチャートのように処理を組み立てることで、自動的にPowerShellスクリプトを生成します。

### 1.2 主な用途

- **Excel/CSVデータの読み込み → Webシステムへの転記**（メインユースケース）
- アプリケーションの自動操作
- 画像マッチングによるUI操作
- キーボード/マウス操作の自動化
- 条件分岐・ループを含む複雑な業務フロー自動化

### 1.3 システムの特徴

1. **ノーコード/ローコード開発**: ドラッグ&ドロップでRPA処理を構築
2. **ビジュアルフローチャート**: 処理フローを視覚的に表現
3. **自動コード生成**: ノード配置から自動的にPowerShellスクリプトを生成
4. **階層構造**: 7階層のレイヤーシステムで複雑な処理を整理
5. **ネスト規制**: 誤った構造を防ぐ自動検証機能
6. **再利用可能なスクリプト化**: 共通処理をサブルーチン化

### 1.4 技術スタック

| カテゴリ | 技術 |
|---------|------|
| プログラミング言語 | PowerShell 5.1+ |
| UIフレームワーク | Windows Forms (.NET Framework) |
| データ永続化 | JSON |
| エンコーディング | UTF-8 BOM |
| プラットフォーム | Windows 10/11 |
| 前提条件 | .NET Framework 4.5+ |

---

## 2. 機能仕様

### 2.1 ビジュアルノード配置機能

#### 2.1.1 ノードタイプ

| ノードタイプ | 背景色 | 用途 | 処理番号プレフィックス |
|------------|-------|------|---------------------|
| **順次処理（White）** | White | 通常の順次処理 | 1-1, 1-4, 1-5, 1-6, 1-7, 1-8 |
| **条件分岐（SpringGreen）** | SpringGreen | if-else構造 | 1-2 |
| **ループ（LemonChiffon）** | LemonChiffon | 繰り返し処理 | 1-3 |
| **順次/特殊（Salmon）** | Salmon | 制御構造内の処理 | 継承 |
| **スクリプト化（Pink）** | Pink系 | サブルーチン化されたノード群 | - |

#### 2.1.2 ノード操作

| 操作 | 方法 | 説明 |
|-----|------|------|
| **ノード追加** | ドラッグ&ドロップ | 左側パレットからレイヤーへドラッグ |
| **ノード移動** | ドラッグ | ノードをドラッグして位置変更 |
| **ノード設定** | クリック | ノードをクリックして設定ダイアログ表示 |
| **複数選択** | SHIFT+クリック | ピンク選択モード（スクリプト化用） |
| **ノード削除** | （未実装） | 右クリックメニュー機能として予定 |

#### 2.1.3 ノードID命名規則

| パターン | 例 | 説明 |
|---------|---|------|
| `{数字}-{分岐}` | 100-1 | 基本ノード |
| `{GroupID}-{分岐番号}` | 61-1, 61-2, 61-3 | 制御構造（61-1=if開始, 61-2=else, 61-3=終了） |
| `{GroupID}-{親分岐}-{子番号}` | 54-1-1 | 入れ子構造 |

### 2.2 レイヤーシステム機能

#### 2.2.1 レイヤー階層構造

```
レイヤー0: 非表示（予備）
レイヤー1: メイン作業領域 (X=550, 常時表示)
レイヤー2: サブ領域 (X=940, 表示)
レイヤー3～6: 深い階層用 (X=1330, 非表示)
```

#### 2.2.2 レイヤー遷移

- **ドリルダウン方式**: 深い階層を表現するためのスライド移動
- **アニメーション**: レイヤー間のスムーズな移動
- **可視管理**:
  - `$global:可視左パネル`: 現在表示中の左パネル
  - `$global:可視右パネル`: 現在表示中の右パネル
  - `$global:レイヤー階層の深さ`: 現在のレイヤー深さ

#### 2.2.3 レイヤーボタン

- **レイヤー化ボタン**: ピンク選択したノード群をスクリプト化
- **戻るボタン**: 前のレイヤーに戻る

### 2.3 ネスト規制機能

#### 2.3.1 規制ルール

1. **ループ（黄）と条件分岐（緑）の相互ネスト禁止**
   - 条件分岐をループの中に配置: 禁止
   - ループを条件分岐の中に配置: 禁止

2. **同色ブロックの領域侵入禁止**
   - 既存の制御構造（開始～終了）の範囲をまたぐ移動: 禁止
   - 制御構造の中間に割り込む移動: 禁止

#### 2.3.2 実装関数

- **関数名**: `ドロップ禁止チェック_ネスト規制`
- **ファイル**: `02_メインフォームUI_foam関数.ps1`
- **処理**:
  1. 移動先のY座標範囲を取得
  2. 既存の制御構造（GroupID管理）と照合
  3. 禁止パターンに該当する場合は警告ダイアログを表示
  4. ドラッグ状態をリセット

### 2.4 ピンク選択（スクリプト化）機能

#### 2.4.1 概要

複数のノードをまとめて「スクリプト化」し、再利用可能なサブルーチンとして管理する機能。

#### 2.4.2 操作手順

1. **選択**: SHIFTキーを押しながら複数ノードをクリック
2. **スクリプト化**: レイヤーボタンをクリック
3. **視覚化**: 選択したノードがピンク色に変化
4. **詳細表示**: 右側のレイヤーに詳細が表示される

#### 2.4.3 データ構造

```json
{
  "176-1": "AAAA\r\n169-1;White;順次;\r\n170-1;White;順次;"
}
```

- **フォーマット**: `AAAA_ボタン名;色;テキスト_...`
- **区切り文字**: `_` （表示時は `\r\n` に変換）

#### 2.4.4 グローバル変数

```powershell
$Global:Pink選択配列 = @()  # 各レイヤーのピンク選択情報
$Global:Pink選択中 = $false  # ピンク選択モードのフラグ
$Global:現在展開中のスクリプト名 = ""  # 現在展開中のスクリプト名
```

### 2.5 GroupID管理機能

#### 2.5.1 概要

条件分岐（緑）とループ（黄）の開始・中間・終了をグループとして管理し、整合性を保証する機能。

#### 2.5.2 GroupID番号体系

| 制御構造 | GroupID範囲 | グローバル変数 |
|---------|-----------|-------------|
| **ループ** | 1000番台 | `$global:黄色ボタングループカウンタ` |
| **条件分岐** | 2000番台 | `$global:緑色ボタングループカウンタ` |

#### 2.5.3 GroupID構成要素

**条件分岐（SpringGreen）の場合:**

```json
{
  "ボタン名": "235-1",
  "ボタン色": "SpringGreen",
  "テキスト": "条件分岐 開始",
  "GroupID": 1
}
{
  "ボタン名": "235-2",
  "ボタン色": "Gray",
  "テキスト": "条件分岐 中間",
  "GroupID": ""
}
{
  "ボタン名": "235-3",
  "ボタン色": "SpringGreen",
  "テキスト": "条件分岐 終了",
  "GroupID": 1
}
```

**ループ（LemonChiffon）の場合:**

```json
{
  "ボタン名": "236-1",
  "ボタン色": "LemonChiffon",
  "テキスト": "ループ 開始",
  "GroupID": 1
}
{
  "ボタン名": "236-2",
  "ボタン色": "LemonChiffon",
  "テキスト": "ループ 終了",
  "GroupID": 1
}
```

#### 2.5.4 GroupID管理関数

| 関数名 | ファイル | 用途 |
|-------|---------|------|
| `Get-GroupRangeAfterMove` | 02_メインフォームUI_foam関数.ps1 | GroupID範囲計算 |

### 2.6 変数管理機能

#### 2.6.1 変数タイプ

| 変数タイプ | 説明 | データ例 |
|-----------|------|---------|
| **Excel2次元配列** | Excel/CSVから読み込んだ表形式データ | `[["A","B","C"],[1,"ww","あいう"]]` |
| **単一変数** | 実行時に使用するパス・値 | `"C:\\Users\\...\\gimp-2.10.exe"` |

#### 2.6.2 変数の保存先

- **ファイルパス**: `{ワークフローフォルダ}/variables.json`
- **グローバル変数**: `$global:JSONPath`

#### 2.6.3 変数管理UI

- **ファイル**: `10_変数機能_変数管理UI.ps1`
- **機能**:
  - Excel/CSV読み込み
  - 変数の追加・編集・削除
  - 2次元配列のプレビュー

### 2.7 自動コード生成機能

#### 2.7.1 コード生成フロー

```
[1] ユーザーがノードを配置
     ↓
[2] memory.json に配置情報を保存
     ↓
[3] ノード設定を入力
     ↓
[4] コード.json にコードスニペットを保存
     ↓
[5] 「実行」ボタンをクリック
     ↓
[6] 実行イベント関数が起動（08_メインF機能_メインボタン処理.ps1）
     ├─ レイヤー1からボタンをY座標順に取得
     ├─ 各ボタンIDで「IDでエントリを取得」を呼び出し
     ├─ 特殊処理: Redボタン→Blueボタンの間にelse分岐挿入
     │   └─ specialId = lastGreenParentId-2
     └─ $outputに全コードを蓄積
     ↓
[7] output.ps1 に書き込み（UTF-8エンコーディング）
     ↓
[8] PowerShell ISE で自動的に開く
```

#### 2.7.2 コード生成関数

| 関数名 | ファイル | 用途 |
|-------|---------|------|
| `実行イベント` | 08_メインF機能_メインボタン処理.ps1 | メイン実行処理 |
| `00_文字列処理内容` | 12_コードメイン_コード本文.ps1 | コードスニペット生成 |
| `IDでエントリを取得` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonから取得 |

#### 2.7.3 出力ファイル

- **ファイル名**: `output.ps1`
- **保存先**: `{ワークフローフォルダ}/output.ps1`
- **エンコーディング**: UTF-8

---

## 3. データ構造仕様

### 3.1 memory.json - ノード配置情報

#### 3.1.1 概要

各レイヤーのノード配置を記録し、UIの状態を完全に復元可能にする。

#### 3.1.2 スキーマ

```json
{
  "{レイヤー番号}": {
    "構成": [
      {
        "ボタン名": "string",        // ノードID（例: 215-1）
        "X座標": int,                // X座標（ピクセル）
        "Y座標": int,                // Y座標（ピクセル）
        "順番": int,                 // ソート順
        "ボタン色": "string",        // 色名（White, SpringGreen, LemonChiffon等）
        "テキスト": "string",        // ノード表示テキスト
        "処理番号": "string",        // 処理番号（例: 1-3）
        "高さ": int,                 // ノード高さ（ピクセル）
        "幅": int,                   // ノード幅（ピクセル）
        "script": "string",          // スクリプト化情報（"未設定" または スクリプト名）
        "GroupID": int | ""          // GroupID（制御構造の場合のみ）
      }
    ]
  }
}
```

#### 3.1.3 データ例

```json
{
  "1": {
    "構成": [
      {
        "ボタン名": "235-1",
        "X座標": 90,
        "Y座標": 20,
        "順番": 1,
        "ボタン色": "SpringGreen",
        "テキスト": "条件分岐 開始",
        "処理番号": "1-2",
        "高さ": 30,
        "幅": 120,
        "script": "未設定",
        "GroupID": 1
      },
      {
        "ボタン名": "237-1",
        "X座標": 90,
        "Y座標": 70,
        "順番": 2,
        "ボタン色": "Salmon",
        "テキスト": "順次",
        "処理番号": "1-1",
        "高さ": 30,
        "幅": 120,
        "script": "未設定",
        "GroupID": ""
      }
    ]
  },
  "2": { "構成": [] }
}
```

### 3.2 コード.json - 生成コードスニペット

#### 3.2.1 概要

各ノードIDに対応するPowerShellコードを保存。

#### 3.2.2 スキーマ

```json
{
  "エントリ": {
    "{ノードID}": "string"  // PowerShellコード
  },
  "最後のID": int  // 次に作成されるノードのID
}
```

#### 3.2.3 データ例

```json
{
  "エントリ": {
    "100-1": "Write-Host \"OK\"",
    "61-1": "if () {",
    "61-2": "} else {",
    "61-3": "}",
    "54-1-1": "if () {",
    "176-1": "AAAA\r\n169-1;White;順次;\r\n170-1;White;順次;"
  },
  "最後のID": 215
}
```

#### 3.2.4 特殊エントリ

| パターン | 説明 |
|---------|------|
| `if () {` | 条件分岐開始 |
| `} else {` | else分岐 |
| `}` | 制御構造終了 |
| `AAAA\r\n...` | ピンクノード詳細（`AAAA` + ノード一覧） |

### 3.3 variables.json - 実行時変数

#### 3.3.1 概要

Excel/CSVから読み込んだデータを保存し、実行時に変数として参照。

#### 3.3.2 スキーマ

```json
{
  "{変数名}": any  // 値（文字列、配列、オブジェクト等）
}
```

#### 3.3.3 データ例

```json
{
  "Excel2次元配列": [
    ["A", "B", "C"],
    [1, "ww", "あいう"],
    [2, "ee", "ｓｄｆｔｇ"]
  ],
  "GINPパス": "C:\\Users\\hallo\\AppData\\Local\\Programs\\GIMP 2\\bin\\gimp-2.10.exe"
}
```

### 3.4 ボタン設定.json - ノード定義

#### 3.4.1 概要

各ノードの処理番号と関数名のマッピング、UI表示情報を定義。

#### 3.4.2 スキーマ

```json
[
  {
    "処理番号": "string",    // 処理番号（例: 1-1）
    "テキスト": "string",    // ノード表示テキスト
    "ボタン名": "string",    // ボタン識別子
    "背景色": "string",      // 背景色名
    "コンテナ": "string",    // 配置先パネル名
    "説明": "string",        // 説明文
    "関数名": "string"       // 実行される関数名
  }
]
```

#### 3.4.3 データ例

```json
[
  {
    "処理番号": "1-1",
    "テキスト": "順次",
    "ボタン名": "1",
    "背景色": "White",
    "コンテナ": "操作フレームパネル1",
    "説明": "順次処理に関する説明文をここに記載します。",
    "関数名": "1_1"
  },
  {
    "処理番号": "1-2",
    "テキスト": "条件分岐",
    "ボタン名": "2",
    "背景色": "SpringGreen",
    "コンテナ": "操作フレームパネル1",
    "説明": "条件分岐に関する説明文をここに記載します。",
    "関数名": "ShowConditionBuilder"
  }
]
```

### 3.5 メイン.json - 現在のワークフローフォルダ

#### 3.5.1 概要

現在作業中のワークフローフォルダパスを保存。

#### 3.5.2 スキーマ

```json
{
  "フォルダパス": "string"  // ワークフォルダの絶対パス
}
```

#### 3.5.3 データ例

```json
{
  "フォルダパス": "C:\\Users\\user\\UIpowershell\\個々の履歴\\AAAAAA111"
}
```

---

## 4. UI仕様

### 4.1 メインフォーム

#### 4.1.1 基本プロパティ

| プロパティ | 値 | 説明 |
|-----------|---|------|
| **タイトル** | "ドラッグ＆ドロップでボタンの位置を変更" | ウィンドウタイトル |
| **幅** | 1400px | フォーム幅 |
| **高さ** | 900px | フォーム高さ |
| **StartPosition** | CenterScreen | 画面中央に表示 |
| **FormBorderStyle** | Sizable | サイズ変更可能 |
| **WindowState** | Normal | 通常表示 |
| **TopMost** | false | 常時前面表示なし |
| **BackColor** | RGB(255,255,255) | 白背景 |

#### 4.1.2 イベントハンドラ

| イベント | 処理 | 説明 |
|---------|------|------|
| **Shown** | 最小化防止、前面化 | フォーム表示時の初期化 |
| **Resize** | 最小化復帰 | 最小化を防ぐ |

### 4.2 レイヤーパネル

#### 4.2.1 パネル配置

| レイヤー | X座標 | 表示状態 | 用途 |
|---------|------|---------|------|
| **レイヤー0** | - | 非表示 | 予備 |
| **レイヤー1** | 550 | 常時表示 | メイン作業領域 |
| **レイヤー2** | 940 | 表示 | サブ領域 |
| **レイヤー3** | 1330 | 非表示 | 深い階層用 |
| **レイヤー4** | 1330 | 非表示 | 深い階層用 |
| **レイヤー5** | 1330 | 非表示 | 深い階層用 |
| **レイヤー6** | 1330 | 非表示 | 深い階層用 |

#### 4.2.2 パネルプロパティ

| プロパティ | 値 | 説明 |
|-----------|---|------|
| **AllowDrop** | true | ドロップ可能 |
| **BackColor** | 青色系 | レイヤー背景色 |
| **BorderStyle** | Fixed3D | 枠線表示 |

### 4.3 ノードパレット（左側パネル）

#### 4.3.1 操作フレームパネル構成

| パネル | 配置ノード |
|-------|----------|
| **操作フレームパネル1** | 順次、条件分岐、ループ、読み込みテスト、テストノード生成、メッセージボックス表示、変数取得、指定時間待機 |
| **操作フレームパネル2** | マウス座標取得、マウス移動 |
| **操作フレームパネル3** | キー操作、キー入力 |
| **操作フレームパネル4** | UI、UI2 |
| **操作フレームパネル5** | アプリ実行 |
| **操作フレームパネル8** | Excel |
| **操作フレームパネル9** | ウインドウ存在確認、カスタム処理 |
| **操作フレームパネル10** | 画像マッチング確認 |

### 4.4 ツールバー

#### 4.4.1 メインボタン

| ボタン名 | 機能 | ファイル |
|---------|------|---------|
| **実行** | コード生成とPowerShell ISE起動 | 08_メインF機能_メインボタン処理.ps1 |
| **変数** | 変数管理UIを表示 | 10_変数機能_変数管理UI.ps1 |
| **フォルダ切替** | ワークフローフォルダを切り替え | 08_メインF機能_メインボタン処理.ps1 |
| **フォルダ作成** | 新しいワークフローフォルダを作成 | 08_メインF機能_メインボタン処理.ps1 |

#### 4.4.2 レイヤーボタン

| ボタン名 | 機能 | 説明 |
|---------|------|------|
| **レイヤー化→** | ピンク選択のスクリプト化 | SHIFT+クリックで選択したノードをスクリプト化 |
| **←戻る** | 前のレイヤーに戻る | レイヤー階層を1つ上に移動 |

### 4.5 ノードデザイン

#### 4.5.1 色定義

| ノードタイプ | 色名 | RGB | 説明 |
|------------|-----|-----|------|
| **順次処理** | White | RGB(255,255,255) | 通常処理 |
| **条件分岐** | SpringGreen | RGB(0,255,127) | if-else構造 |
| **ループ** | LemonChiffon | RGB(255,250,205) | 繰り返し処理 |
| **順次/特殊** | Salmon | RGB(250,128,114) | 制御構造内の処理 |
| **ピンク青色** | - | RGB(227,206,229) | ピンク選択（通常） |
| **ピンク赤色** | - | RGB(252,160,158) | ピンク選択（特殊） |
| **中間ノード** | Gray | RGB(128,128,128) | 条件分岐中間（非表示） |

#### 4.5.2 ノードサイズ

| ノードタイプ | 幅 | 高さ | 説明 |
|------------|---|-----|------|
| **標準ノード** | 120px | 30px | 通常のノード |
| **中間ノード** | 120px | 1px | 条件分岐の中間（ほぼ非表示） |

### 4.6 矢印描画

#### 4.6.1 矢印タイプ

| タイプ | 色 | 説明 |
|-------|---|------|
| **順次接続** | 黒 | ノード間の順次接続 |
| **条件分岐** | 緑 | 条件分岐の分岐 |
| **ループ** | 黄 | ループの接続 |

#### 4.6.2 矢印描画関数

- **関数名**: `00_矢印追記処理`
- **ファイル**: `05_メインフォームUI_矢印処理.ps1`
- **処理**:
  1. フレーム内のボタンをY座標順に取得
  2. 各ノード間に矢印を描画
  3. ピンクノードの特殊処理

---

## 5. アーキテクチャ仕様

### 5.1 システムアーキテクチャ

#### 5.1.1 レイヤーアーキテクチャ

```
┌─────────────────────────────────────┐
│   プレゼンテーション層               │
│   - メインフォーム                   │
│   - ノードパレット                   │
│   - レイヤーパネル                   │
└─────────────────────────────────────┘
              ↓↑
┌─────────────────────────────────────┐
│   ビジネスロジック層                 │
│   - ノード管理                       │
│   - レイヤー管理                     │
│   - GroupID管理                      │
│   - ネスト規制                       │
│   - コード生成                       │
└─────────────────────────────────────┘
              ↓↑
┌─────────────────────────────────────┐
│   データアクセス層                   │
│   - JSON読み書き                     │
│   - ファイル操作                     │
└─────────────────────────────────────┘
              ↓↑
┌─────────────────────────────────────┐
│   データ永続化層                     │
│   - memory.json                      │
│   - コード.json                      │
│   - variables.json                   │
│   - ボタン設定.json                  │
│   - メイン.json                      │
└─────────────────────────────────────┘
```

### 5.2 モジュール構成

#### 5.2.1 ファイル分割方針

| プレフィックス | 役割 | ファイル例 |
|-------------|------|----------|
| **01_** | メインエントリポイント・初期化 | 01_メインフォーム_メイン.ps1 |
| **02_** | UI関連関数 | 02_メインフォームUI_foam関数.ps1 |
| **03_～04_** | UI拡張機能（未実装） | 03_メインフォームUI_ノードボタンメニュー処理.ps1 |
| **05_** | UI描画・レンダリング | 05_メインフォームUI_矢印処理.ps1 |
| **06_** | レイヤー操作 | 06_メインフォームUI_フレーム移動.ps1 |
| **07_** | ノード追加ロジック | 07_メインF機能_ツールバー作成.ps1 |
| **08_** | イベントハンドラー | 08_メインF機能_メインボタン処理.ps1 |
| **09_** | データ永続化 | 09_変数機能_コードID管理JSON.ps1 |
| **10_～11_** | データ変換（ノード⇔JSON） | 10_変数機能_変数管理UI.ps1 |
| **12_～15_** | コード生成 | 12_コードメイン_コード本文.ps1 |

#### 5.2.2 主要モジュール

```
UIpowershell/
├── 01_メインフォーム_メイン.ps1           # メインエントリポイント
├── 02_メインフォームUI_foam関数.ps1       # UI関数・ネスト規制
├── 03_メインフォームUI_ノードボタンメニュー処理.ps1  # 右クリックメニュー（未実装）
├── 04_メインフォームUI_スクリプト処理.ps1 # スクリプト高度管理（未実装）
├── 05_メインフォームUI_矢印処理.ps1       # ノード間の矢印描画
├── 06_メインフォームUI_フレーム移動.ps1   # レイヤー切り替え
├── 07_メインF機能_ツールバー作成.ps1      # ツールバー作成
├── 08_メインF機能_メインボタン処理.ps1    # 実行・変数・フォルダボタン
├── 09_変数機能_コードID管理JSON.ps1       # JSON操作関数
├── 10_変数機能_変数管理UI.ps1             # 変数管理UI
├── 11_変数機能_変数管理を外から読み込む関数.ps1  # 変数読み込み関数
├── 12_コードメイン_コード本文.ps1         # コード生成メイン
├── 13_コードサブ汎用関数.ps1              # UI入力ダイアログ
├── 14_コードサブ_EXCEL.ps1                # Excel関連処理
├── 15_コードサブ_if文条件式作成.ps1       # 条件式生成
```

### 5.3 グローバル変数一覧

#### 5.3.1 フォーム・パネル関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$global:メインフォーム` | Form | メインウィンドウ |
| `$global:レイヤー0～6` | Panel | 7つのレイヤーパネル |
| `$global:可視左パネル` | Panel | 現在表示中の左パネル |
| `$global:可視右パネル` | Panel | 現在表示中の右パネル |

#### 5.3.2 ノード管理関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$global:ボタンカウンタ` | int | 生成されるボタンのカウンタ |
| `$global:黄色ボタングループカウンタ` | int | ループ用GroupIDカウンタ（1000番台） |
| `$global:緑色ボタングループカウンタ` | int | 条件分岐用GroupIDカウンタ（2000番台） |
| `$global:ドラッグ中のボタン` | Button | ドラッグ中のボタン |
| `$global:drawObjects` | Array | 描画オブジェクトを保持するリスト |

#### 5.3.3 ピンク選択関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$Global:Pink選択配列` | Array | 各レイヤーのピンク選択情報 |
| `$Global:Pink選択中` | bool | ピンク選択モードのフラグ |
| `$Global:現在展開中のスクリプト名` | string | 現在展開中のスクリプト名 |

#### 5.3.4 レイヤー関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$global:レイヤー階層の深さ` | int | 現在のレイヤー深さ |
| `$Global:表示スクリプト座標` | Hashtable | スクリプト表示座標 `@{ X = 0; Y = 0 }` |

#### 5.3.5 データパス関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$global:folderPath` | string | 現在のワークフローフォルダパス |
| `$global:JSONPath` | string | variables.jsonのパス |

#### 5.3.6 色定義関連

| 変数名 | 型 | 説明 |
|-------|---|------|
| `$global:青色` | Color | RGB(200,220,255) |
| `$global:ピンク青色` | Color | RGB(227,206,229) |
| `$global:ピンク赤色` | Color | RGB(252,160,158) |

### 5.4 主要関数一覧

#### 5.4.1 フォーム・UI関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `00_フォームを作成する` | 02_メインフォームUI_foam関数.ps1 | メインフォームを生成 |
| `00_メインにボタンを作成する` | 02_メインフォームUI_foam関数.ps1 | ボタンを作成 |
| `00_フレームのDragDropイベントを設定する` | 02_メインフォームUI_foam関数.ps1 | ドラッグ&ドロップイベント設定 |

#### 5.4.2 ネスト規制関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `ドロップ禁止チェック_ネスト規制` | 02_メインフォームUI_foam関数.ps1 | ネスト規制チェック |
| `10_ボタンの一覧取得` | 02_メインフォームUI_foam関数.ps1 | 同色ブロック衝突チェック |

#### 5.4.3 GroupID管理関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `Get-GroupRangeAfterMove` | 02_メインフォームUI_foam関数.ps1 | GroupID範囲計算 |

#### 5.4.4 矢印描画関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `00_矢印追記処理` | 05_メインフォームUI_矢印処理.ps1 | 矢印描画 |

#### 5.4.5 レイヤー移動関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| （関数名未確認） | 06_メインフォームUI_フレーム移動.ps1 | レイヤー切り替え |

#### 5.4.6 コード生成関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `実行イベント` | 08_メインF機能_メインボタン処理.ps1 | メイン実行処理 |
| `00_文字列処理内容` | 12_コードメイン_コード本文.ps1 | コードスニペット生成 |

#### 5.4.7 JSON操作関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `IDでエントリを取得` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonから取得 |
| `エントリを追加_指定ID` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonに追加 |
| `IDでエントリを置換` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonを置換 |
| `JSON初回` | 09_変数機能_コードID管理JSON.ps1 | JSON初期化 |
| `取得-JSON値` | 09_変数機能_コードID管理JSON.ps1 | JSONから値を取得 |

#### 5.4.8 ノード処理関数（01_code/）

| 処理番号 | 関数名 | ファイル | 説明 |
|---------|-------|---------|------|
| 1-1 | `1_1` | 01_code/1-1.ps1 | 順次処理 |
| 1-2 | `ShowConditionBuilder` | 01_code/1-2.ps1 | 条件分岐 |
| 1-3 | `ShowLoopBuilder` | 01_code/1-3.ps1 | ループ |
| 1-4 | `1_4` | 01_code/1-4.ps1 | 読み込みテスト |
| 1-6 | `1_6` | 01_code/1-6.ps1 | メッセージボックス表示 |
| 1-7 | `1_7` | 01_code/1-7.ps1 | 変数取得 |
| 1-8 | `1_8` | 01_code/1-8.ps1 | 指定時間待機 |
| 2-1 | `2_1` | 01_code/2-1.ps1 | マウス座標取得 |
| 2-2 | `2_2` | 01_code/2-2.ps1 | マウス移動 |
| 3-1 | `3_1` | 01_code/3-1.ps1 | キー操作 |
| 3-2 | `3_2` | 01_code/3-2.ps1 | キー入力 |
| 4-1 | `4_1` | 01_code/4-1.ps1 | UI |
| 4-2 | `4_2` | 01_code/4-2.ps1 | UI2 |
| 5-1 | `5_1` | 01_code/5-1.ps1 | アプリ実行 |
| 8-1 | `8_1` | 01_code/8-1.ps1 | Excel |
| 9-1 | `9_1` | 01_code/9-1.ps1 | ウインドウ存在確認 |
| 10-1 | `10_1` | 01_code/10-1.ps1 | 画像マッチング確認 |
| 99-1 | `99_1` | 01_code/99-1.ps1 | カスタム処理 |

---

## 6. 技術仕様

### 6.1 開発環境

#### 6.1.1 必須環境

| 項目 | 要件 |
|-----|------|
| **OS** | Windows 10/11 |
| **PowerShell** | 5.1以上 |
| **.NET Framework** | 4.5以上 |
| **実行ポリシー** | RemoteSigned以上 |

#### 6.1.2 推奨環境

| 項目 | 推奨 |
|-----|------|
| **PowerShell ISE** | インストール済み（コード実行用） |
| **画面解像度** | 1920x1080以上 |
| **メモリ** | 4GB以上 |

### 6.2 ファイル形式

#### 6.2.1 スクリプトファイル

| 項目 | 仕様 |
|-----|------|
| **拡張子** | .ps1 |
| **エンコーディング** | UTF-8 BOM |
| **改行コード** | CRLF（Windows） |
| **インデント** | 4スペース |

#### 6.2.2 データファイル

| 項目 | 仕様 |
|-----|------|
| **拡張子** | .json |
| **エンコーディング** | UTF-8 |
| **改行コード** | CRLF（Windows） |
| **フォーマット** | インデントあり（可読性優先） |

### 6.3 依存ライブラリ

#### 6.3.1 .NETアセンブリ

```powershell
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing
Add-Type -AssemblyName Microsoft.VisualBasic
```

#### 6.3.2 DPIスケーリング無効化

```powershell
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
public class DPIHelper {
    [DllImport("user32.dll")]
    public static extern bool SetProcessDPIAware();
}
"@
[DPIHelper]::SetProcessDPIAware()
```

### 6.4 コーディング規約

#### 6.4.1 命名規則

| 対象 | 規則 | 例 |
|-----|------|---|
| **関数** | 日本語、動詞始まり | `実行イベント`, `ノードを追加` |
| **グローバル変数** | 日本語、`$global:` プレフィックス | `$global:メインフォーム`, `$global:ボタンカウンタ` |
| **ローカル変数** | 日本語または英語 | `$ボタン名`, `$x` |
| **パラメータ** | 日本語 | `param([int]$幅, [int]$高さ)` |

#### 6.4.2 コメント規則

```powershell
# タイトル: 関数の概要
# 目的: 詳細な説明
function 関数名 {
    # 処理ブロックのコメント
    # ...
}
```

#### 6.4.3 エラーハンドリング

```powershell
try {
    # 処理
} catch {
    Write-Error "エラー: $_"
    [System.Windows.Forms.MessageBox]::Show(
        "エラーメッセージ",
        "エラー",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Error
    )
}
```

### 6.5 DPI対応

#### 6.5.1 DPIスケーリング無効化

高DPI環境での表示崩れを防ぐため、プロセス起動時にDPIスケーリングを無効化。

```powershell
[DPIHelper]::SetProcessDPIAware()
```

---

## 7. 運用仕様

### 7.1 インストール手順

#### 7.1.1 リポジトリクローン

```bash
git clone https://github.com/kotanono0607/UIpowershell.git
cd UIpowershell
```

#### 7.1.2 実行ポリシー設定（初回のみ）

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 7.1.3 起動方法

**方法1: バッチファイルから起動**
```batch
実行.bat
```

**方法2: PowerShellから直接起動**
```powershell
.\01_メインフォーム_メイン.ps1
```

### 7.2 基本操作フロー

#### 7.2.1 新規ワークフロー作成

1. 起動後、「フォルダ作成」ボタンをクリック
2. フォルダ名を入力（例: "プロジェクトA"）
3. `個々の履歴/プロジェクトA/` フォルダが作成される
4. 自動的にそのフォルダに切り替わる

#### 7.2.2 ノード配置とコード生成

1. 左側のパレットからノードを選択
2. レイヤー1にドラッグ&ドロップ
3. ノードをクリックして設定ダイアログを表示
4. 処理内容を入力（例: マウス座標、テキスト入力等）
5. 「実行」ボタンをクリック
6. `output.ps1` が生成され、PowerShell ISEで開く

#### 7.2.3 条件分岐・ループの追加

1. 条件分岐ノード（緑）またはループノード（黄）をドラッグ
2. 開始・中間・終了が自動生成される
3. 中間ノード（灰色）の前後にノードを配置
4. ネスト規制により誤った配置は自動的に防止される

#### 7.2.4 スクリプト化（ピンク選択）

1. SHIFTキーを押しながら複数ノードをクリック
2. 「レイヤー化→」ボタンをクリック
3. 選択したノードがピンク色に変化
4. 右側のレイヤーに詳細が表示される

### 7.3 保存と読み込み

#### 7.3.1 自動保存

- ノード配置は自動的に `個々の履歴/{フォルダ名}/memory.json` に保存
- コードスニペットは `個々の履歴/{フォルダ名}/コード.json` に保存

#### 7.3.2 フォルダ切替

1. 「フォルダ切替」ボタンをクリック
2. フォルダ一覧が表示される
3. 切り替え先のフォルダを選択
4. 自動的にノード配置が復元される

### 7.4 バックアップ

#### 7.4.1 推奨バックアップ対象

```
UIpowershell/
├── 個々の履歴/              # ワークフローデータ
│   ├── メイン.json          # 現在のフォルダパス
│   ├── AAAAAA111/           # ワークフローフォルダ
│   │   ├── コード.json
│   │   ├── memory.json
│   │   ├── variables.json
│   │   └── output.ps1
│   └── AAA/
└── ボタン設定.json          # ノード定義（カスタマイズした場合）
```

#### 7.4.2 バックアップ方法

```powershell
# 方法1: フォルダごとコピー
Copy-Item -Path ".\個々の履歴\AAAAAA111" -Destination "D:\Backup\AAAAAA111_20251101" -Recurse

# 方法2: ZIPアーカイブ
Compress-Archive -Path ".\個々の履歴\AAAAAA111" -DestinationPath "D:\Backup\AAAAAA111_20251101.zip"
```

### 7.5 トラブルシューティング

#### 7.5.1 起動時のエラー

| エラー内容 | 原因 | 対処法 |
|-----------|------|--------|
| **実行ポリシーエラー** | PowerShell実行ポリシーが制限されている | `Set-ExecutionPolicy RemoteSigned` を実行 |
| **アセンブリ読み込みエラー** | .NET Frameworkが古い | .NET Framework 4.5以上をインストール |
| **JSONファイルが見つからない** | 初回起動時に自動生成 | 問題なし（自動生成される） |

#### 7.5.2 ノード配置時のエラー

| エラー内容 | 原因 | 対処法 |
|-----------|------|--------|
| **「この位置には配置できません」** | ネスト規制に違反 | 配置位置を変更 |
| **ノードが消える** | フレーム外にドロップ | ノードをフレーム内にドラッグ |

#### 7.5.3 コード生成時のエラー

| エラー内容 | 原因 | 対処法 |
|-----------|------|--------|
| **output.ps1が生成されない** | レイヤー1にノードがない | ノードを配置してから実行 |
| **コードが空** | ノード設定が未完了 | 各ノードをクリックして設定 |

### 7.6 メンテナンス

#### 7.6.1 JSON整合性チェック

```powershell
# 02_ツール/01_JSON調整.ps1 を使用
.\02_ツール\01_JSON調整.ps1
```

#### 7.6.2 古いワークフローの削除

```powershell
# 不要なフォルダを削除
Remove-Item -Path ".\個々の履歴\古いフォルダ" -Recurse
```

---

## 8. 非機能要件

### 8.1 パフォーマンス要件

| 項目 | 要件 |
|-----|------|
| **起動時間** | 5秒以内 |
| **ノード配置応答時間** | 0.5秒以内 |
| **コード生成時間** | 100ノードで10秒以内 |
| **レイヤー切り替え時間** | 1秒以内（アニメーション含む） |

### 8.2 スケーラビリティ

| 項目 | 制限 |
|-----|------|
| **最大ノード数/ワークフロー** | 1000ノード（推奨500以下） |
| **最大レイヤー数** | 7階層 |
| **最大ワークフロー数** | 制限なし（ファイルシステム依存） |

### 8.3 可用性

| 項目 | 仕様 |
|-----|------|
| **自動保存** | ノード配置時に即時保存 |
| **データ復元** | memory.jsonから完全復元可能 |
| **最小化防止** | フォームイベントで自動復帰 |

### 8.4 セキュリティ

| 項目 | 仕様 |
|-----|------|
| **データ保存先** | ローカルフォルダのみ（ネットワーク共有非推奨） |
| **実行ポリシー** | RemoteSigned以上を推奨 |
| **コード実行** | ユーザーが明示的に「実行」ボタンをクリック |

### 8.5 保守性

| 項目 | 仕様 |
|-----|------|
| **コードの可読性** | 日本語関数名・コメント充実 |
| **モジュール分割** | 機能別にファイル分割（15ファイル） |
| **JSON形式** | 人間が読める形式で保存 |
| **デバッグ出力** | Write-Hostでコンソール出力 |

---

## 付録A: 既知の問題と未実装機能

### A.1 修正済み（2025年10月29日）

1. **未初期化変数 `$hasProcessedPink`** - 修正済み
2. **デバッグコードの残存** - 修正済み
3. **重複グローバル変数定義** - 修正済み
4. **ハードコードされたパス** - 修正済み
5. **空ファイルのドキュメント化** - 修正済み

### A.2 未実装機能

- ノードの右クリックメニュー（コピー/貼り付け/削除）
- ピンク選択の再利用機能（別ワークフローでの呼び出し）
- スクリプト詳細の高度な編集機能

---

## 付録B: 開発履歴

### B.1 バージョン履歴

| バージョン | 日付 | 変更内容 |
|----------|------|---------|
| **1.0** | 2025-10-29 | 初回リリース、ポータビリティ向上、既知の問題修正 |

### B.2 統計情報

- **総ファイル数**: 37ファイル
- **総行数**: 8,091行
- **主要言語**: PowerShell
- **理解度**: 96%（2025年10月29日時点）

---

## 付録C: 参考ドキュメント

- **README.md**: プロジェクト概要とクイックスタート
- **ARCHITECTURE.md**: システム全体のアーキテクチャ詳細
- **REFACTORING_PLAN.md**: 7フェーズのリファクタリング計画

---

## 付録D: 用語集

| 用語 | 説明 |
|-----|------|
| **ノード** | ワークフロー上に配置される処理単位（ボタン） |
| **レイヤー** | ノードを配置するパネル（7階層） |
| **GroupID** | 条件分岐・ループの開始～終了をグループ化する識別子 |
| **ネスト規制** | ループと条件分岐の相互ネストを禁止するルール |
| **ピンク選択** | 複数ノードをまとめてスクリプト化する機能 |
| **memory.json** | ノード配置情報を保存するJSONファイル |
| **コード.json** | 各ノードのコードスニペットを保存するJSONファイル |
| **variables.json** | 実行時変数を保存するJSONファイル |
| **ボタン設定.json** | ノード定義とマッピングを保存するJSONファイル |
| **ワークフロー** | ノード配置とコードの組み合わせ（プロジェクト） |

---

**ドキュメント終了**
