# コード.json保存問題のデバッグ手順

## 問題の概要
「順次」ボタンをクリックしてもコード.jsonが更新されない問題を調査するため、詳細なログを追加しました。

## 実施した修正 (v1.0.164)

### 1. 詳細ログの追加
以下の箇所に詳細なログを追加しました：
- `setCodeEntry()` - コードエントリの保存処理
- `saveCodeJson()` - JSONファイルへの保存処理
- 起動時のバージョン表示

### 2. キャッシュバスティング
- `index-legacy.html` のバージョンを v1.0.164 に更新
- `app-legacy.js` のクエリパラメータを `?v=1.0.164` に更新

## テスト手順

### ステップ1: API サーバーの再起動

**重要**: 変更を反映させるため、必ずAPIサーバーを再起動してください。

1. 現在実行中のPowerShellウィンドウで `Ctrl+C` を押してサーバーを停止
2. 以下のコマンドで再起動：
   ```powershell
   .\quick-start.ps1 -NoBrowser
   ```
   または
   ```powershell
   .\adapter\api-server-v2.ps1 -Port 8080 -AutoOpenBrowser
   ```

### ステップ2: ブラウザのキャッシュクリア

**重要**: 古いJavaScriptが読み込まれている可能性があります。

#### Chrome / Edge の場合：
1. `Ctrl+Shift+Delete` を押す
2. 「キャッシュされた画像とファイル」のみを選択
3. 「データを削除」をクリック

または

**スーパーリロード（推奨）:**
1. `Ctrl+F5` を押す
   または
2. `Ctrl+Shift+R` を押す

### ステップ3: ブラウザコンソールを開く

1. ブラウザで `F12` キーを押す
2. 「Console」タブをクリック
3. 「Preserve log」にチェックを入れる（ログを保持するため）

### ステップ4: ページをリロード

1. ブラウザで `Ctrl+F5` を押してハードリロード
2. コンソールに以下のログが表示されることを確認：
   ```
   ═══════════════════════════════════════════════
   UIpowershell Legacy UI v1.0.164 - 起動開始
   ═══════════════════════════════════════════════
   ```

**このバージョン表示が出ない場合は、キャッシュが残っています！**
→ 再度 `Ctrl+Shift+Delete` でキャッシュを完全削除してください

### ステップ5: 「順次」ボタンをクリック

左側のツールバーから「順次」ボタンをクリックしてください。

### ステップ6: コンソールログを確認

以下のログが順番に表示されるはずです：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ボタンクリック] ✅ ボタンがクリックされました
[ボタンクリック] テキスト: 順次
[ボタンクリック] 処理番号: 1-1
[ボタンクリック] 関数名: 1_1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌────────────────────────────────────────
│ [addNodeToLayer] 開始
├────────────────────────────────────────
│ 処理番号: 1-1
│ テキスト: 順次
│ 関数名: 1_1
└────────────────────────────────────────
[addNodeToLayer] 通常ノード追加を開始
[addNodeToLayer] ノードを作成しました - ID: XX name: 1
[addNodeToLayer] generateCode() を呼び出します
[コード生成] 開始 - 処理番号: 1-1, ボタン名: 1
[コード生成] buttonSettings数: XX
[コード生成] 関数名: 1_1
[コード生成] 関数を実行します: 1_1
[コード生成] 生成されたコード: Write-Host "OK"
[コード生成] コード.jsonに保存します - ID: 1
┌─ [setCodeEntry] 開始 ────────────────
│ ID: 1
│ content長: 17
│ 分割数: 1
│   [1-1] Write-Host "OK"
│ 最後のIDを更新: 1
│ メモリ上のcodeDataに保存完了
│ 現在のエントリ数: 1
│
│ saveCodeJson()を呼び出します...
└──────────────────────────────────────
┌─ [コード.json保存] 開始 ─────────────
│ currentFolder: TA
│ エントリ数: 1
│ → API呼び出し: POST /folders/TA/code
│ → URL: http://localhost:8080/api/folders/TA/code
│ → codeData: {"エントリ":{"1-1":"Write-Host \"OK\""},"最後のID":1}
│ ← レスポンス受信
│ ← ステータス: 200 OK
│ ← Content-Type: application/json; charset=utf-8
│ ← JSONパース完了: {success: true, message: "コード.jsonを保存しました"}
│ ✅ 成功: コード.jsonを保存しました
│ 保存先: 03_history/TA/コード.json
└──────────────────────────────────────
[コード生成] 成功: ID 1 に保存しました
[addNodeToLayer] ✅ コード生成成功
```

## 問題の診断

### ケース1: バージョン表示が v1.0.164 でない
**原因**: ブラウザキャッシュ
**対処**:
- `Ctrl+Shift+Delete` で完全にキャッシュを削除
- プライベートモード/シークレットモードで開く

### ケース2: ボタンクリックのログが表示されない
**原因**: JavaScriptエラー、またはbutton-settings.jsonが読み込めていない
**対処**:
- コンソールに赤いエラーメッセージがないか確認
- `[ボタン設定] ✅ ロード完了` のログがあるか確認

### ケース3: [コード生成] が null を返す
**原因**: 関数名のマッピングに問題がある
**対処**:
- `[コード生成] 関数名: ???` のログで関数名を確認
- `[コード生成] 警告: 関数 ??? は未実装です` のログがあるか確認

### ケース4: currentFolder が null
**原因**: メイン.jsonの読み込みに失敗している
**対処**:
- `[フォルダ初期化]` のログでcurrentFolderの値を確認
- メイン.jsonが存在するか確認：`03_history\メイン.json`

### ケース5: API呼び出しでエラー
**原因**: APIサーバーが起動していない、またはポートが異なる
**対処**:
- `│ ← ステータス: ???` で200以外が返っているか確認
- APIサーバーのPowerShellウィンドウでエラーログを確認

### ケース6: 成功ログが出るが、ファイルが更新されない
**原因**: APIサーバー側の書き込み権限の問題
**対処**:
1. 手動でファイルのタイムスタンプを確認：
   ```powershell
   Get-ChildItem "03_history\TA\コード.json" | Select-Object Name, LastWriteTime
   ```
2. PowerShellを管理者権限で実行してみる

## レポート用テンプレート

以下の情報を収集してください：

```
1. バージョン表示:
   [コンソールの最初の行をコピー]

2. currentFolder:
   [フォルダ初期化のログからcurrentFolderの値をコピー]

3. ボタンクリック時のログ:
   [「順次」ボタンクリック後のすべてのログをコピー]

4. エラーメッセージ:
   [赤いエラーがあればコピー]

5. ファイルタイムスタンプ:
   PS> Get-ChildItem "03_history\TA\コード.json" | Select-Object Name, LastWriteTime
   [結果をコピー]

6. APIサーバーのログ:
   [PowerShellウィンドウに表示されているログをコピー]
```

## 期待される動作

正常に動作している場合：
1. ✅ バージョン v1.0.164 が表示される
2. ✅ ボタンクリックが検知される
3. ✅ コードが生成される (`Write-Host "OK"`)
4. ✅ setCodeEntry が成功する
5. ✅ saveCodeJson が成功する (200 OK)
6. ✅ ファイルタイムスタンプが更新される
7. ✅ キャンバスに新しいノードが表示される

---

## コンソールログフィルター仕様

### 概要

`app-legacy.js` では、ブラウザコンソールへの出力を制御するログフィルター機能が実装されています（76-117行目）。この機能により、重要なログのみをブラウザコンソールに表示し、それ以外はサーバーへの送信のみ行います。

### ログ表示ルール

#### 1. 基本ルール（console.log）

**「❌」「✅」「⚠」が含まれていないログは全てブラウザコンソールに表示されません。**

```javascript
// 重要なログのみを通過させる
const importantPrefixes = [
    '❌', '✅', '⚠'  // エラー・成功・警告マーカーのみ
];
```

#### 2. LOG_CONFIG による例外

`LOG_CONFIG.pink = true` の場合、以下のプレフィックスを持つログは絵文字なしでも表示されます：

- `[ホバープレビュー]`
- `[ピンク展開]`
- `[ピンク展開ポップアップ]`
- `[ピンク検出]`
- `[ピンクノード`

```javascript
// LOG_CONFIGの設定 (25-29行目)
const LOG_CONFIG = {
    breadcrumb: false,       // パンくずリストのログ
    pink: true,              // ピンクノード処理のログ（デバッグ用に有効化）
    initialization: false    // 初期化処理のログ
};
```

#### 3. console.error/warn/info/debug

`console.log` 以外のメソッドはフィルター対象外で、すべて表示されます。

### ログ表示例

#### 表示される例

```javascript
console.log('✅ 成功しました');           // ✅ あり → 表示
console.log('❌ エラーが発生しました');   // ❌ あり → 表示
console.log('⚠ 警告: データがありません'); // ⚠ あり → 表示
console.error('エラー詳細');             // error → 表示
console.warn('警告メッセージ');          // warn → 表示

// LOG_CONFIG.pink = true の場合
console.log('[ホバープレビュー] タイマー設定完了'); // 表示
console.log('[ピンク展開] 処理開始');              // 表示
```

#### 表示されない例

```javascript
console.log('処理を開始します');          // 絵文字なし → 非表示
console.log('[デバッグ] データ確認');     // 絵文字なし → 非表示
console.log('ノードを追加しました');      // 絵文字なし → 非表示

// LOG_CONFIG.pink = false の場合
console.log('[ホバープレビュー] タイマー設定完了'); // 非表示
```

### デバッグ時の注意事項

#### デバッグログを表示させる方法

**方法1**: 絵文字プレフィックスを使用
```javascript
console.log('✅ デバッグ: 変数の値 = ' + value);
```

**方法2**: LOG_CONFIGを有効化（ピンク関連のみ）
```javascript
// app-legacy.js の 25-29行目を編集
const LOG_CONFIG = {
    pink: true,  // ピンク関連ログを表示
};
```

**方法3**: console.error/warn を使用
```javascript
console.error('デバッグ: 重要な情報');  // 常に表示
```

**方法4**: フィルターを一時的に無効化
```javascript
// app-legacy.js の 107-115行目をコメントアウト
// if (!importantPrefixes.some(prefix => message.includes(prefix))) {
//     ...
//     return; // この return をコメントアウト
// }
```

### ログバッファ

表示されないログも `consoleLogBuffer` に保存され、サーバーに送信されます。
- バッファサイズ: 最大1000件
- 送信タイミング: 100件ごと、またはページ離脱時

### 実装箇所

- ログフィルター: `ui/app-legacy.js` 76-117行目
- LOG_CONFIG定義: `ui/app-legacy.js` 25-29行目
- ピンク関連ログ例外: `ui/app-legacy.js` 84-99行目
