# UIpowershell システム仕様書

**作成日**: 2025年11月1日
**バージョン**: 1.0

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**UIpowershell** - ビジュアルRPAプラットフォーム

### 1.2 目的
プログラミング知識がなくてもRPA処理を視覚的に構築できるツール。ノードをドラッグ&ドロップで配置し、フローチャートのように処理を組み立てることで、自動的にPowerShellスクリプトを生成する。

### 1.3 主な用途
- Excel/CSVデータの読み込み → Webシステムへの転記（メインユースケース）
- アプリケーションの自動操作
- 画像マッチングによるUI操作
- キーボード/マウス操作の自動化

### 1.4 技術スタック
- **言語**: PowerShell 5.1+
- **UI**: Windows Forms (.NET Framework)
- **データ永続化**: JSON

---

## 2. システムアーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────┐
│                  メインフォーム                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ レイヤー1   │  │ レイヤー2   │  │ レイヤー3-6 │ │
│  │ (メイン)    │  │ (サブ)      │  │ (深階層)    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
          ↓                    ↓                    ↓
    ノード配置情報         コード設定           変数管理
          ↓                    ↓                    ↓
   memory.json            コード.json         variables.json
          ↓                    ↓                    ↓
          └──────────→ コード生成エンジン ←─────────┘
                           ↓
                      output.ps1
```

### 2.2 レイヤーシステム

UIは7階層のレイヤーで構成され、ドリルダウン方式で深い階層を表現：

| レイヤー | X座標 | 状態 | 用途 |
|---------|-------|------|------|
| レイヤー0 | 160 | 非表示 | 予備 |
| レイヤー1 | 550 | 常時表示 | メイン作業領域 |
| レイヤー2 | 940 | 表示 | サブ領域 |
| レイヤー3-6 | 1330 | 非表示 | 深い階層用 |

---

## 3. 主要機能

### 3.1 ノードシステム

#### 3.1.1 ノードタイプ

| ノード色 | 用途 | 説明 |
|---------|------|------|
| White | 順次処理 | 通常の処理ステップ |
| SpringGreen | 条件分岐 | if-else構造 |
| LemonChiffon | ループ | 繰り返し処理 |
| Salmon | 順次/特殊 | 制御構造内の処理 |
| Pink | スクリプト化 | サブルーチン化されたノード群 |

#### 3.1.2 ノード操作

- **追加**: 左側パレットからドラッグ&ドロップ
- **移動**: ノードをドラッグして移動（GroupID整合性を自動維持）
- **設定**: ノードをクリックして設定画面を開く
- **削除**: 未実装（将来的に右クリックメニューで実装予定）

### 3.2 GroupID管理

条件分岐/ループの開始・中間・終了をグループ化：

```
例: 条件分岐
├─ 196-1  (開始: if)
├─ 196-2  (中間: else)
└─ 196-3  (終了: })

例: ループ
├─ 215-1  (開始: for/while)
└─ 215-2  (終了: })
```

### 3.3 ネスト規制

ループ/条件分岐内に中途半端にノードを配置できないように制御し、レイアウト崩れを防止。

### 3.4 ピンク選択（スクリプト化）

1. SHIFT+クリックで複数ノードを選択
2. レイヤーボタンをクリック
3. 選択したノードがピンク色に変化
4. 右レイヤーに詳細が表示される
5. "ログイン処理"などの繰り返し使う処理をサブルーチン化

### 3.5 変数管理

- Excel/CSVから読み込んだデータを変数として保存
- 実行時に変数を参照してデータを転記
- `variables.json` に永続化

### 3.6 自動コード生成

ノード配置を解析してPowerShellスクリプトを自動生成し、`output.ps1`としてエクスポート。

---

## 4. データ構造

### 4.1 memory.json（ノード配置情報）

各レイヤーのノード配置を記録。UIの状態を完全に復元可能。

```json
{
  "1": {
    "構成": [
      {
        "ボタン名": "215-1",
        "X座標": 89,
        "Y座標": 20,
        "順番": 1,
        "ボタン色": "LemonChiffon",
        "テキスト": "ループ 開始",
        "処理番号": "1-3",
        "高さ": 30,
        "幅": 120,
        "script": "未設定"
      }
    ]
  }
}
```

### 4.2 コード.json（生成コードスニペット）

各ノードIDに対応するPowerShellコードを保存。

```json
{
  "エントリ": {
    "100-1": "Write-Host \"OK\"",
    "61-1": "if () {",
    "61-2": "} else {",
    "61-3": "}"
  },
  "最後のID": 215
}
```

**ID命名規則:**
- `{数字}-{分岐}`: 基本ノード（例: 100-1）
- `{GroupID}-{分岐番号}`: 制御構造（例: 61-1=if開始, 61-2=else, 61-3=終了）
- `{GroupID}-{親分岐}-{子番号}`: 入れ子構造（例: 54-1-1）

### 4.3 variables.json（実行時変数）

Excel/CSVから読み込んだデータを保存。

```json
{
  "Excel2次元配列": [
    ["A", "B", "C"],
    [1, "ww", "あいう"],
    [2, "ee", "ｓｄｆｔｇ"]
  ],
  "GINPパス": "C:\\Users\\hallo\\AppData\\Local\\Programs\\GIMP 2\\bin\\gimp-2.10.exe"
}
```

### 4.4 ボタン設定.json（ノード定義）

各ノードの処理番号と関数名のマッピング。

```json
[
  {
    "処理番号": "1-1",
    "関数名": "順次処理関数",
    "背景色": "White",
    "説明": "通常の順次処理"
  },
  {
    "処理番号": "1-2",
    "関数名": "条件分岐関数",
    "背景色": "SpringGreen",
    "説明": "if-else条件分岐"
  }
]
```

---

## 5. コード生成フロー

```
[1] ユーザーがノードを配置
     ↓
[2] memory.json に配置情報を保存
     ↓
[3] ノード設定を入力
     ↓
[4] コード.json にコードスニペットを保存
     ↓
[5] 「実行」ボタンをクリック
     ↓
[6] 実行イベント関数が起動
     ├─ レイヤー1からボタンをY座標順に取得
     ├─ 各ボタンIDで「IDでエントリを取得」を呼び出し
     ├─ 特殊処理: Redボタン→Blueボタンの間にelse分岐挿入
     └─ $outputに全コードを蓄積
     ↓
[7] output.ps1 に書き込み（UTF-8エンコーディング）
     ↓
[8] PowerShell ISE で自動的に開く
```

---

## 6. ファイル構成

### 6.1 主要ファイル

| ファイル名 | 用途 |
|-----------|------|
| `01_メインフォーム_メイン.ps1` | メインエントリポイント |
| `02_メインフォームUI_foam関数.ps1` | UI関数・ネスト規制 |
| `05_メインフォームUI_矢印処理.ps1` | ノード間の矢印描画 |
| `06_メインフォームUI_フレーム移動.ps1` | レイヤー切り替え |
| `08_メインF機能_メインボタン処理.ps1` | 実行・変数・フォルダボタン |
| `09_変数機能_コードID管理JSON.ps1` | JSON操作関数 |
| `12_コードメイン_コード本文.ps1` | コード生成メイン |
| `15_コードサブ_if文条件式作成.ps1` | 条件式生成 |
| `実行.bat` | 起動用バッチファイル |
| `ボタン設定.json` | ノード定義・関数マッピング |

### 6.2 ディレクトリ構造

```
UIpowershell/
├── 01_メインフォーム_メイン.ps1          # メインエントリポイント
├── 02_～15_.ps1                          # 機能別スクリプト群
├── 実行.bat                              # 起動用バッチファイル
├── ボタン設定.json                       # ノード定義
├── 個々の履歴/                           # ワークフロー保存先
│   ├── メイン.json                       # 現在のフォルダパス
│   ├── {ワークフロー名}/
│   │   ├── コード.json                   # 生成コードスニペット
│   │   ├── memory.json                   # ノード配置情報
│   │   ├── variables.json                # 実行時変数
│   │   └── output.ps1                    # 生成されたスクリプト
├── コード/                               # コード生成用スクリプト群
└── 02_ツール/                            # ユーティリティ
    └── 01_JSON調整.ps1                   # JSON編集ツール
```

---

## 7. 主要なグローバル変数

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:レイヤー0～6` | Panel[] | 7つのレイヤーパネル |
| `$global:可視左パネル` | Panel | 現在表示中の左パネル |
| `$global:可視右パネル` | Panel | 現在表示中の右パネル |
| `$global:Pink選択配列` | Array | ピンク選択されたノード配列 |
| `$global:Pink選択中` | Boolean | ピンク選択モードのフラグ |
| `$global:folderPath` | String | 現在のワークフローフォルダパス |
| `$global:メインフォーム` | Form | メインウィンドウ |
| `$global:黄色ボタングループカウンタ` | Int | ループノードのGroupID（1000番台） |
| `$global:緑色ボタングループカウンタ` | Int | 条件分岐ノードのGroupID（2000番台） |

---

## 8. 主要関数

| 関数名 | ファイル | 用途 |
|--------|----------|------|
| `実行イベント` | 08_メインF機能_メインボタン処理.ps1 | メイン実行処理 |
| `00_矢印追記処理` | 05_メインフォームUI_矢印処理.ps1 | 矢印描画 |
| `00_文字列処理内容` | 12_コードメイン_コード本文.ps1 | コードスニペット生成 |
| `Get-GroupRangeAfterMove` | 02_メインフォームUI_foam関数.ps1 | GroupID範囲計算 |
| `IDでエントリを取得` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonから取得 |

---

## 9. 動作環境

### 9.1 システム要件

- **OS**: Windows 10/11
- **PowerShell**: 5.1以上
- **.NET Framework**: 4.5以上

### 9.2 セットアップ手順

1. リポジトリをクローン
2. 実行ポリシーを設定
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```
3. `実行.bat` を起動、または `.\01_メインフォーム_メイン.ps1` を実行

---

## 10. 既知の問題と制限事項

### 10.1 未実装機能

- ノードの右クリックメニュー（コピー/貼り付け/削除）
- ピンク選択の再利用機能（別ワークフローでの呼び出し）
- スクリプト詳細の高度な編集機能
- Undo/Redo機能
- ノード検索とジャンプ機能

### 10.2 修正済みの問題（2025年10月29日）

- 未初期化変数 `$hasProcessedPink`
- デバッグコードの残存
- 重複グローバル変数定義
- ハードコードされたパス
- 空ファイルのドキュメント化

---

## 11. 開発ガイドライン

### 11.1 コーディング規約

- **エンコーディング**: UTF-8 BOM
- **関数命名**: 日本語（例: `実行イベント`, `ノードを追加`）
- **変数命名**: 日本語グローバル変数、英語ローカル変数も混在
- **インデント**: 4スペース

### 11.2 ファイル命名規則

- `01_～`: メインエントリポイント・初期化
- `02_～`: UI関連関数
- `05_～`: UI描画・レンダリング
- `06_～`: レイヤー操作
- `07_～`: ノード追加ロジック
- `08_～`: イベントハンドラー
- `09_～`: データ永続化
- `10_～11_`: データ変換（ノード⇔JSON）
- `12_～15_`: コード生成

---

## 12. プロジェクト統計

- **総ファイル数**: 37ファイル
- **総行数**: 8,091行
- **主要言語**: PowerShell
- **理解度**: 96% (2025年10月29日時点)

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| ノード | ワークフロー上の処理単位（ボタンとして表示） |
| レイヤー | ノードを配置する階層（7階層） |
| GroupID | 条件分岐/ループの開始・中間・終了を紐づけるID |
| ピンク選択 | 複数ノードをサブルーチン化する機能 |
| ネスト規制 | 制御構造内に中途半端にノードを配置できない制約 |

---

## 付録B: 参考ドキュメント

- **README.md**: 詳細な使い方とアーキテクチャ
- **ARCHITECTURE.md**: システム全体のアーキテクチャ詳細
- **REFACTORING_PLAN.md**: 7フェーズのリファクタリング計画
- **issue_list.txt**: 今後の開発予定機能

---

**変更履歴**

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-11-01 | 1.0 | 初版作成 |

