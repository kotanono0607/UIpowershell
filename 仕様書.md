# UIpowershell システム仕様書

**作成日**: 2025年11月1日
**バージョン**: 1.0

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**UIpowershell** - ビジュアルRPAプラットフォーム

### 1.2 目的
プログラミング知識がなくてもRPA処理を視覚的に構築できるツール。ノードをドラッグ&ドロップで配置し、フローチャートのように処理を組み立てることで、自動的にPowerShellスクリプトを生成する。

### 1.3 主な用途
- Excel/CSVデータの読み込み → Webシステムへの転記（メインユースケース）
- アプリケーションの自動操作
- 画像マッチングによるUI操作
- キーボード/マウス操作の自動化

### 1.4 技術スタック
- **言語**: PowerShell 5.1+
- **UI**: Windows Forms (.NET Framework)
- **データ永続化**: JSON

---

## 2. システムアーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────┐
│                  メインフォーム                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ レイヤー1   │  │ レイヤー2   │  │ レイヤー3-6 │ │
│  │ (メイン)    │  │ (サブ)      │  │ (深階層)    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
          ↓                    ↓                    ↓
    ノード配置情報         コード設定           変数管理
          ↓                    ↓                    ↓
   memory.json            コード.json         variables.json
          ↓                    ↓                    ↓
          └──────────→ コード生成エンジン ←─────────┘
                           ↓
                      output.ps1
```

### 2.2 レイヤーシステム

UIは7階層のレイヤーで構成され、ドリルダウン方式で深い階層を表現：

| レイヤー | X座標 | 状態 | 用途 |
|---------|-------|------|------|
| レイヤー0 | 160 | 非表示 | 予備 |
| レイヤー1 | 550 | 常時表示 | メイン作業領域 |
| レイヤー2 | 940 | 表示 | サブ領域 |
| レイヤー3-6 | 1330 | 非表示 | 深い階層用 |

---

## 3. 主要機能

### 3.1 ノードシステム

#### 3.1.1 ノードタイプ

| ノード色 | 用途 | 説明 |
|---------|------|------|
| White | 順次処理 | 通常の処理ステップ |
| SpringGreen | 条件分岐 | if-else構造 |
| LemonChiffon | ループ | 繰り返し処理 |
| Salmon | 順次/特殊 | 制御構造内の処理 |
| Pink | スクリプト化 | サブルーチン化されたノード群 |

#### 3.1.2 ノード操作

- **追加**: 左側パレットからドラッグ&ドロップ
- **移動**: ノードをドラッグして移動（GroupID整合性を自動維持）
- **設定**: ノードをクリックして設定画面を開く
- **削除**: 未実装（将来的に右クリックメニューで実装予定）

#### 3.1.3 ノード処理関数一覧

| 処理番号 | 関数名 | ファイル | 説明 |
|---------|-------|---------|------|
| 1-1 | `1_1` | 01_code/1-1.ps1 | 順次処理 |
| 1-2 | `ShowConditionBuilder` | 01_code/1-2.ps1 | 条件分岐（if-else構造） |
| 1-3 | `ShowLoopBuilder` | 01_code/1-3.ps1 | ループ（for/while） |
| 1-4 | `1_4` | 01_code/1-4.ps1 | 読み込みテスト |
| 1-6 | `1_6` | 01_code/1-6.ps1 | メッセージボックス表示 |
| 1-7 | `1_7` | 01_code/1-7.ps1 | 変数取得 |
| 1-8 | `1_8` | 01_code/1-8.ps1 | 指定時間待機 |
| 2-1 | `2_1` | 01_code/2-1.ps1 | マウス座標取得 |
| 2-2 | `2_2` | 01_code/2-2.ps1 | マウス移動 |
| 3-1 | `3_1` | 01_code/3-1.ps1 | キー操作 |
| 3-2 | `3_2` | 01_code/3-2.ps1 | キー入力 |
| 4-1 | `4_1` | 01_code/4-1.ps1 | UI要素操作 |
| 4-2 | `4_2` | 01_code/4-2.ps1 | UI要素操作（拡張） |
| 5-1 | `5_1` | 01_code/5-1.ps1 | アプリケーション実行 |
| 8-1 | `8_1` | 01_code/8-1.ps1 | Excel操作 |
| 9-1 | `9_1` | 01_code/9-1.ps1 | ウインドウ存在確認 |
| 10-1 | `10_1` | 01_code/10-1.ps1 | 画像マッチング確認 |
| 99-1 | `99_1` | 01_code/99-1.ps1 | カスタム処理 |

### 3.2 GroupID管理

条件分岐/ループの開始・中間・終了をグループ化：

```
例: 条件分岐
├─ 196-1  (開始: if)
├─ 196-2  (中間: else)
└─ 196-3  (終了: })

例: ループ
├─ 215-1  (開始: for/while)
└─ 215-2  (終了: })
```

### 3.3 ネスト規制

ループ/条件分岐内に中途半端にノードを配置できないように制御し、レイアウト崩れを防止。

#### 3.3.1 ネスト規制の3階層チェックロジック

実装関数: `ドロップ禁止チェック_ネスト規制()` (02_メインフォームUI_foam関数.ps1:210-508)

| チェック項目 | 対象 | ルール | 実装位置 |
|------------|------|--------|---------|
| **単体ノード侵入禁止** | 黄（ループ） | ループノードが緑（条件分岐）内に入るな | 行424-430 |
| **グループ全体侵入禁止** | 緑（条件分岐） | 条件分岐ノードがループ内に入るな | 行432-439 |
| **グループ分断禁止** | 両色 | 同じGroupIDのノードが境界をまたぐな | 行442-469 |

#### 3.3.2 ネスト規制の検証手順

1. **移動ボタンの情報を取得**
   - ボタン名、色、GroupID、Y座標を確認

2. **移動先の範囲を計算**
   - `Get-GroupRangeAfterMove()` で移動後のグループ範囲を算出

3. **既存のグループ範囲を取得**
   - `Get-AllGroupRanges()` でパネル内の全グループ範囲を取得

4. **違反パターンを検証**
   - `Is-IllegalPair()` で条件分岐とループの相互ネストを検出
   - `Check-GroupFragmentation()` でグループ分断を検出

5. **禁止パターンの場合**
   - 警告ダイアログを表示し、ドラッグ状態をリセット
   - 移動をキャンセル

#### 3.3.3 スクリプト展開中チェック機能（レイヤー2以上専用）

実装位置: 02_メインフォームUI_foam関数.ps1:104-138

**目的**: レイヤー2以上にノードをドロップする際、親レイヤーでスクリプトが正しく展開されているかを検証

**検証ロジック**:
```powershell
$親レイヤー番号 = $レイヤー番号 - 1
if ($Global:Pink選択配列[$親レイヤー番号].値 -ne 1) {
    # 未展開エラー: 警告ダイアログを表示
    [System.Windows.Forms.MessageBox]::Show(
        "親レイヤーでスクリプトが展開されていません。\n" +
        "1. レイヤー$親レイヤー番号に戻る\n" +
        "2. ピンクノードをSHIFT+クリックで選択\n" +
        "3. レイヤー化ボタンをクリック",
        "エラー",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Warning
    )
    return $true  # ドロップ禁止
}
```

**効果**: 階層構造の整合性を保証し、誤った階層構造の構築を防止

### 3.4 ピンク選択（スクリプト化）

1. SHIFT+クリックで複数ノードを選択
2. レイヤーボタンをクリック
3. 選択したノードがピンク色に変化
4. 右レイヤーに詳細が表示される
5. "ログイン処理"などの繰り返し使う処理をサブルーチン化

### 3.5 変数管理

- Excel/CSVから読み込んだデータを変数として保存
- 実行時に変数を参照してデータを転記
- `variables.json` に永続化

### 3.6 自動コード生成

ノード配置を解析してPowerShellスクリプトを自動生成し、`output.ps1`としてエクスポート。

### 3.7 スナップショット機能（試行錯誤支援）

実装ファイル: 16_スナップショット機能.ps1 (全293行)

#### 3.7.1 概要

現在のワークフロー状態を一時保存し、いつでも復元できる機能。試行錯誤時の安全網として機能し、将来的にUndo/Redo機能に拡張予定。

#### 3.7.2 主要関数

| 関数名 | 機能 | 説明 |
|-------|------|------|
| `スナップショット作成()` | 状態保存 | memory.jsonとコード.jsonをバックアップ |
| `スナップショット復元()` | 状態復元 | 保存された状態を復元しUIをリロード |
| `UIをリロード()` | UI再構築 | memory.jsonから全ノードを再読み込み |

#### 3.7.3 保存ファイル

| ファイル名 | 元ファイル | 説明 |
|-----------|----------|------|
| `memory_snapshot.json` | memory.json | ノード配置情報のバックアップ |
| `コード_snapshot.json` | コード.json | コードスニペットのバックアップ |
| `snapshot_info.json` | - | 作成日時メタデータ |

#### 3.7.4 使用フロー

```
[1] 現在の状態を保存
     ↓ スナップショット作成()
[2] memory.json → memory_snapshot.json
    コード.json → コード_snapshot.json
     ↓
[3] 試行錯誤（ノードの追加・削除・移動）
     ↓
[4] 元に戻したい場合
     ↓ スナップショット復元()
[5] 確認ダイアログ表示
     ↓ ユーザーが「はい」
[6] スナップショットファイル → 元ファイルへコピー
     ↓ UIをリロード()
[7] レイヤーのボタンをすべて削除
     ↓ memory.jsonから再読み込み
[8] ドラッグ&ドロップイベントを再設定
     ↓ 矢印を再描画
[9] 復元完了
```

#### 3.7.5 特徴

- **オートセーブとの共存**: 通常のオートセーブは継続動作
- **手動管理**: ユーザーが明示的にスナップショットを作成・復元
- **UI同期**: 復元後は完全にUIを再構築し、状態の整合性を保証
- **将来の拡張性**: 複数スナップショット管理やUndo/Redoスタックへの拡張を想定

### 3.8 階層パス表示機能（デバッグ支援）

実装位置: 01_メインフォーム_メイン.ps1:188-199, 02_メインフォームUI_foam関数.ps1:2560-2603

#### 3.8.1 概要

ウィンドウ下部に現在のレイヤー階層パスを表示し、ユーザーがどの階層で作業しているかを可視化する機能。

#### 3.8.2 表示形式

```
📍 階層パス: レイヤー0 → 82-1(スクリプト) → レイヤー1 → 95-1(スクリプト) → レイヤー2
```

- **レイヤー番号**: 現在いるレイヤーの番号
- **スクリプト名**: 展開しているピンクノードのボタン名
- **矢印（→）**: 階層の遷移を示す

#### 3.8.3 実装関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `階層パスを取得する()` | 02_メインフォームUI_foam関数.ps1:2560 | Pink選択配列から階層パスを構築 |
| `階層パス表示を更新する()` | 02_メインフォームUI_foam関数.ps1:2603 | ラベルテキストを更新 |

#### 3.8.4 動作原理

1. **Pink選択配列の参照**
   - `$Global:Pink選択配列` から展開ボタン情報を取得
   - 各レイヤーの展開状態（値=1）を確認

2. **階層パスの構築**
   ```powershell
   $階層パス = "📍 階層パス: レイヤー0"
   for ($i = 1; $i -le $Global:レイヤー階層の深さ; $i++) {
       $展開ボタン = $Global:Pink選択配列[$i-1].展開ボタン
       if ($展開ボタン -ne 0) {
           $階層パス += " → $展開ボタン(スクリプト) → レイヤー$i"
       }
   }
   ```

3. **ラベル更新**
   - `$Global:階層パス表示ラベル.Text` に階層パスを設定

#### 3.8.5 グローバル変数

```powershell
$Global:階層パス表示ラベル  # ウィンドウ下部のラベルコントロール
```

#### 3.8.6 使用シーン

- デバッグ時に現在の位置を確認
- 深い階層で作業中の迷子防止
- 階層構造の理解支援

---

## 4. データ構造

### 4.1 memory.json（ノード配置情報）

各レイヤーのノード配置を記録。UIの状態を完全に復元可能。

```json
{
  "1": {
    "構成": [
      {
        "ボタン名": "215-1",
        "X座標": 89,
        "Y座標": 20,
        "順番": 1,
        "ボタン色": "LemonChiffon",
        "テキスト": "ループ 開始",
        "処理番号": "1-3",
        "高さ": 30,
        "幅": 120,
        "script": "未設定"
      }
    ]
  }
}
```

### 4.2 コード.json（生成コードスニペット）

各ノードIDに対応するPowerShellコードを保存。

```json
{
  "エントリ": {
    "100-1": "Write-Host \"OK\"",
    "61-1": "if () {",
    "61-2": "} else {",
    "61-3": "}"
  },
  "最後のID": 215
}
```

**ID命名規則:**
- `{数字}-{分岐}`: 基本ノード（例: 100-1）
- `{GroupID}-{分岐番号}`: 制御構造（例: 61-1=if開始, 61-2=else, 61-3=終了）
- `{GroupID}-{親分岐}-{子番号}`: 入れ子構造（例: 54-1-1）

### 4.3 variables.json（実行時変数）

Excel/CSVから読み込んだデータを保存。

```json
{
  "Excel2次元配列": [
    ["A", "B", "C"],
    [1, "ww", "あいう"],
    [2, "ee", "ｓｄｆｔｇ"]
  ],
  "GINPパス": "C:\\Users\\hallo\\AppData\\Local\\Programs\\GIMP 2\\bin\\gimp-2.10.exe"
}
```

### 4.4 ボタン設定.json（ノード定義）

各ノードの処理番号と関数名のマッピング。

```json
[
  {
    "処理番号": "1-1",
    "関数名": "順次処理関数",
    "背景色": "White",
    "説明": "通常の順次処理"
  },
  {
    "処理番号": "1-2",
    "関数名": "条件分岐関数",
    "背景色": "SpringGreen",
    "説明": "if-else条件分岐"
  }
]
```

---

## 5. データフローと処理フロー

### 5.1 全体データフロー図

```
┌─────────────────────────────────────────────────────────────┐
│                      起動時の初期化                          │
├─────────────────────────────────────────────────────────────┤
│ [1] メイン.json読み込み → folderPathを取得                  │
│ [2] variables.json, memory.json, コード.jsonを読み込み      │
│ [3] UI初期化（フォーム、レイヤー、ボタンパレット）          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    ユーザー操作フェーズ                      │
├─────────────────────────────────────────────────────────────┤
│ ドラッグ&ドロップ → ネスト規制チェック → memory.json更新    │
│ ノードクリック → 設定UI表示 → コード.json更新               │
│ ピンク選択 → スクリプト化 → Pink選択配列更新                │
│ スナップショット作成 → memory/コード_snapshot.json保存       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    コード生成フェーズ                        │
├─────────────────────────────────────────────────────────────┤
│ 「実行」ボタン → 実行イベント() → output.ps1生成            │
│                → PowerShell ISEで開く                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    復元フェーズ（オプション）                │
├─────────────────────────────────────────────────────────────┤
│ スナップショット復元 → UIをリロード() → 矢印再描画          │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 JSON読み込みフェーズ（詳細）

**Step 1: メイン.json読み込み** (01_メインフォーム_メイン.ps1:34-40)
```powershell
$global:folderPath = 取得-JSON値 -jsonFilePath "$スクリプトPath\個々の履歴\メイン.json" `
                                  -keyName "フォルダパス"
$global:JSONPath = "$global:folderPath\variables.json"
```

**Step 2: コード.json初期化** (09_変数機能_コードID管理JSON.ps1:2-71)
```powershell
function JSON初回 {
    # メイン.jsonからフォルダパスを取得
    # → コード.jsonが存在確認
    # → 存在しなければ初期化
}
```

**Step 3: memory.json読み込み** (01_メインフォーム_メイン.ps1:507-511)
```powershell
出力-ボタン情報 -jsonFilePath "$global:folderPath\memory.json"
# memory.jsonの構造:
# {
#   "1": { "構成": [ { "テキスト", "ボタン色", "処理番号", ... } ] },
#   "2": { "構成": [ ... ] },
#   ...
# }
```

### 5.3 UI表示フェーズ（詳細）

**Step 1: ボタン生成** (01_メインフォーム_メイン.ps1:410-434)
```powershell
foreach ($ボタン in $jsonData) {
    作成ボタンとイベント設定 -処理番号 $ボタン.処理番号 `
                         -コンテナ $コンテナ.Value ...
}
```

**Step 2: 整列と描画** (01_メインフォーム_メイン.ps1:509-511)
```powershell
00_ボタンの上詰め再配置関数 -フレーム $Global:可視左パネル
00_矢印追記処理 -フレームパネル $Global:可視左パネル
```

### 5.4 ユーザー操作フェーズ（詳細）

**ドラッグ操作の流れ**:
```
MouseDown(ボタン)
  ↓ IsDragging = true; DoDragDrop()
DragEnter(パネル)
  ↓ DragDropEffect = Move
DragDrop(パネル)
  ↓ [1] スクリプト展開中チェック（レイヤー2以上）
  ↓ [2] ネスト規制チェック
  ↓ [3] 衝突チェック
  ↓ [4] 位置決定
  ↓ [5] 矢印再描画
  ↓ [6] memory.json更新
```

**クリック操作の流れ**:
```
Click(ボタン)
  ↓ 00_文字列処理内容() 呼出
  ↓ ボタン設定.jsonから処理番号→関数名をマッピング
  ↓ 対応する関数実行（条件分岐ビルダー等）
  ↓ エントリを追加_指定ID() で結果をコード.jsonに保存
```

### 5.5 JSON保存フェーズ（詳細）

**エントリ追加関数群** (09_変数機能_コードID管理JSON.ps1)

| 関数 | 処理 | 対象ファイル |
|------|------|------------|
| `IDを生成する()` | 行252 | 最後のID自動インクリメント → コード.json |
| `エントリを追加_指定ID()` | 行252 | ID指定でエントリ追加 |
| `IDでエントリを取得()` | 行316 | ID検索でエントリ取得（読み込み） |
| `IDでエントリを置換()` | 行431 | ID指定でエントリ上書き |

**memory.json更新フロー**:
```powershell
# レイヤー化時
一覧-フレームパネルのボタン一覧 → "ボタン名;色;テキスト_" 形式で取得
→ AAAA_ プレフィックス付けてコード.jsonに保存
→ memory.jsonのボタン位置情報も自動更新
```

### 5.6 コード生成フェーズ（詳細）

**Step 1: 実行イベント** (08_メインF機能_メインボタン処理.ps1:3-131)
```powershell
function 実行イベント {
    # レイヤー1のボタンをY座標でソート
    foreach ($button in $buttons) {
        # ボタン名からエントリを取得
        $取得したエントリ = IDでエントリを取得 -ID $id

        # Pinkノード（展開済み）の場合は再帰展開
        if ($取得したエントリ -match "^AAAA") {
            $取得したエントリ = ノードリストを展開 -ノードリスト文字列 $取得したエントリ
        }

        $output += "$取得したエントリ`n`n"
    }
}
```

**Step 2: 出力** (08_メインF機能_メインボタン処理.ps1:95-114)
```powershell
$output | Set-Content -Path "$global:folderPath\output.ps1" -Force -Encoding UTF8
Start-Process powershell_ise.exe -ArgumentList "$outputFilePath"
```

### 5.7 コード生成フロー（概要）

```
[1] ユーザーがノードを配置
     ↓
[2] memory.json に配置情報を保存
     ↓
[3] ノード設定を入力
     ↓
[4] コード.json にコードスニペットを保存
     ↓
[5] 「実行」ボタンをクリック
     ↓
[6] 実行イベント関数が起動
     ├─ レイヤー1からボタンをY座標順に取得
     ├─ 各ボタンIDで「IDでエントリを取得」を呼び出し
     ├─ 特殊処理: Redボタン→Blueボタンの間にelse分岐挿入
     └─ $outputに全コードを蓄積
     ↓
[7] output.ps1 に書き込み（UTF-8エンコーディング）
     ↓
[8] PowerShell ISE で自動的に開く
```

---

## 6. ファイル構成

### 6.1 主要ファイル

| ファイル名 | 用途 |
|-----------|------|
| `01_メインフォーム_メイン.ps1` | メインエントリポイント |
| `02_メインフォームUI_foam関数.ps1` | UI関数・ネスト規制 |
| `05_メインフォームUI_矢印処理.ps1` | ノード間の矢印描画 |
| `06_メインフォームUI_フレーム移動.ps1` | レイヤー切り替え |
| `08_メインF機能_メインボタン処理.ps1` | 実行・変数・フォルダボタン |
| `09_変数機能_コードID管理JSON.ps1` | JSON操作関数 |
| `12_コードメイン_コード本文.ps1` | コード生成メイン |
| `15_コードサブ_if文条件式作成.ps1` | 条件式生成 |
| `実行.bat` | 起動用バッチファイル |
| `ボタン設定.json` | ノード定義・関数マッピング |

### 6.2 ディレクトリ構造

```
UIpowershell/
├── 01_メインフォーム_メイン.ps1          # メインエントリポイント
├── 02_～15_.ps1                          # 機能別スクリプト群
├── 実行.bat                              # 起動用バッチファイル
├── ボタン設定.json                       # ノード定義
├── 個々の履歴/                           # ワークフロー保存先
│   ├── メイン.json                       # 現在のフォルダパス
│   ├── {ワークフロー名}/
│   │   ├── コード.json                   # 生成コードスニペット
│   │   ├── memory.json                   # ノード配置情報
│   │   ├── variables.json                # 実行時変数
│   │   └── output.ps1                    # 生成されたスクリプト
├── コード/                               # コード生成用スクリプト群
└── 02_ツール/                            # ユーティリティ
    └── 01_JSON調整.ps1                   # JSON編集ツール
```

---

## 7. 主要なグローバル変数

### 7.1 UI表示関連

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:メインフォーム` | Form | メインウィンドウ（1400x1000） |
| `$Global:階層パス表示ラベル` | Label | 画面下部の階層パス表示ラベル |
| `$global:説明フレーム` | Panel | 説明文表示用フレーム |
| `$global:説明ラベル` | Label | 説明文ラベル |

### 7.2 レイヤー管理

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:レイヤー0～6` | Panel[] | 7つのレイヤーパネル（0-6） |
| `$global:可視左パネル` | Panel | 現在表示中の左パネル |
| `$global:可視右パネル` | Panel | 現在表示中の右パネル |
| `$Global:不可視左の左パネル` | Panel | 左にスクロール済みパネル |
| `$Global:不可視右の右パネル` | Panel | 右にスクロール済みパネル |
| `$Global:レイヤー階層の深さ` | Int | 現在の最深レイヤー番号（初期値=1） |
| `$Global:Pink選択配列` | Array | 各レイヤーの展開状態を管理する配列 |

**Pink選択配列の構造**:
```powershell
$Global:Pink選択配列 = @(
    @{ レイヤー=0; Y座標=0; 値=0; 展開ボタン=0 },  # レイヤー0
    @{ レイヤー=1; Y座標=0; 値=0; 展開ボタン=0 },  # レイヤー1
    ...
    @{ レイヤー=6; Y座標=0; 値=0; 展開ボタン=0 }   # レイヤー6
)
```
- **レイヤー**: レイヤー番号（0-6）
- **Y座標**: スクリプト展開時のY座標
- **値**: 展開状態（0=未展開、1=展開済み）
- **展開ボタン**: 展開しているピンクノードのボタン名

### 7.3 色定義

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:青色` | Color | RGB(200,220,255) - レイヤーパネル背景色 |
| `$global:ピンク青色` | Color | RGB(227,206,229) - ピンク選択（通常） |
| `$global:ピンク赤色` | Color | RGB(252,160,158) - ピンク選択（特殊） |

### 7.4 ボタン/ノード管理

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:ボタンカウンタ` | Int | ボタン自動採番カウンタ（初期値=1） |
| `$global:ドラッグ中のボタン` | Button | ドラッグ中のボタンを追跡 |
| `$global:黄色ボタングループカウンタ` | Int | ループのGroupID（1000番台、初期値=1000） |
| `$global:緑色ボタングループカウンタ` | Int | 条件分岐のGroupID（2000番台、初期値=2000） |
| `$global:drawObjects` | Array | 矢印などの描画オブジェクトリスト |
| `$Global:表示スクリプト座標` | Hashtable | スクリプト座標 `@{ X=0; Y=0 }` |
| `$Global:現在展開中のスクリプト名` | String | 展開中のピンクノード名 |

### 7.5 ファイルパス

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$global:folderPath` | String | 現在のワークフローフォルダパス（例: `.\個々の履歴\AAAAAA111`） |
| `$global:JSONPath` | String | variables.jsonのパス |
| `$global:jsonパス` | String | コード.jsonのパス |

### 7.6 選択状態

| 変数名 | 型 | 用途 |
|--------|-----|------|
| `$Global:Pink選択中` | Boolean | ピンク選択モードのフラグ（初期値=$false） |

---

## 8. 主要関数

### 8.1 フォーム・UI関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `00_フォームを作成する` | 02_メインフォームUI_foam関数.ps1 | メインフォームを生成（1400x1000） |
| `00_メインにボタンを作成する` | 02_メインフォームUI_foam関数.ps1 | ボタンを作成して配置 |
| `00_フレームのDragDropイベントを設定する` | 02_メインフォームUI_foam関数.ps1 | ドラッグ&ドロップイベント設定 |
| `00_ボタンの上詰め再配置関数` | 02_メインフォームUI_foam関数.ps1 | ボタンを上から詰めて整列 |

### 8.2 ネスト規制関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `ドロップ禁止チェック_ネスト規制` | 02_メインフォームUI_foam関数.ps1 | ネスト規制の総合チェック |
| `Get-GroupRangeAfterMove` | 02_メインフォームUI_foam関数.ps1 | 移動後のGroupID範囲を計算 |
| `Get-AllGroupRanges` | 02_メインフォームUI_foam関数.ps1 | パネル内の全GroupID範囲を取得 |
| `Is-IllegalPair` | 02_メインフォームUI_foam関数.ps1 | 条件分岐とループの相互ネストを検出 |
| `Check-GroupFragmentation` | 02_メインフォームUI_foam関数.ps1 | グループ分断をチェック |
| `10_ボタンの一覧取得` | 02_メインフォームUI_foam関数.ps1 | 同色ブロック衝突チェック |

### 8.3 階層・レイヤー関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `階層パスを取得する` | 02_メインフォームUI_foam関数.ps1 | Pink選択配列から階層パスを構築 |
| `階層パス表示を更新する` | 02_メインフォームUI_foam関数.ps1 | ラベルテキストを更新 |
| （レイヤー切り替え関数） | 06_メインフォームUI_フレーム移動.ps1 | レイヤー間のスライド移動 |

### 8.4 矢印描画関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `00_矢印追記処理` | 05_メインフォームUI_矢印処理.ps1 | フレーム内のノード間に矢印を描画 |
| `Check-Pink選択配列Objects` | 05_メインフォームUI_矢印処理.ps1 | ピンク選択配列の整合性チェック |

### 8.5 コード生成関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `実行イベント` | 08_メインF機能_メインボタン処理.ps1 | メイン実行処理・コード生成の起点 |
| `00_文字列処理内容` | 12_コードメイン_コード本文.ps1 | コードスニペット生成 |
| `ShowConditionBuilder` | 15_コードサブ_if文条件式作成.ps1 | 条件分岐ビルダーUI表示 |

### 8.6 JSON操作関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `IDでエントリを取得` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonからコードスニペットを取得 |
| `エントリを追加_指定ID` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonにエントリを追加 |
| `IDでエントリを置換` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonのエントリを置換 |
| `JSON初回` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonの初期化 |
| `取得-JSON値` | 09_変数機能_コードID管理JSON.ps1 | JSONから値を取得 |
| `IDを生成する` | 09_変数機能_コードID管理JSON.ps1 | 最後のIDを自動インクリメント |
| `一覧-フレームパネルのボタン一覧` | 09_変数機能_コードID管理JSON.ps1 | フレーム内のボタン一覧を取得 |

### 8.7 スナップショット機能関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| `スナップショット作成` | 16_スナップショット機能.ps1 | 現在の状態をバックアップ |
| `スナップショット復元` | 16_スナップショット機能.ps1 | 保存された状態を復元 |
| `UIをリロード` | 16_スナップショット機能.ps1 | memory.jsonからUIを再構築 |

### 8.8 変数管理関数

| 関数名 | ファイル | 説明 |
|-------|---------|------|
| （変数管理UI表示） | 10_変数機能_変数管理UI.ps1 | 変数管理フォームを表示 |
| （変数読み込み） | 11_変数機能_変数管理を外から読み込む関数.ps1 | 外部から変数を読み込む |

### 8.9 イベントハンドラー

#### 8.9.1 フォーム系イベント

| イベント | 実装位置 | 動作 |
|---------|--------|------|
| `Form.Add_Shown` | 02_メインフォームUI_foam関数.ps1:44 | フォーム最小化対策、前面化 |
| `Form.Add_Resize` | 02_メインフォームUI_foam関数.ps1:57 | ウィンドウリサイズ時の最小化チェック |

#### 8.9.2 ドラッグ&ドロップイベント

| イベント | 実装位置 | 動作 |
|---------|--------|------|
| `Panel.Add_DragDrop` | 02_メインフォームUI_foam関数.ps1:83 | ボタンドロップ位置決定・ネスト規制チェック・矢印更新 |
| `Panel.Add_DragEnter` | 02_メインフォームUI_foam関数.ps1:511 | ドラッグ時のドロップ効果設定 |
| `Button.Add_MouseDown` | 16_スナップショット機能.ps1:232 | ドラッグ開始・IsDraggingフラグセット |

#### 8.9.3 ボタン系イベント

| イベント | 実装位置 | 動作 |
|---------|--------|------|
| `Button.Add_Click` | 01_メインフォーム_メイン.ps1:346-355 | 切替ボタンのパネル表示/非表示切り替え |
| `Button.Add_Click` | 16_スナップショット機能.ps1:243 | ノード設定ダイアログ起動 |
| `ToolStripMenuItem.Add_Click` | 07_メインF機能_ツールバー作成.ps1:16 | メニュー項目クリック処理 |

#### 8.9.4 カスタム処理イベント

| 機能 | 実装位置 | 説明 |
|-----|--------|------|
| コンテキストメニュー処理 | 02_メインフォームUI_foam関数.ps1:729 | 右クリック→名前変更/編集/削除 |
| 切替ボタンイベント | 08_メインF機能_メインボタン処理.ps1 | 処理カテゴリ切り替え |
| ツールバーイベント | 01_メインフォーム_メイン.ps1:185 | 実行/変数/スナップショット |

---

## 9. 動作環境

### 9.1 システム要件

- **OS**: Windows 10/11
- **PowerShell**: 5.1以上
- **.NET Framework**: 4.5以上

### 9.2 セットアップ手順

1. リポジトリをクローン
2. 実行ポリシーを設定
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```
3. `実行.bat` を起動、または `.\01_メインフォーム_メイン.ps1` を実行

---

## 10. 既知の問題と制限事項

### 10.1 修正済みの問題（2025年10月29日）

1. **未初期化変数 `$hasProcessedPink`**
   - 場所: `05_メインフォームUI_矢印処理.ps1:14`
   - 修正: 初期化コードを追加

2. **デバッグコードの残存**
   - 場所: `01_メインフォーム_メイン.ps1:262-263`
   - 修正: コメントアウト

3. **重複グローバル変数定義**
   - 変数: `$Global:表示スクリプト座標`
   - 場所: `01_メインフォーム_メイン.ps1:195`（削除済み）
   - 正しい定義: 行70

4. **ハードコードされたパス**
   - 修正内容:
     - `実行.bat`: 相対パス `%~dp0` を使用
     - `01_メインフォーム_メイン.ps1`: `$PSScriptRoot` を使用
     - 各種JSON参照パス: `.\RPA-UI2\` → `.\` に修正
   - 効果: 任意のディレクトリで動作可能

5. **空ファイルのドキュメント化**
   - `03_メインフォームUI_ノードボタンメニュー処理.ps1`: 目的と予定機能を文書化
   - `04_メインフォームUI_スクリプト処理.ps1`: 目的と予定機能を文書化

### 10.2 最近追加された機能（2025年11月1日）

1. **階層パス表示機能**
   - ウィンドウ下部に現在の階層パスを表示
   - デバッグ時の位置確認を支援

2. **スクリプト展開中チェック機能**
   - レイヤー2以上へのノード配置時に親レイヤーの展開状態を検証
   - 階層構造の整合性を保証

3. **スナップショット機能**
   - 現在の状態を一時保存して復元可能
   - 試行錯誤時の安全網として機能

4. **ウィンドウサイズ拡大**
   - フォームサイズを1400x1000に拡大
   - より広い作業領域を提供

5. **矢印ボタンのバリデーション位置修正**
   - ピンク色ノードと矢印の配置位置を最適化

### 10.3 未実装機能と今後の開発予定

参照: `issue_list.txt`

#### フェーズ1候補（優先度：高）

**1. ノード右クリックメニュー（コピー/貼り付け/削除）**
- **目的**: 既存ノードの複製・再利用、安全な削除
- **価値**: 編集スピード向上、直感的な操作、memory.jsonとコード.jsonの同時更新フック集約
- **難易度**: 中
- **備考**: ContextMenuStripとID採番ロジックは既存なので追加実装中心

**2. ノード検索とジャンプ**
- **目的**: ノード数増加時の目的処理への迅速なナビゲーション、レイヤー横断検索
- **価値**: 保守とレビューの高速化、大規模化しても迷わない、再利用性向上
- **難易度**: 低～中
- **備考**: memory.jsonにノード名/座標/レイヤーIDが揃っているのでインデックス化容易

#### フェーズ2候補（優先度：中）

**3. Undo / Redo**
- **目的**: 誤操作からの即復帰、大規模レイアウト変更の試行
- **価値**: 安全な編集、レイアウト崩壊を恐れない試行錯誤
- **難易度**: 高
- **備考**:
  - 画面上のボタンとmemory.jsonを同時に巻き戻す履歴スタックの新規設計が必要
  - スナップショット機能が基盤として実装済み（将来の拡張予定）

#### フェーズ3候補（優先度：低）

**4. 変数パネル（変数の定義と現在値の可視化）**
- **目的**: 変数の定義・使用箇所の明示、未定義参照の検出
- **価値**: デバッグの容易化、事故的な上書き・未定義参照の早期発見、説明のしやすさ
- **難易度**: 高
- **備考**: 実行エンジンから現在の変数状態をUIへ渡す仕組みが必要

**5. ピンク選択の再利用機能**
- **目的**: 別ワークフローでのスクリプト呼び出し
- **価値**: 共通処理の再利用性向上
- **難易度**: 中～高

**6. スクリプト詳細の高度な編集機能**
- **目的**: ピンク化されたスクリプトの詳細編集
- **価値**: より柔軟なスクリプト管理
- **難易度**: 中

---

## 11. 開発ガイドライン

### 11.1 コーディング規約

- **エンコーディング**: UTF-8 BOM
- **関数命名**: 日本語（例: `実行イベント`, `ノードを追加`）
- **変数命名**: 日本語グローバル変数、英語ローカル変数も混在
- **インデント**: 4スペース

### 11.2 ファイル命名規則

- `01_～`: メインエントリポイント・初期化
- `02_～`: UI関連関数
- `05_～`: UI描画・レンダリング
- `06_～`: レイヤー操作
- `07_～`: ノード追加ロジック
- `08_～`: イベントハンドラー
- `09_～`: データ永続化
- `10_～11_`: データ変換（ノード⇔JSON）
- `12_～15_`: コード生成

---

## 12. プロジェクト統計

### 12.1 ファイル統計（2025年11月1日時点）

| カテゴリ | ファイル数 | 合計行数 |
|---------|----------|---------|
| **メインスクリプト** | 16ファイル | 約7,889行 |
| **ノード処理スクリプト** | 17ファイル (01_code/) | 約1,200行 |
| **設定・データファイル** | 4ファイル (JSON等) | - |
| **ドキュメント** | 5ファイル (.md, .txt) | - |

**主要ファイルの行数内訳**:
- `02_メインフォームUI_foam関数.ps1`: 2,634行（最大）
- `15_コードサブ_if文条件式作成.ps1`: 950行
- `05_メインフォームUI_矢印処理.ps1`: 686行
- `08_メインF機能_メインボタン処理.ps1`: 545行
- `09_変数機能_コードID管理JSON.ps1`: 528行
- `01_メインフォーム_メイン.ps1`: 517行
- `10_変数機能_変数管理UI.ps1`: 457行
- `06_メインフォームUI_フレーム移動.ps1`: 427行
- `16_スナップショット機能.ps1`: 293行（新規追加）

### 12.2 技術統計

- **主要言語**: PowerShell 5.1+
- **フレームワーク**: Windows Forms (.NET Framework)
- **データ形式**: JSON
- **コード品質**: 理解度 96%（2025年10月29日時点）
- **グローバル変数数**: 約25個
- **主要関数数**: 50+関数
- **イベントハンドラー数**: 15+ハンドラー
- **ノードタイプ数**: 17種類（処理番号1-1～99-1）

### 12.3 機能統計

| 機能カテゴリ | 実装済み | 未実装 |
|------------|---------|--------|
| **ノード操作** | 追加、移動、設定 | 削除、コピー、貼り付け |
| **レイヤー管理** | 7階層、切り替え | - |
| **ネスト規制** | 3階層チェック | - |
| **スクリプト化** | ピンク選択 | 再利用機能 |
| **変数管理** | Excel/CSV読み込み、保存 | 実行時可視化 |
| **コード生成** | 自動生成、ISE起動 | - |
| **スナップショット** | 作成、復元 | 複数管理、履歴スタック |
| **階層パス表示** | 実装済み | - |
| **デバッグ支援** | 階層パス、展開チェック | ノード検索、ジャンプ |

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| ノード | ワークフロー上の処理単位（ボタンとして表示） |
| レイヤー | ノードを配置する階層（7階層） |
| GroupID | 条件分岐/ループの開始・中間・終了を紐づけるID |
| ピンク選択 | 複数ノードをサブルーチン化する機能 |
| ネスト規制 | 制御構造内に中途半端にノードを配置できない制約 |

---

## 付録B: 参考ドキュメント

- **README.md**: 詳細な使い方とアーキテクチャ
- **ARCHITECTURE.md**: システム全体のアーキテクチャ詳細
- **REFACTORING_PLAN.md**: 7フェーズのリファクタリング計画
- **issue_list.txt**: 今後の開発予定機能

---

**変更履歴**

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-11-01 | 2.0 | 仕様書の大幅な補完・更新 |
| | | - 最新機能の詳細追加（階層パス表示、スクリプト展開チェック、スナップショット） |
| | | - ノード処理関数一覧を追加 |
| | | - ネスト規制の詳細ロジックを追加 |
| | | - グローバル変数の完全リストを追加 |
| | | - 主要関数をカテゴリ別に整理 |
| | | - イベントハンドラーの詳細を追加 |
| | | - データフローの詳細図を追加 |
| | | - 今後の開発予定（issue_list.txt）を反映 |
| | | - プロジェクト統計を更新 |
| 2025-11-01 | 1.0 | 初版作成 |

