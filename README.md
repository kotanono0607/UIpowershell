# UIpowershell - ビジュアルRPAプラットフォーム

ドラッグ&ドロップでRPA処理を作成できる、PowerShell製のビジュアルワークフロー構築ツール。

## 📋 プロジェクト概要

**UIpowershell**は、プログラミング知識がなくてもRPA（Robotic Process Automation）処理を視覚的に構築できるツールです。ノードをドラッグ&ドロップで配置し、フローチャートのように処理を組み立てることで、自動的にPowerShellスクリプトを生成します。

### 主な用途
- **Excel/CSVデータの読み込み → Webシステムへの転記**（メインユースケース）
- アプリケーションの自動操作
- 画像マッチングによるUI操作
- キーボード/マウス操作の自動化

### 技術スタック
- PowerShell 5.1+
- Windows Forms (.NET Framework)
- JSON (データ永続化)

---

## ✨ 主な機能

### 1. **ビジュアルノード配置**
- ドラッグ&ドロップでノードを配置
- 5種類のノードタイプ：
  - **White (順次処理)**: 通常の処理
  - **SpringGreen (条件分岐)**: if-else構造
  - **LemonChiffon (ループ)**: 繰り返し処理
  - **Salmon (順次/特殊)**: 制御構造内の処理
  - **Pink (スクリプト化)**: サブルーチン化されたノード群

### 2. **レイヤーシステム (7階層)**
- レイヤー0～6の階層構造
- ドリルダウン方式で深い階層を表現
- レイヤー間のアニメーション付きスライド移動

```
レイヤー0: 非表示（予備）
レイヤー1: メイン作業領域 (X=550, 常時表示)
レイヤー2: サブ領域 (X=940, 表示)
レイヤー3～6: 深い階層用 (X=1330, 非表示)
```

### 3. **ネスト規制**
- ループ/条件分岐内に中途半端にノードを配置できないように制御
- レイアウト崩れを防止し、正しいコード生成を保証

### 4. **ピンク選択（スクリプト化）**
- SHIFT+クリックで複数ノードを選択
- レイヤーボタンでスクリプト化（ピンク色に変化）
- "ログイン処理"などの繰り返し使う処理をまとめる（サブルーチン化）
- 右レイヤーに詳細を表示

### 5. **GroupID管理**
- 条件分岐/ループの開始・中間・終了をグループ化
- ドラッグ移動時もグループの整合性を維持

### 6. **変数管理**
- Excel/CSVから読み込んだデータを変数として保存
- 実行時に変数を参照してデータを転記

### 7. **自動コード生成**
- ノード配置を解析してPowerShellスクリプトを自動生成
- `output.ps1` としてエクスポート
- PowerShell ISEで即座に実行可能

### 8. **スナップショット機能**（NEW! 2025-11-01）
- 現在の状態をスナップショットとして保存
- いつでもスナップショット作成時の状態に復元可能
- 試行錯誤が安心してできる
- オートセーブと併用可能
- 将来的にUndo/Redo機能に拡張予定

---

## 🚀 セットアップ

### 前提条件
- Windows 10/11
- PowerShell 5.1以上
- .NET Framework 4.5以上

### インストール手順

1. **リポジトリをクローン**
   ```bash
   git clone https://github.com/kotanono0607/UIpowershell.git
   cd UIpowershell
   ```

2. **実行ポリシーの設定**（初回のみ）
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

3. **起動**

   **方法1: バッチファイルから起動**
   ```batch
   実行.bat
   ```

   **方法2: PowerShellから直接起動**
   ```powershell
   .\01_メインフォーム_メイン.ps1
   ```

---

## 📖 使い方

### 基本的なワークフロー作成

1. **ノードの追加**
   - 左側のパレットからノードを選択
   - レイヤー1にドラッグ&ドロップ

2. **ノードの設定**
   - ノードをクリックして設定画面を開く
   - 処理内容（テキスト入力、アプリ起動、画像マッチなど）を設定

3. **制御構造の追加**
   - 条件分岐ノード（緑）: if-else構造
   - ループノード（黄）: 繰り返し処理
   - 開始・中間・終了が自動的にGroupIDで紐づけられる

4. **実行**
   - 「実行」ボタンをクリック
   - `output.ps1` が生成され、PowerShell ISEで開く
   - 生成されたスクリプトを確認・実行

### スクリプト化（ピンク選択）

1. **SHIFTキーを押しながら複数ノードを選択**
2. **レイヤーボタンをクリック**
3. 選択したノードがピンク色に変化
4. 右側のレイヤーに詳細が表示される

### 保存と読み込み

- **自動保存**: ノード配置は自動的に `個々の履歴/{フォルダ名}/` に保存
- **フォルダ切替**: 「フォルダ切替」ボタンで別のワークフローに切り替え
- **新規作成**: 「フォルダ作成」ボタンで新しいワークフローを作成

### スナップショット機能（試行錯誤に便利）

1. **スナップショット作成**
   - 「📸 スナップショット」メニュー → 「📸 スナップショット作成」
   - 現在の状態が保存される

2. **試行錯誤**
   - ノードを自由に追加・移動・削除
   - オートセーブは通常通り動作

3. **復元（元に戻したい場合）**
   - 「📸 スナップショット」メニュー → 「↩️ スナップショットから復元」
   - スナップショット作成時の状態に戻る

4. **気に入った場合**
   - 何もしない（そのまま使い続ける）

詳しくは `スナップショット機能_使い方.md` を参照してください。

---

## 📁 ディレクトリ構造

```
UIpowershell/
├── 01_メインフォーム_メイン.ps1           # メインエントリポイント
├── 02_メインフォームUI_foam関数.ps1       # UI関数・ネスト規制
├── 03_メインフォームUI_ノードボタンメニュー処理.ps1  # 右クリックメニュー（未実装）
├── 04_メインフォームUI_スクリプト処理.ps1 # スクリプト高度管理（未実装）
├── 05_メインフォームUI_矢印処理.ps1       # ノード間の矢印描画
├── 06_メインフォームUI_レイヤー移動.ps1   # レイヤー切り替え
├── 07_メインF機能_ノード追加処理.ps1      # ノード追加ロジック
├── 08_メインF機能_メインボタン処理.ps1    # 実行・変数・フォルダボタン
├── 09_変数機能_コードID管理JSON.ps1       # JSON操作関数
├── 10_コード反映_ノードからコードJSON.ps1 # ノード→JSON変換
├── 11_コード反映_コードJSONからノード.ps1 # JSON→ノード変換
├── 12_コードメイン_コード本文.ps1         # コード生成メイン
├── 13_コードサブ汎用関数.ps1              # UI入力ダイアログ
├── 14_コードサブ_画面要素取得.ps1         # UI要素取得
├── 15_コードサブ_if文条件式作成.ps1       # 条件式生成
├── 16_スナップショット機能.ps1            # スナップショット作成・復元 (NEW!)
├── 実行.bat                               # 起動用バッチファイル
├── ボタン設定.json                        # ノード定義・関数マッピング
├── スナップショット機能_使い方.md         # スナップショット機能ガイド (NEW!)
├── ARCHITECTURE.md                        # アーキテクチャドキュメント
├── REFACTORING_PLAN.md                    # リファクタリング計画
├── SPEC.md                                # システム仕様書
├── README.md                              # このファイル
├── 個々の履歴/                            # ワークフロー保存先
│   ├── メイン.json                        # 現在のフォルダパス
│   ├── AAAAAA111/                         # ワークフローフォルダ例
│   │   ├── コード.json                    # 生成コードスニペット
│   │   ├── memory.json                    # ノード配置情報
│   │   ├── variables.json                 # 実行時変数
│   │   ├── memory_snapshot.json           # スナップショット (NEW!)
│   │   ├── コード_snapshot.json           # スナップショット (NEW!)
│   │   └── snapshot_info.json             # スナップショット情報 (NEW!)
│   └── AAA/                               # 別のワークフロー例
├── コード/                                # コード生成用スクリプト群
│   └── 20250531_画像マッチ（マルチモニタ）.ps1
└── 02_ツール/                             # ユーティリティ
    └── 01_JSON調整.ps1                    # JSON編集ツール
```

---

## 🗂️ データ構造

### 1. **memory.json** - ノード配置情報

各レイヤーのノード配置を記録。UIの状態を完全に復元可能。

```json
{
  "1": {  // レイヤー番号
    "構成": [
      {
        "ボタン名": "215-1",        // ノードID
        "X座標": 89,
        "Y座標": 20,
        "順番": 1,
        "ボタン色": "LemonChiffon",  // ループノード
        "テキスト": "ループ 開始",
        "処理番号": "1-3",
        "高さ": 30,
        "幅": 120,
        "script": "未設定"           // スクリプト化情報
      },
      {
        "ボタン名": "196-1",
        "X座標": 89,
        "Y座標": 70,
        "ボタン色": "SpringGreen",   // 条件分岐ノード
        "テキスト": "条件分岐 開始",
        "処理番号": "1-2",
        "script": "未設定"
      }
    ]
  },
  "2": { "構成": [] },  // 空のレイヤー
  "3": { "構成": [] }
}
```

### 2. **コード.json** - 生成コードスニペット

各ノードIDに対応するPowerShellコードを保存。

```json
{
  "エントリ": {
    "100-1": "Write-Host \"OK\"",           // 通常ノード
    "61-1": "if () {",                      // 条件分岐開始
    "61-2": "} else {",                     // else分岐
    "61-3": "}",                            // 条件分岐終了
    "54-1-1": "if () {",                    // 入れ子ノード（親54、分岐1、子1）
    "54-1-2": "} else {",                   // 入れ子のelse
    "54-2-3": "}",                          // 入れ子の終了
    "176-1": "AAAA\r\n169-1;White;順次;\r\n170-1;White;順次;"  // ピンクノード詳細
  },
  "最後のID": 215  // 次に作成されるノードのID
}
```

**ID命名規則:**
- `{数字}-{分岐}`: 基本ノード（例: 100-1）
- `{GroupID}-{分岐番号}`: 制御構造（例: 61-1=if開始, 61-2=else, 61-3=終了）
- `{GroupID}-{親分岐}-{子番号}`: 入れ子構造（例: 54-1-1）

### 3. **variables.json** - 実行時変数

Excel/CSVから読み込んだデータを保存。

```json
{
  "Excel2次元配列": [
    ["A", "B", "C"],
    [1, "ww", "あいう"],
    [2, "ee", "ｓｄｆｔｇ"]
  ],
  "GINPパス": "C:\\Users\\hallo\\AppData\\Local\\Programs\\GIMP 2\\bin\\gimp-2.10.exe"
}
```

### 4. **ボタン設定.json** - ノード定義

各ノードの処理番号と関数名のマッピング。

```json
[
  {
    "処理番号": "1-1",
    "関数名": "順次処理関数",
    "背景色": "White",
    "説明": "通常の順次処理"
  },
  {
    "処理番号": "1-2",
    "関数名": "条件分岐関数",
    "背景色": "SpringGreen",
    "説明": "if-else条件分岐"
  }
]
```

---

## 🏗️ アーキテクチャ

### コード生成フロー

```
[1] ユーザーがノードを配置
     ↓
[2] memory.json に配置情報を保存
     ↓
[3] ノード設定を入力
     ↓
[4] コード.json にコードスニペットを保存
     ↓
[5] 「実行」ボタンをクリック
     ↓
[6] 実行イベント関数が起動（08_メインF機能_メインボタン処理.ps1）
     ├─ レイヤー1からボタンをY座標順に取得
     ├─ 各ボタンIDで「IDでエントリを取得」を呼び出し
     ├─ 特殊処理: Redボタン→Blueボタンの間にelse分岐挿入
     │   └─ specialId = lastGreenParentId-2
     └─ $outputに全コードを蓄積
     ↓
[7] output.ps1 に書き込み（UTF-8エンコーディング）
     ↓
[8] PowerShell ISE で自動的に開く
```

### 主要なグローバル変数

| 変数名 | 用途 |
|--------|------|
| `$global:レイヤー0～6` | 7つのレイヤーパネル |
| `$global:可視左パネル` | 現在表示中の左パネル |
| `$global:可視右パネル` | 現在表示中の右パネル |
| `$global:Pink選択配列` | ピンク選択されたノード配列 |
| `$global:Pink選択中` | ピンク選択モードのフラグ |
| `$global:レイヤー階層の深さ` | 現在のレイヤー深さ |
| `$global:folderPath` | 現在のワークフローフォルダパス |
| `$global:メインフォーム` | メインウィンドウ |

---

## 🐛 既知の問題と修正履歴

### ✅ 修正済み（2025年10月29日）

1. **未初期化変数 `$hasProcessedPink`**
   - 場所: `05_メインフォームUI_矢印処理.ps1:14`
   - 修正: 初期化コードを追加

2. **デバッグコードの残存**
   - 場所: `01_メインフォーム_メイン.ps1:262-263`
   - 修正: コメントアウト

3. **重複グローバル変数定義**
   - 変数: `$Global:表示スクリプト座標`
   - 場所: `01_メインフォーム_メイン.ps1:195`（削除済み）
   - 正しい定義: 行70

4. **ハードコードされたパス**
   - 修正内容:
     - `実行.bat`: 相対パス `%~dp0` を使用
     - `01_メインフォーム_メイン.ps1`: `$PSScriptRoot` を使用
     - 各種JSON参照パス: `.\RPA-UI2\` → `.\` に修正
   - 効果: 任意のディレクトリで動作可能

5. **空ファイルのドキュメント化**
   - `03_メインフォームUI_ノードボタンメニュー処理.ps1`: 目的と予定機能を文書化
   - `04_メインフォームUI_スクリプト処理.ps1`: 目的と予定機能を文書化

### ⚠️ 未実装機能

- ノードの右クリックメニュー（コピー/貼り付け/削除）
- ピンク選択の再利用機能（別ワークフローでの呼び出し）
- スクリプト詳細の高度な編集機能

---

## 🔧 開発者向け情報

### ファイル命名規則

- `01_～`: メインエントリポイント・初期化
- `02_～`: UI関連関数
- `05_～`: UI描画・レンダリング
- `06_～`: レイヤー操作
- `07_～`: ノード追加ロジック
- `08_～`: イベントハンドラー
- `09_～`: データ永続化
- `10_～11_`: データ変換（ノード⇔JSON）
- `12_～15_`: コード生成

### コーディング規約

- エンコーディング: UTF-8 BOM
- 関数命名: 日本語（例: `実行イベント`, `ノードを追加`）
- 変数命名: 日本語グローバル変数、英語ローカル変数も混在
- インデント: 4スペース

### 重要な関数

| 関数名 | ファイル | 用途 |
|--------|----------|------|
| `実行イベント` | 08_メインF機能_メインボタン処理.ps1 | メイン実行処理 |
| `00_矢印追記処理` | 05_メインフォームUI_矢印処理.ps1 | 矢印描画 |
| `00_文字列処理内容` | 12_コードメイン_コード本文.ps1 | コードスニペット生成 |
| `Get-GroupRangeAfterMove` | 02_メインフォームUI_foam関数.ps1 | GroupID範囲計算 |
| `IDでエントリを取得` | 09_変数機能_コードID管理JSON.ps1 | コード.jsonから取得 |

### デバッグ方法

1. **コンソール出力を確認**
   ```powershell
   # 各所に埋め込まれたWrite-Host文を確認
   Write-Host "ここまできてる？"
   ```

2. **JSON内容を確認**
   ```powershell
   # 02_ツール/01_JSON調整.ps1 を使用
   .\02_ツール\01_JSON調整.ps1
   ```

3. **生成されたコードを確認**
   ```powershell
   # 実行後、個々の履歴/{フォルダ名}/output.ps1 を確認
   ```

---

## 📚 参考ドキュメント

- **ARCHITECTURE.md**: システム全体のアーキテクチャ詳細（理解度88%時点）
- **REFACTORING_PLAN.md**: 7フェーズのリファクタリング計画

---

## 📊 プロジェクト統計

- **総ファイル数**: 37ファイル
- **総行数**: 8,091行
- **主要言語**: PowerShell
- **理解度**: 96% (2025年10月29日時点)

---

## 🤝 コントリビューション

現在はプライベートプロジェクトとして開発中。

---

## 📝 ライセンス

未定

---

## 🔄 更新履歴

### 2025-11-01
- **スナップショット機能追加**
  - 現在の状態をスナップショットとして保存
  - いつでもスナップショット作成時の状態に復元可能
  - 試行錯誤が安心してできる
  - 将来的にUndo/Redo機能に拡張予定
- SPEC.md（システム仕様書）作成

### 2025-10-29
- ポータビリティ向上（ハードコードパス削除）
- 既知の問題5件を修正
- README.md作成

### 2025-XX-XX
- 初回リリース
- 基本機能実装

---

## 📧 お問い合わせ

プロジェクトに関する質問は、GitHubのIssuesからお願いします。

---

**開発者メモ**: このREADMEは理解度96%時点の情報を基に作成されています。実際の動作確認や詳細なテストは継続中です。
