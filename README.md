# UIpowershell - ビジュアルRPAプラットフォーム

ドラッグ&ドロップでRPA処理を作成できる、PowerShell製のビジュアルワークフロー構築ツール。

## 📋 プロジェクト概要

**UIpowershell**は、プログラミング知識がなくてもRPA（Robotic Process Automation）処理を視覚的に構築できるツールです。ノードをドラッグ&ドロップで配置し、フローチャートのように処理を組み立てることで、自動的にPowerShellスクリプトを生成します。

### 主な用途
- **Excel/CSVデータの読み込み → Webシステムへの転記**（メインユースケース）
- アプリケーションの自動操作
- 画像マッチングによるUI操作
- キーボード/マウス操作の自動化

### 技術スタック
- **バックエンド**: PowerShell 5.1+ / PowerShell 7.x (推奨)
- **HTTPサーバー**: Pode 2.11.0 (PowerShell製HTTPサーバー)
- **フロントエンド**: React 18.2.0 + React Flow 11.7.4
- **UI/UX**: Neumorphism + Auroraデザイン
- **データ永続化**: JSON (UTF-8 BOM)

---

## ✨ 主な機能

### 1. **ビジュアルノード配置**
- ドラッグ&ドロップでノードを配置
- 5種類のノードタイプ：
  - **White (順次処理)**: 通常の処理
  - **SpringGreen (条件分岐)**: if-else構造
  - **LemonChiffon (ループ)**: 繰り返し処理
  - **Salmon (順次/特殊)**: 制御構造内の処理
  - **Pink (スクリプト化)**: サブルーチン化されたノード群

### 2. **レイヤーシステム (7階層)**
- レイヤー0～6の階層構造
- ドリルダウン方式で深い階層を表現
- レイヤー間のアニメーション付きスライド移動

```
レイヤー0: 非表示（予備）
レイヤー1: メイン作業領域 (X=550, 常時表示)
レイヤー2: サブ領域 (X=940, 表示)
レイヤー3～6: 深い階層用 (X=1330, 非表示)
```

### 3. **ネスト規制**
- ループ/条件分岐内に中途半端にノードを配置できないように制御
- レイアウト崩れを防止し、正しいコード生成を保証

### 4. **ピンク選択（スクリプト化）**
- SHIFT+クリックで複数ノードを選択
- レイヤーボタンでスクリプト化（ピンク色に変化）
- "ログイン処理"などの繰り返し使う処理をまとめる（サブルーチン化）
- 右レイヤーに詳細を表示

### 5. **GroupID管理**
- 条件分岐/ループの開始・中間・終了をグループ化
- ドラッグ移動時もグループの整合性を維持

### 6. **変数管理**
- Excel/CSVから読み込んだデータを変数として保存
- 実行時に変数を参照してデータを転記

### 7. **自動コード生成**
- ノード配置を解析してPowerShellスクリプトを自動生成
- `output.ps1` としてエクスポート
- PowerShell ISEで即座に実行可能

### 8. **Undo/Redo機能**（NEW! 2025-11-19）
- 操作ごとに自動的に履歴を記録
- Undoボタンで直前の操作を取り消し
- Redoボタンで取り消した操作をやり直し
- 最大50件の操作履歴を保持
- ノード追加・削除・移動などすべての操作に対応
- `history.json` に履歴データを自動保存

### 9. **スナップショット機能**（2025-11-01）
- 現在の状態をスナップショットとして保存
- いつでもスナップショット作成時の状態に復元可能
- 試行錯誤が安心してできる
- オートセーブと併用可能
- Undo/Redo機能と併用可能

---

## 🚀 セットアップ

### 前提条件
- Windows 10/11
- PowerShell 5.1以上（PowerShell 7.x 推奨）
- Webブラウザ（Chrome、Edge、Firefoxなど）

### インストール手順

1. **リポジトリをクローン**
   ```bash
   git clone https://github.com/kotanono0607/UIpowershell.git
   cd UIpowershell
   ```

2. **実行ポリシーの設定**（初回のみ）
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

3. **起動**

   **方法1: クイックスタート（推奨）**
   ```powershell
   .\quick-start.ps1
   ```
   - 必須ファイルの自動チェック
   - Podeモジュールの自動インストール
   - ポート使用状況の自動確認
   - ブラウザの自動起動

   **方法2: 手動起動**
   ```powershell
   .\adapter\api-server-v2-pode-complete.ps1 -Port 8080 -AutoOpenBrowser
   ```

4. **アクセス**
   - ブラウザで `http://localhost:8080/index-legacy.html` にアクセス
   - Neumorphismデザインの美しいUIが表示されます

---

## 📖 使い方

### 基本的なワークフロー作成

1. **ノードの追加**
   - 左側のパレットからノードを選択
   - レイヤー1にドラッグ&ドロップ

2. **ノードの設定**
   - ノードをクリックして設定画面を開く
   - 処理内容（テキスト入力、アプリ起動、画像マッチなど）を設定

3. **制御構造の追加**
   - 条件分岐ノード（緑）: if-else構造
   - ループノード（黄）: 繰り返し処理
   - 開始・中間・終了が自動的にGroupIDで紐づけられる

4. **コード生成**
   - 「コード生成」ボタンをクリック
   - `output.ps1` が生成され、PowerShell ISEで開く
   - 生成されたスクリプトを確認・実行

### スクリプト化（レイヤー化）

**方法1: 右クリックメニュー（推奨）**
1. **SHIFTキーを押しながら複数ノードを選択**（赤枠で選択される）
2. **選択したノードを右クリック → 「レイヤー化」を選択**
3. 選択したノードがピンク色のスクリプトノードに変化
4. ピンクノードをクリックすると右側のレイヤーに詳細が展開される

**方法2: SHIFTキー + レイヤーボタン**
1. **SHIFTキーを押しながら複数ノードを選択**
2. **レイヤーボタンをクリック**
3. 選択したノードがピンク色に変化

### 保存と読み込み

- **自動保存**: ノード配置は自動的に `03_history/{フォルダ名}/` に保存
- **フォルダ管理**: 「フォルダ管理」ボタンでフォルダの作成・切替・削除が可能

### スナップショット機能（試行錯誤に便利）

1. **スナップショット作成**
   - 「📸 スナップショット」ボタンをクリック
   - 現在の状態が保存される

2. **試行錯誤**
   - ノードを自由に追加・移動・削除
   - オートセーブは通常通り動作

3. **復元（元に戻したい場合）**
   - 「↩ 復元」ボタンをクリック
   - スナップショット作成時の状態に戻る

4. **気に入った場合**
   - 何もしない（そのまま使い続ける）

### Undo/Redo機能（操作の取り消し/やり直し）

1. **Undo（操作を取り消す）**
   - 「編集」メニュー → 「↶ 元に戻す」
   - または ツールバーの「↶」ボタン
   - 直前の操作（ノード追加、削除、移動など）を取り消し

2. **Redo（取り消した操作をやり直す）**
   - 「編集」メニュー → 「↷ やり直し」
   - または ツールバーの「↷」ボタン
   - Undoで取り消した操作をやり直し

3. **自動保存**
   - すべての操作が自動的に `03_history/{フォルダ名}/history.json` に記録される
   - プロジェクトを閉じても履歴は保持される
   - 最大50件の操作履歴を保持（古い履歴は自動削除）

4. **対応操作**
   - ノード追加/削除
   - ノード移動
   - ノード設定変更
   - 変数の追加/削除/変更

**Tips**: Undo/Redoとスナップショット機能を組み合わせると、より柔軟な試行錯誤が可能です。

---

## 📁 ディレクトリ構造

```
UIpowershell/
├── adapter/                              # REST APIレイヤー
│   ├── api-server-v2-pode-complete.ps1  # Pode HTTPサーバー（50エンドポイント）
│   ├── CONVERTED_ROUTES.ps1             # Pode用ルート定義ファイル
│   ├── state-manager.ps1                # グローバル状態管理
│   └── node-operations.ps1              # ノード配列操作ユーティリティ
├── ui/                                   # フロントエンド（React + React Flow）
│   ├── index-legacy.html                # メインHTML
│   ├── app-legacy.js                    # メインJavaScript（233KB）
│   ├── style-legacy.css                 # Neumorphism + Aurora CSS
│   ├── arrow-patch-hybrid.js            # Auroraグラデーション矢印
│   └── libs/                            # React関連ライブラリ
├── 00_共通ユーティリティ_JSON操作.ps1     # JSON読み書き統一関数
├── 09_変数機能_コードID管理JSON.ps1       # コードエントリ管理
├── 12_コードメイン_コード本文_v2.ps1      # コード生成メイン（UI非依存）
├── 10_変数機能_変数管理UI_v2.ps1         # 変数管理（UI非依存）
├── 07_メインF機能_ツールバー作成_v2.ps1   # ノード追加ロジック（UI非依存）
├── 08_メインF機能_メインボタン処理_v2.ps1 # 実行イベント処理（UI非依存）
├── 02-6_削除処理_v2.ps1                  # ノード削除処理（UI非依存）
├── 02-2_ネスト規制バリデーション_v2.ps1  # ネスト規制チェック（UI非依存）
├── 16_スナップショット機能.ps1           # スナップショット管理（UI非依存）
├── 17_操作履歴管理.ps1                   # Undo/Redo履歴管理（UI非依存）
├── quick-start.ps1                       # クイックスタートスクリプト
├── ボタン設定.json                        # ノード定義（19種類）
├── SPEC.md                               # システム仕様書
├── README.md                             # このファイル
├── 00_code/                              # 実行可能コードスニペット
│   ├── 2-1.ps1                          # マウス座標取得
│   ├── 4-1.ps1                          # UI要素取得
│   └── 10-1.ps1                         # スクリーンショット
├── 01_tools/                             # ツール類
│   └── 01_JSON調整.ps1                  # JSON編集ツール
├── 02_modules/                           # 共有モジュール
│   ├── 20241016_psUIGET.psm1           # UI要素取得モジュール
│   ├── 20241019_point.psm1              # マウス座標取得モジュール
│   └── 20250531_screenShot.psm1         # スクリーンショットモジュール
├── 03_history/                           # プロジェクトデータ保存先
│   ├── メイン.json                        # 現在のフォルダパス
│   ├── AAAAAA111/                         # ワークフローフォルダ例
│   │   ├── コード.json                    # 生成コードスニペット
│   │   ├── memory.json                    # ノード配置情報
│   │   ├── variables.json                 # 実行時変数
│   │   ├── history.json                   # Undo/Redo履歴（NEW!）
│   │   ├── memory_snapshot.json           # スナップショット
│   │   ├── コード_snapshot.json           # スナップショット
│   │   └── snapshot_info.json             # スナップショット情報
│   └── TA/                                # 別のワークフロー例
├── Modules/                              # 外部モジュール（Pode等）
└── files/                                # 設定ファイル・ガイド
```

---

## 🗂️ データ構造

### 1. **memory.json** - ノード配置情報

各レイヤーのノード配置を記録。UIの状態を完全に復元可能。

```json
{
  "1": {  // レイヤー番号
    "構成": [
      {
        "ボタン名": "215-1",        // ノードID
        "X座標": 89,
        "Y座標": 20,
        "順番": 1,
        "ボタン色": "LemonChiffon",  // ループノード
        "テキスト": "ループ 開始",
        "処理番号": "1-3",
        "高さ": 30,
        "幅": 120,
        "script": "未設定"           // スクリプト化情報
      },
      {
        "ボタン名": "196-1",
        "X座標": 89,
        "Y座標": 70,
        "ボタン色": "SpringGreen",   // 条件分岐ノード
        "テキスト": "条件分岐 開始",
        "処理番号": "1-2",
        "script": "未設定"
      }
    ]
  },
  "2": { "構成": [] },  // 空のレイヤー
  "3": { "構成": [] }
}
```

### 2. **コード.json** - 生成コードスニペット

各ノードIDに対応するPowerShellコードを保存。

```json
{
  "エントリ": {
    "100-1": "Write-Host \"OK\"",           // 通常ノード
    "61-1": "if () {",                      // 条件分岐開始
    "61-2": "} else {",                     // else分岐
    "61-3": "}",                            // 条件分岐終了
    "54-1-1": "if () {",                    // 入れ子ノード（親54、分岐1、子1）
    "54-1-2": "} else {",                   // 入れ子のelse
    "54-2-3": "}",                          // 入れ子の終了
    "176-1": "AAAA\r\n169-1;White;順次;\r\n170-1;White;順次;"  // ピンクノード詳細
  },
  "最後のID": 215  // 次に作成されるノードのID
}
```

**ID命名規則:**
- `{数字}-{分岐}`: 基本ノード（例: 100-1）
- `{GroupID}-{分岐番号}`: 制御構造（例: 61-1=if開始, 61-2=else, 61-3=終了）
- `{GroupID}-{親分岐}-{子番号}`: 入れ子構造（例: 54-1-1）

### 3. **variables.json** - 実行時変数

Excel/CSVから読み込んだデータを保存。

```json
{
  "Excel2次元配列": [
    ["A", "B", "C"],
    [1, "ww", "あいう"],
    [2, "ee", "ｓｄｆｔｇ"]
  ],
  "GINPパス": "C:\\Users\\hallo\\AppData\\Local\\Programs\\GIMP 2\\bin\\gimp-2.10.exe"
}
```

### 4. **ボタン設定.json** - ノード定義

各ノードの処理番号と関数名のマッピング。

```json
[
  {
    "処理番号": "1-1",
    "関数名": "順次処理関数",
    "背景色": "White",
    "説明": "通常の順次処理"
  },
  {
    "処理番号": "1-2",
    "関数名": "条件分岐関数",
    "背景色": "SpringGreen",
    "説明": "if-else条件分岐"
  }
]
```

---

## 🏗️ アーキテクチャ

### システム構成

```
ユーザー
  ↓
ブラウザ（ui/index-legacy.html）
  React + React Flow
  ↓
REST API（adapter/api-server-v2-pode-complete.ps1）
  Pode HTTPサーバー（50エンドポイント）
  CONVERTED_ROUTES.ps1（ルート定義）
  ↓
ビジネスロジック（v2関数群）
  - 12_コード本文_v2.ps1
  - 08_ボタン処理_v2.ps1
  - 10_変数管理_v2.ps1
  - 07_ツールバー_v2.ps1
  - 02-6_削除_v2.ps1
  - 02-2_ネスト規制_v2.ps1
  - 17_操作履歴管理.ps1（Undo/Redo）
  ↓
データ層（JSON操作）
  - 09_コードID管理JSON.ps1
  - 00_JSON操作.ps1
```

### コード生成フロー

```
[1] ブラウザでノードを配置（React Flow）
     ↓
[2] POST /api/nodes → api-server-v2.ps1
     ↓
[3] ノード追加_v2() でmemory.jsonに保存
     ↓
[4] ノード設定ダイアログで処理内容を入力
     ↓
[5] PUT /api/nodes/:id → コード.jsonにスニペット保存
     ↓
[6] 「実行」ボタンをクリック
     ↓
[7] POST /api/execute/generate
     ├─ レイヤー1からノードをY座標順に取得
     ├─ 各ノードIDで「IDでエントリを取得」を呼び出し
     ├─ 特殊処理: 条件分岐のelse挿入
     └─ $outputに全コードを蓄積
     ↓
[8] output.ps1 に書き込み（UTF-8エンコーディング）
     ↓
[9] ブラウザで結果を表示
```

### 主要なAPIエンドポイント

| エンドポイント | メソッド | 用途 |
|--------------|---------|------|
| `/api/health` | GET | ヘルスチェック |
| `/api/nodes` | GET | 全ノード取得 |
| `/api/nodes` | POST | ノード追加 |
| `/api/nodes/:id` | PUT | ノード更新 |
| `/api/nodes/:id` | DELETE | ノード削除 |
| `/api/variables` | GET | 変数一覧取得 |
| `/api/execute/generate` | POST | コード生成 |
| `/api/execute/run` | POST | コード実行 |
| `/api/validate/nesting` | POST | ネスト規制チェック |
| `/api/history/status` | GET | Undo/Redo状態取得 |
| `/api/history/undo` | POST | Undo実行 |
| `/api/history/redo` | POST | Redo実行 |

---

## 🐛 既知の課題

### ⚠️ 未実装機能

- ノードのコピー/貼り付け
- ピンク選択の再利用機能（別ワークフローでの呼び出し）
- ドラッグ&ドロップでのノード順序変更の完全対応

### 🔍 既知の制限事項

- ブラウザのリロード時にセッション情報がリセットされる
- 大規模ワークフロー（100ノード以上）でのパフォーマンス未検証

---

## 🔧 開発者向け情報

### アーキテクチャレイヤー

- **フロントエンド**: `ui/` - React + React Flow
- **アダプター**: `adapter/` - REST API + 状態管理
- **ビジネスロジック**: `*_v2.ps1` - UI非依存関数
- **データ層**: `09_*.ps1`, `00_*.ps1` - JSON操作

### ファイル命名規則

- `adapter/*.ps1`: REST APIサーバーと状態管理
- `ui/*.{html,js,css}`: フロントエンドファイル
- `*_v2.ps1`: UI非依存のビジネスロジック（v2版）
- `00_～`: 共通ユーティリティ
- `09_～`: データ永続化・JSON操作
- `10_～15_`: 機能別モジュール

### コーディング規約

- **エンコーディング**: UTF-8 BOM（PowerShell）, UTF-8（HTML/JS）
- **関数命名**: 日本語（PowerShell）, camelCase（JavaScript）
- **インデント**: 4スペース（PowerShell）, 2スペース（JS）

### 重要な関数とエンドポイント

| 関数/エンドポイント | ファイル | 用途 |
|-------------------|----------|------|
| `POST /api/nodes` | CONVERTED_ROUTES.ps1 | ノード追加API |
| `ノード追加_v2` | 07_ツールバー_v2.ps1 | ノード追加処理 |
| `実行イベント_v2` | 08_ボタン処理_v2.ps1 | コード生成処理 |
| `IDでエントリを取得` | 09_コードID管理JSON.ps1 | コード取得 |
| `ネスト規制チェック_v2` | 02-2_ネスト規制_v2.ps1 | バリデーション |
| `Undo-Operation` | 17_操作履歴管理.ps1 | Undo実行 |
| `Redo-Operation` | 17_操作履歴管理.ps1 | Redo実行 |
| `Record-Operation` | 17_操作履歴管理.ps1 | 操作履歴記録 |

### デバッグ方法

1. **ブラウザのデベロッパーツール**
   - F12キーでコンソールを開く
   - Network タブでAPI通信を確認
   - Console タブでJavaScriptエラーを確認

2. **PowerShellコンソール**
   - `api-server-v2-pode-complete.ps1` の実行ログを確認
   - Write-Host によるデバッグ出力

3. **JSON内容を確認**
   ```powershell
   # 01_tools/01_JSON調整.ps1 を使用
   .\01_tools\01_JSON調整.ps1
   ```

4. **APIエンドポイントのテスト**
   ```powershell
   # PowerShellから直接APIを呼び出し
   Invoke-RestMethod -Uri "http://localhost:8080/api/health" -Method GET
   ```

---

## 📊 プロジェクト統計

- **総ファイル数**: 83ファイル（PowerShellスクリプト）
- **主要コード行数**: 約10,131行（PowerShell）
- **REST APIエンドポイント**: 38個（うちUndo/Redo関連: 6個）
- **主要言語**: PowerShell, JavaScript, HTML/CSS
- **対応プラットフォーム**: Windows 10/11
- **最大操作履歴保持数**: 50件（Undo/Redo）

---

## 🤝 コントリビューション

現在はプライベートプロジェクトとして開発中。

---

## 📝 ライセンス

未定

---

## 🔄 更新履歴

### 2025-11-19
- **Undo/Redo機能実装**（NEW! 重要機能）
  - 操作履歴管理システムの完全実装（`17_操作履歴管理.ps1` - 586行）
  - 最大50件の操作履歴を保持
  - ノード追加・削除・移動・設定変更に対応
  - `history.json` による永続化
  - REST API実装：
    - `GET /api/history/status` - Undo/Redo状態取得
    - `POST /api/history/undo` - Undo実行
    - `POST /api/history/redo` - Redo実行
  - UIにUndo/Redoボタンを追加（編集メニュー & ツールバー）
- **バグ修正**
  - memory.json再読み込み関数名の修正
  - Undo/Redo関数の戻り値問題を修正
  - 履歴API全エンドポイントのフォルダパス取得を修正
  - Pode Runspace分離問題を解決
- **ログ改善**
  - デバッグログの詳細化
  - LOG_CONFIGによるログ制御強化

### 2025-11-09
- **デザイン統合完了**
  - Glassmorphism → Neumorphism + Auroraへの完全移行
  - 立体的な影効果（ボタン、パネル）
  - Auroraグラデーション矢印エフェクト
  - 8色のグラデーション（紫、ピンク、シアン、緑など）
- **UI/UX改善**
  - ノード移動問題を解決
  - グロー矢印のposition問題を解決
  - カテゴリーボタンエリアの幅調整（140px）
  - 横スクロールバー問題の解決
- **パフォーマンス改善**
  - Canvas2D パフォーマンス警告の解消
  - 不要なログの削減

### 2025-11-16
- **Pode HTTPサーバーへ移行完了**
  - Polaris → Pode 2.11.0 への完全移行
  - REST APIエンドポイント拡張（50個）
  - CONVERTED_ROUTES.ps1 によるルート定義の分離
  - PowerShell 5.1環境での安定性向上

### 2025-11-02
- **アーキテクチャ移行完了**
  - Windows Forms → HTML/JS（React + React Flow）への完全移行
  - Polaris HTTPサーバー導入（26エンドポイント）
  - REST API実装完了
  - 旧Windows Formsファイルをarchiveに移動

### 2025-11-01
- **スナップショット機能追加**
  - 現在の状態をスナップショットとして保存
  - いつでもスナップショット作成時の状態に復元可能
  - 試行錯誤が安心してできる
- **フォルダ構造の整理**
  - 統一命名規則の導入（番号プレフィックス方式）
  - 全ファイルのパス参照を更新
- **UI非依存v2関数の作成**
  - 6個のv2ファイル作成（UI依存を排除）
  - ビジネスロジックの分離完了

### 2025-10-29
- ポータビリティ向上（ハードコードパス削除）
- 既知の問題5件を修正
- README.md作成
- SPEC.md（システム仕様書）作成

---

## 📧 お問い合わせ

プロジェクトに関する質問は、GitHubのIssuesからお願いします。
