# ノード作成ガイド

**UIpowershellの最大の強み：ノードを超簡単に追加できる**

WinActorでは新機能追加に開発費用がかかりますが、UIpowershellは**JSONファイル1つ + PowerShellファイル1つ**でノードを追加できます。

生成AI（Claude、ChatGPT等）にノード作成を依頼すれば、**5分で新機能を追加**できます。

---

## 目次

1. [ノード追加の仕組み](#1-ノード追加の仕組み)
2. [ボタン設定.json の構造](#2-ボタン設定json-の構造)
3. [PowerShellファイルの作成](#3-powershellファイルの作成)
4. [実装パターン](#4-実装パターン)
5. [AIでノードを作成する方法](#5-aiでノードを作成する方法)
6. [サンプル集](#6-サンプル集)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. ノード追加の仕組み

### 必要なファイル

ノードを追加するには、**2つのファイル**を編集/作成するだけです：

```
UIpowershell/
├── ボタン設定.json      ← ① ノード定義を追加
└── 00_code/
    └── {処理番号}.ps1   ← ② PowerShellコードを作成
```

### 追加手順

```
Step 1: ボタン設定.json にノード定義を追加
        ↓
Step 2: 00_code/{処理番号}.ps1 を作成
        ↓
Step 3: サーバー再起動（quick-start.ps1）
        ↓
Step 4: 完了！UIに新しいノードが表示される
```

---

## 2. ボタン設定.json の構造

### 基本構造

```json
{
    "処理番号": "11-1",
    "テキスト": "Slack通知",
    "ボタン名": "110",
    "背景色": "White",
    "コンテナ": "操作フレームパネル11",
    "説明": "Slackにメッセージを送信します。",
    "関数名": "11_1"
}
```

### フィールド説明

| フィールド | 必須 | 説明 | 例 |
|-----------|------|------|---|
| `処理番号` | ◎ | ノードの一意識別子（`{カテゴリ}-{番号}`形式） | `"11-1"` |
| `テキスト` | ◎ | UIに表示されるノード名 | `"Slack通知"` |
| `ボタン名` | ◎ | 内部識別用の番号 | `"110"` |
| `背景色` | ◎ | ノードの背景色（下記参照） | `"White"` |
| `コンテナ` | ◎ | 所属するパネル | `"操作フレームパネル11"` |
| `説明` | ○ | ノードの説明文 | `"Slackに..."` |
| `関数名` | ◎ | PowerShell関数名（処理番号の`-`を`_`に） | `"11_1"` |
| `パラメータ` | △ | 入力パラメータ（後述） | `[...]` |

### 背景色一覧

| 色 | 用途 |
|----|------|
| `White` | 通常の順次処理ノード |
| `SpringGreen` | 条件分岐（if-else） |
| `LemonChiffon` | ループ処理 |
| `Salmon` | 制御構造内の処理 |
| `LightBlue` | 外部連携系（推奨） |
| `LightPink` | スクリプト化ノード |

### パラメータ定義

ユーザー入力が必要な場合、`パラメータ`配列を追加します：

```json
{
    "処理番号": "11-1",
    "テキスト": "Slack通知",
    "関数名": "11_1",
    "パラメータ": [
        {
            "名前": "WebhookURL",
            "型": "text",
            "プレースホルダー": "https://hooks.slack.com/...",
            "必須": true
        },
        {
            "名前": "メッセージ",
            "型": "textarea",
            "プレースホルダー": "処理が完了しました",
            "必須": true,
            "行数": 3
        }
    ]
}
```

### パラメータの型

| 型 | 説明 | 追加オプション |
|----|------|---------------|
| `text` | 1行テキスト入力 | - |
| `number` | 数値入力 | `最小値`, `最大値` |
| `textarea` | 複数行テキスト | `行数` |

---

## 3. PowerShellファイルの作成

### ファイル名規則

```
00_code/{処理番号}.ps1

例：
- 処理番号 "11-1" → 00_code/11-1.ps1
- 処理番号 "99-1" → 00_code/99-1.ps1
```

### 関数名規則

```powershell
# 処理番号の "-" を "_" に置き換える
function 11_1 {
    # ここにコードを記述
}
```

### 戻り値

関数は**生成するPowerShellコード（文字列）**を返します：

```powershell
function 11_1 {
    return "Write-Host 'Hello World'"
}
```

実行時、この戻り値がoutput.ps1に書き込まれて実行されます。

---

## 4. 実装パターン

### パターン1: シンプルノード（固定コード）

パラメータなし、固定のコードを返すだけ。

**ボタン設定.json:**
```json
{
    "処理番号": "11-1",
    "テキスト": "Hello World表示",
    "背景色": "White",
    "関数名": "11_1"
}
```

**00_code/11-1.ps1:**
```powershell
function 11_1 {
@"
Write-Host "Hello World"
"@
}
```

---

### パターン2: パラメータ付きノード

UIからパラメータを受け取る。

**ボタン設定.json:**
```json
{
    "処理番号": "11-2",
    "テキスト": "メッセージ表示",
    "背景色": "White",
    "関数名": "11_2",
    "パラメータ": [
        {
            "名前": "メッセージ",
            "型": "text",
            "プレースホルダー": "こんにちは",
            "必須": true
        }
    ]
}
```

**00_code/11-2.ps1:**
```powershell
function 11_2 {
    param (
        [string]$メッセージ
    )

@"
Write-Host "$メッセージ"
"@
}
```

---

### パターン3: ダイアログ付きノード

PowerShellダイアログでユーザー入力を取得。

**00_code/11-3.ps1:**
```powershell
function 11_3 {
    # 数値入力ダイアログを表示
    $秒数 = 数値を入力 -フォームタイトル "待機時間" -ラベルテキスト "待機する秒数を入力:"

    if ($秒数 -ne $null) {
        return "Start-Sleep -Seconds $秒数"
    } else {
        return "# キャンセルされました"
    }
}
```

---

### パターン4: 複雑なノード（外部スクリプト連携）

外部のPowerShellスクリプトを読み込んで使用。

**00_code/11-4.ps1:**
```powershell
function 11_4 {
    # ルートパスを取得
    if ($script:RootDir) {
        $メインPath = $script:RootDir
    } else {
        $メインPath = Split-Path $PSScriptRoot
    }

    # 外部スクリプトを読み込み
    $helperPath = Join-Path $メインPath "helper.ps1"
    . $helperPath

    # ダイアログを表示
    $result = Show-CustomDialog

    return $result
}
```

---

## 5. AIでノードを作成する方法

### 基本プロンプト

以下のプロンプトをClaude/ChatGPTに送信するだけで、ノードを作成できます：

```
UIpowershellの新しいノードを作成してください。

【ノード名】Slack通知
【機能】指定したSlack WebhookにメッセージをPOSTする
【必要なパラメータ】
- WebhookURL（テキスト、必須）
- メッセージ（テキストエリア、必須）

以下の2つのファイルを出力してください：
1. ボタン設定.json に追加するJSONエントリ
2. 00_code/{処理番号}.ps1 のPowerShellコード
```

### AIが生成する出力例

**1. ボタン設定.json に追加:**
```json
{
    "処理番号": "11-1",
    "テキスト": "Slack通知",
    "ボタン名": "110",
    "背景色": "LightBlue",
    "コンテナ": "操作フレームパネル11",
    "説明": "Slackにメッセージを送信します。",
    "関数名": "11_1",
    "パラメータ": [
        {
            "名前": "WebhookURL",
            "型": "text",
            "プレースホルダー": "https://hooks.slack.com/services/...",
            "必須": true
        },
        {
            "名前": "メッセージ",
            "型": "textarea",
            "プレースホルダー": "処理が完了しました",
            "必須": true,
            "行数": 3
        }
    ]
}
```

**2. 00_code/11-1.ps1:**
```powershell
function 11_1 {
    param (
        [string]$WebhookURL,
        [string]$メッセージ
    )

@"
`$body = @{
    text = "$メッセージ"
} | ConvertTo-Json -Compress

Invoke-RestMethod -Uri "$WebhookURL" -Method Post -Body `$body -ContentType "application/json; charset=utf-8"
"@
}
```

### 追加手順

1. AIが生成したJSONを `ボタン設定.json` の配列に追加
2. AIが生成したPowerShellを `00_code/11-1.ps1` として保存
3. `quick-start.ps1` でサーバー再起動
4. 完了！

---

## 6. サンプル集

### サンプル1: ファイル存在確認ノード

```json
{
    "処理番号": "12-1",
    "テキスト": "ファイル存在確認",
    "背景色": "White",
    "関数名": "12_1",
    "パラメータ": [
        {
            "名前": "ファイルパス",
            "型": "text",
            "プレースホルダー": "C:\\data\\file.txt",
            "必須": true
        }
    ]
}
```

```powershell
function 12_1 {
    param ([string]$ファイルパス)

@"
if (Test-Path "$ファイルパス") {
    Write-Host "ファイルが存在します: $ファイルパス"
} else {
    Write-Host "ファイルが見つかりません: $ファイルパス"
}
"@
}
```

---

### サンプル2: Web API呼び出しノード

```json
{
    "処理番号": "12-2",
    "テキスト": "REST API呼び出し",
    "背景色": "LightBlue",
    "関数名": "12_2",
    "パラメータ": [
        {
            "名前": "URL",
            "型": "text",
            "プレースホルダー": "https://api.example.com/data",
            "必須": true
        },
        {
            "名前": "メソッド",
            "型": "text",
            "プレースホルダー": "GET",
            "必須": true
        }
    ]
}
```

```powershell
function 12_2 {
    param (
        [string]$URL,
        [string]$メソッド
    )

@"
`$response = Invoke-RestMethod -Uri "$URL" -Method $メソッド
Write-Host "API Response:"
`$response | ConvertTo-Json
"@
}
```

---

### サンプル3: フォルダ内ファイル一覧ノード

```json
{
    "処理番号": "12-3",
    "テキスト": "フォルダ内ファイル一覧",
    "背景色": "White",
    "関数名": "12_3",
    "パラメータ": [
        {
            "名前": "フォルダパス",
            "型": "text",
            "プレースホルダー": "C:\\data",
            "必須": true
        },
        {
            "名前": "拡張子フィルタ",
            "型": "text",
            "プレースホルダー": "*.xlsx",
            "必須": false
        }
    ]
}
```

```powershell
function 12_3 {
    param (
        [string]$フォルダパス,
        [string]$拡張子フィルタ = "*"
    )

    if ([string]::IsNullOrEmpty($拡張子フィルタ)) {
        $拡張子フィルタ = "*"
    }

@"
Get-ChildItem -Path "$フォルダパス" -Filter "$拡張子フィルタ" | ForEach-Object {
    Write-Host `$_.FullName
}
"@
}
```

---

### サンプル4: メール送信ノード（Gmail）

```json
{
    "処理番号": "12-4",
    "テキスト": "メール送信",
    "背景色": "LightBlue",
    "関数名": "12_4",
    "パラメータ": [
        {
            "名前": "宛先",
            "型": "text",
            "必須": true
        },
        {
            "名前": "件名",
            "型": "text",
            "必須": true
        },
        {
            "名前": "本文",
            "型": "textarea",
            "必須": true,
            "行数": 5
        }
    ]
}
```

```powershell
function 12_4 {
    param (
        [string]$宛先,
        [string]$件名,
        [string]$本文
    )

@"
`$smtpServer = "smtp.gmail.com"
`$smtpPort = 587
`$from = "your-email@gmail.com"
`$password = "your-app-password"

`$securePassword = ConvertTo-SecureString `$password -AsPlainText -Force
`$credential = New-Object System.Management.Automation.PSCredential (`$from, `$securePassword)

Send-MailMessage -From `$from -To "$宛先" -Subject "$件名" -Body "$本文" -SmtpServer `$smtpServer -Port `$smtpPort -UseSsl -Credential `$credential

Write-Host "メールを送信しました: $宛先"
"@
}
```

---

## 7. トラブルシューティング

### Q1: ノードがUIに表示されない

**確認事項:**
1. `ボタン設定.json` の構文エラーがないか（JSONバリデーター使用）
2. `処理番号` と `関数名` が正しく対応しているか
3. サーバーを再起動したか

### Q2: ノードをクリックしてもエラーになる

**確認事項:**
1. `00_code/{処理番号}.ps1` が存在するか
2. 関数名が正しいか（`11-1` → `function 11_1`）
3. PowerShellの構文エラーがないか

### Q3: パラメータが渡されない

**確認事項:**
1. JSONの `パラメータ.名前` と PowerShellの `param()` の変数名が一致しているか
2. 日本語変数名を使用する場合は `[string]$変数名` と型を明示

### Q4: 生成されたコードが正しく動かない

**確認事項:**
1. ヒアドキュメント内の変数は `` `$ `` でエスケープしているか
2. 文字列内の特殊文字が正しくエスケープされているか

---

## まとめ

```
┌─────────────────────────────────────────────────────┐
│  UIpowershellのノード追加は超簡単！                  │
│                                                     │
│  1. ボタン設定.json にエントリ追加                  │
│  2. 00_code/ にPowerShellファイル作成              │
│  3. サーバー再起動                                  │
│                                                     │
│  → AIに頼めば5分で新機能追加！                     │
│  → WinActorでは絶対にできない強み                  │
└─────────────────────────────────────────────────────┘
```

---

## 関連ドキュメント

- [汎用ダイアログ使用ガイド](./00_code/汎用ダイアログ使用ガイド.md) - ダイアログ関数の使い方
- [SPEC.md](./SPEC.md) - システム仕様書
- [ARCHITECTURE_OVERVIEW.md](./ARCHITECTURE_OVERVIEW.md) - アーキテクチャ概要
