# 移行中の並行運用戦略
# 既存版と新版を同時稼働させる方法

**質問**: 「原本のps1を残しておけば、htmlに移行中も機能の消失は防げる？」

**回答**: ⚠️ **単純に残すだけでは不十分ですが、適切な戦略で並行運用可能です**

---

## 📊 結論サマリー

| シナリオ | 可否 | 理由 |
|---------|-----|------|
| **単純にファイルを残すだけ** | ❌ 不可 | データ競合、エントリポイント衝突 |
| **段階的移行アプローチ** | ✅ 可能 | 開発環境と本番環境を分離 |
| **並行運用（データ分離）** | ✅ 可能 | JSONディレクトリを分ける |
| **A/Bテスト運用** | ✅ 可能 | ユーザーが選択して起動 |

---

## ❌ なぜ「単純に残すだけ」では不十分なのか？

### 問題1: エントリポイントの衝突

**既存版**:
```powershell
# 01_メインフォーム_メイン.ps1
# Windows Formsアプリを起動
$Global:メインフォーム.ShowDialog()
```

**新版**:
```bash
# npm start または tauri dev
# HTML/JSアプリを起動（別プロセス）
```

**問題点**:
- 両方を同時に起動すると、**2つのウィンドウが開く**
- どちらを使っているのか混乱する
- 同じデータ（JSON）を2つのプロセスが操作

---

### 問題2: データ競合（JSON同時アクセス）

**シナリオ**:
```
既存版: memory.json を読み込む
新版: memory.json を読み込む

既存版: ノードを追加 → memory.json を上書き保存
新版: ノードを追加 → memory.json を上書き保存  ← 既存版の変更が消える！
```

**結果**: データの不整合、作業内容の喪失

---

### 問題3: グローバル変数の衝突

```powershell
# 既存版と新版のPowerShellスクリプトを同時実行すると...
$global:レイヤー1 = ...  # 既存版
$global:レイヤー1 = ...  # 新版（上書きされる！）
```

---

## ✅ 正しい並行運用戦略

### 戦略1: **段階的移行（開発/本番分離）** ⭐⭐⭐⭐⭐ 推奨

**コンセプト**:
- 開発中は新版を別ディレクトリで開発
- 本番では既存版を使い続ける
- 新版が完成したら一括で切り替え

#### ディレクトリ構成

```
UIpowershell/                        ← 既存版（本番）
├── 01_メインフォーム_メイン.ps1      ← そのまま使用
├── 02-1_フォーム基礎構築.ps1         ← そのまま使用
├── 03_history/
│   └── AAAAAA111/
│       ├── memory.json               ← 既存版のデータ
│       └── コード.json
└── 実行.bat                          ← 既存版の起動スクリプト

UIpowershell_v2/                     ← 新版（開発中）
├── src/
│   ├── App.jsx                       ← 新版のUI
│   └── components/
├── adapter/
│   └── api-server.ps1                ← 新版のアダプター層
├── 09_変数機能_コードID管理JSON.ps1  ← 既存ファイルをコピー
├── 03_history_dev/                   ← 新版用のデータ（別ディレクトリ）
│   └── TEST001/
│       ├── memory.json
│       └── コード.json
├── package.json
└── tauri.conf.json
```

#### 運用フロー

```
┌─────────────────────────────────────────────┐
│ Phase 1: 開発期間（2-3ヶ月）                 │
│                                             │
│ 本番作業: 既存版（UIpowershell/）           │
│ ↓ 実行.bat で起動                            │
│ ↓ 通常業務を継続                             │
│                                             │
│ 開発作業: 新版（UIpowershell_v2/）          │
│ ↓ npm run dev で起動                         │
│ ↓ テスト・デバッグ                           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ Phase 2: ベータテスト期間（2-4週間）         │
│                                             │
│ 本番作業: 既存版（安全のため）               │
│                                             │
│ テスト: 新版で実際のワークフローを試験       │
│ ↓ データを既存版からコピー                  │
│ ↓ 不具合があれば既存版に戻る                │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ Phase 3: 本番移行（1日）                     │
│                                             │
│ 1. 既存版を archive/ に移動                  │
│ 2. 新版を UIpowershell/ にリネーム           │
│ 3. 新版で起動                                │
│                                             │
│ ロールバック可能:                            │
│ archive/ から既存版を復元すれば即座に戻せる │
└─────────────────────────────────────────────┘
```

#### メリット

✅ **機能の消失リスク: 0%**
- 既存版は一切触らない
- いつでも既存版で作業可能

✅ **データ競合リスク: 0%**
- 別ディレクトリで開発
- 本番データに影響なし

✅ **ロールバック可能**
- 新版に問題があれば即座に既存版に戻せる

#### デメリット

⚠️ ディスク容量が2倍必要（一時的）
⚠️ 新版のテストには既存データのコピーが必要

---

### 戦略2: **データディレクトリ分離（A/Bテスト方式）** ⭐⭐⭐⭐

**コンセプト**:
- 既存版と新版を同じディレクトリに共存
- JSONデータを別々のディレクトリに保存
- ユーザーが起動時にバージョンを選択

#### ディレクトリ構成

```
UIpowershell/
├── 【既存版】
│   ├── 01_メインフォーム_メイン.ps1
│   ├── 02-1_フォーム基礎構築.ps1
│   ├── ...
│   └── 実行_legacy.bat              ← 既存版起動スクリプト
│
├── 【新版】
│   ├── src/
│   ├── adapter/
│   └── 実行_new.bat                 ← 新版起動スクリプト
│
├── 【共通】
│   ├── 09_変数機能_コードID管理JSON.ps1  ← 両方から使用
│   ├── 00_共通ユーティリティ_JSON操作.ps1
│   └── ...
│
└── 03_history/
    ├── legacy/                      ← 既存版用データ
    │   └── AAAAAA111/
    │       ├── memory.json
    │       └── コード.json
    └── new/                         ← 新版用データ
        └── AAAAAA111/
            ├── memory.json
            └── コード.json
```

#### 起動スクリプト

**既存版: `実行_legacy.bat`**
```batch
@echo off
echo ===================================
echo UIpowershell 既存版 (Windows Forms)
echo ===================================

REM データディレクトリを legacy に設定
set DATA_DIR=legacy

REM 既存版を起動
powershell -ExecutionPolicy Bypass -File "%~dp001_メインフォーム_メイン.ps1"
```

**新版: `実行_new.bat`**
```batch
@echo off
echo ===================================
echo UIpowershell 新版 (HTML/JS)
echo ===================================

REM データディレクトリを new に設定
set DATA_DIR=new

REM アダプター層（PowerShell APIサーバー）を起動
start powershell -ExecutionPolicy Bypass -File "%~dp0adapter\api-server.ps1"

REM 1秒待機
timeout /t 1 /nobreak >nul

REM Tauri/Electronアプリを起動
npm run tauri dev
```

**選択メニュー: `実行.bat`**
```batch
@echo off
echo ===================================
echo UIpowershell 起動メニュー
echo ===================================
echo.
echo どちらのバージョンを起動しますか？
echo.
echo [1] 既存版（Windows Forms）- 安定版
echo [2] 新版（HTML/JS）- ベータ版
echo.
set /p choice="選択 (1 or 2): "

if "%choice%"=="1" (
    call 実行_legacy.bat
) else if "%choice%"=="2" (
    call 実行_new.bat
) else (
    echo 無効な選択です
    pause
)
```

#### データ分離の実装

**既存版の修正（軽微）**:
```powershell
# 09_変数機能_コードID管理JSON.ps1 の冒頭に追加

# 環境変数からデータディレクトリを取得
$dataDir = $env:DATA_DIR
if (-not $dataDir) {
    $dataDir = "legacy"  # デフォルトは既存版
}

# パスを動的に設定
$メインJSONパス = "$スクリプトディレクトリ\03_history\$dataDir\メイン.json"
```

**新版のアダプター層**:
```powershell
# adapter/api-server.ps1

# 環境変数からデータディレクトリを取得
$dataDir = $env:DATA_DIR
if (-not $dataDir) {
    $dataDir = "new"  # デフォルトは新版
}

# 既存の関数をインポート
. ".\09_変数機能_コードID管理JSON.ps1"

# データパスが自動的に new/ ディレクトリを参照
```

#### メリット

✅ **両バージョンを簡単に切り替え可能**
- バッチファイルを選ぶだけ

✅ **データ競合なし**
- 別ディレクトリに保存

✅ **ユーザーがベータテスト可能**
- 新版を試して、問題があれば既存版に戻る

✅ **段階的な移行**
- ユーザーが慣れてから新版に完全移行

#### デメリット

⚠️ 既存コードの軽微な修正が必要（データパス動的化）
⚠️ 2つのバージョンの保守が必要（一時的）

---

### 戦略3: **フィーチャーフラグ方式** ⭐⭐⭐

**コンセプト**:
- 設定ファイルでUI層を切り替え
- 同じビジネスロジックを両方で共有

#### 設定ファイル

```json
// config.json
{
  "ui_mode": "legacy",  // "legacy" または "new"
  "data_directory": "03_history",
  "enable_new_ui": false
}
```

#### エントリポイント

```powershell
# 00_起動スクリプト.ps1

# 設定を読み込み
$config = Get-Content "config.json" | ConvertFrom-Json

if ($config.ui_mode -eq "legacy") {
    # 既存版を起動
    . ".\01_メインフォーム_メイン.ps1"
} else {
    # 新版を起動
    Start-Process "npm" -ArgumentList "run", "tauri", "dev"
}
```

#### メリット

✅ **設定ファイルで簡単に切り替え**
✅ **ビジネスロジックの重複なし**

#### デメリット

⚠️ 実装が複雑
⚠️ 両方のUIを同時に保守する必要がある

---

## 🎯 推奨アプローチ

### **戦略1: 段階的移行（開発/本番分離）** を推奨 ⭐⭐⭐⭐⭐

**理由**:
1. **最もシンプル**（既存版は一切触らない）
2. **リスクが最小**（機能消失の可能性なし）
3. **ロールバック容易**（archive/から復元）
4. **データ競合なし**（別ディレクトリで開発）

---

## 📋 移行スケジュール例

### Phase 1: 開発期間（2-3ヶ月）

```
Week 1-4: アダプター層開発
  ├─ 既存版で通常業務を継続 ✅
  └─ 新版を UIpowershell_v2/ で開発

Week 5-8: フロントエンド開発
  ├─ 既存版で通常業務を継続 ✅
  └─ 新版のUI実装

Week 9-12: 統合・テスト
  ├─ 既存版で通常業務を継続 ✅
  ├─ 新版でテストワークフロー実行
  └─ バグ修正
```

**この期間中の機能消失: 0%** ← 既存版を使い続けるため

---

### Phase 2: ベータテスト（2-4週間）

```
Week 13-14: 内部テスト
  ├─ 既存版のデータを新版にコピー
  ├─ 新版で実際のワークフローを実行
  ├─ 問題があれば既存版に戻る ← すぐに戻せる！
  └─ バグレポート・修正

Week 15-16: 並行運用テスト
  ├─ 午前: 既存版で作業
  ├─ 午後: 新版で作業
  └─ パフォーマンス・安定性を比較
```

**この期間中の機能消失: 0%** ← いつでも既存版に戻せる

---

### Phase 3: 本番移行（1日）

```
移行日:
  09:00 - 既存版のバックアップ作成
  09:30 - 既存版を archive/ に移動
  10:00 - 新版を UIpowershell/ にリネーム
  10:30 - 新版で起動テスト
  11:00 - 実際のワークフローで動作確認
  12:00 - 移行完了 ✅

問題が発生した場合:
  - archive/ から既存版を復元（5分で完了）
  - 翌日以降に再移行
```

---

## 🛡️ リスク軽減策

### 1. バックアップ戦略

**自動バックアップスクリプト: `backup.bat`**
```batch
@echo off
set TIMESTAMP=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%
set TIMESTAMP=%TIMESTAMP: =0%

echo バックアップを作成中...
xcopy /E /I /Y "03_history" "03_history_backup_%TIMESTAMP%"
echo バックアップ完了: 03_history_backup_%TIMESTAMP%
pause
```

**移行前に必ず実行**:
```batch
call backup.bat
```

---

### 2. ロールバック手順書

**問題が発生した場合の復旧手順**:

```batch
REM Step 1: 新版を停止
taskkill /F /IM node.exe
taskkill /F /IM powershell.exe

REM Step 2: archive/ から既存版を復元
xcopy /E /I /Y "archive\*" ".\"

REM Step 3: 既存版を起動
call 実行.bat

REM 復旧完了！（所要時間: 5分）
```

---

### 3. データ整合性チェック

**移行前チェックスクリプト: `check-data.ps1`**
```powershell
# JSONファイルの整合性をチェック
$files = @(
    "03_history\AAAAAA111\memory.json",
    "03_history\AAAAAA111\コード.json"
)

foreach ($file in $files) {
    if (Test-Path $file) {
        try {
            $data = Get-Content $file | ConvertFrom-Json
            Write-Host "[OK] $file は正常です" -ForegroundColor Green
        } catch {
            Write-Host "[ERROR] $file が破損しています！" -ForegroundColor Red
        }
    } else {
        Write-Host "[WARN] $file が存在しません" -ForegroundColor Yellow
    }
}
```

**移行前に実行**:
```powershell
.\check-data.ps1
```

---

## 📊 並行運用のベストプラクティス

### ✅ DO（推奨）

1. **別ディレクトリで開発**
   - `UIpowershell/` (既存版)
   - `UIpowershell_v2/` (新版)

2. **バックアップを頻繁に取る**
   - 毎日自動バックアップ
   - 移行前に必ずバックアップ

3. **段階的にテスト**
   - 小規模ワークフローから開始
   - 徐々に複雑なワークフローに移行

4. **ロールバック計画を準備**
   - 復旧手順書を作成
   - テスト実行して所要時間を確認

---

### ❌ DON'T（非推奨）

1. **同じディレクトリで両方を起動しない**
   - データ競合のリスク

2. **既存版を削除しない（移行直後）**
   - 最低1ヶ月は archive/ に保管

3. **バックアップなしで移行しない**
   - データ損失のリスク

4. **一気に全ワークフローを移行しない**
   - 段階的に移行すべき

---

## 🎓 ユーザーへの案内

### 移行中の運用ガイド

**移行期間中（2-3ヶ月）**:
```
通常作業: 既存版を使用してください
↓ 実行.bat をダブルクリック
↓ これまで通り作業可能です

新版のテスト: 任意参加
↓ 実行_new.bat をダブルクリック
↓ 新しいUIを試せます（ベータ版）
↓ 問題があれば既存版に戻ってください
```

**移行後（1日〜）**:
```
新版が本番環境になります
↓ 実行.bat をダブルクリック
↓ 新しいUIで作業開始

問題が発生した場合:
↓ IT部門に連絡
↓ 5分で既存版に復旧可能
```

---

## 📝 FAQ

### Q1: 移行中に既存版が使えなくなることはありますか？

**A**: いいえ、**一切ありません**。

移行開発は別ディレクトリで行うため、既存版には影響しません。

---

### Q2: 新版で問題が発生したら既存版に戻せますか？

**A**: はい、**5分で復旧可能**です。

`archive/` から既存版を復元するだけです。

---

### Q3: 両方のバージョンを同時に起動できますか？

**A**: 技術的には可能ですが、**推奨しません**。

データ競合のリスクがあります。起動時にバージョンを選択してください。

---

### Q4: 既存版のデータを新版に移行するには？

**A**: **コピーするだけ**です。

```batch
xcopy /E /I /Y "03_history\legacy\*" "03_history\new\"
```

JSONファイルの互換性は保たれます。

---

### Q5: 移行作業中に本番データが失われる可能性は？

**A**: **0%**です（バックアップを取れば）。

- 既存版は一切触らない
- 開発は別ディレクトリ
- バックアップを毎日取る

---

## 🎯 結論

### 質問への最終回答

> **Q: 原本のps1を残しておけば、htmlに移行中も機能の消失は防げる？**

**A: ✅ はい、防げます！ただし正しい戦略が必要です**

| 方法 | 機能消失のリスク | 推奨度 |
|-----|----------------|--------|
| ❌ 単純にファイルを残すだけ | 高（データ競合） | ☆☆☆☆☆ |
| ✅ 段階的移行（別ディレクトリ） | **0%** | ⭐⭐⭐⭐⭐ |
| ✅ データディレクトリ分離 | 低 | ⭐⭐⭐⭐ |

### 推奨アプローチ

**段階的移行（開発/本番分離）**

```
UIpowershell/       ← 既存版（本番）- そのまま使用
UIpowershell_v2/    ← 新版（開発中）- 別ディレクトリで開発
```

**メリット**:
- ✅ 機能消失リスク: **0%**
- ✅ データ競合なし
- ✅ いつでもロールバック可能
- ✅ 既存版は一切修正不要

**移行期間: 2-3ヶ月**
- この間、既存版で通常業務を継続
- 新版が完成したら1日で切り替え
- 問題があれば5分で復旧

---

**Document Version**: 1.0
**Last Updated**: 2025-11-02
**Author**: Claude (AI Technical Assessor)
