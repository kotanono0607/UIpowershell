# スナップショット機能 使い方ガイド

## 概要

スナップショット機能は、試行錯誤する際に元の状態に簡単に戻せる機能です。
- **オートセーブはそのまま継続**: 安心してノードを配置できます
- **いつでも元に戻せる**: スナップショットを作成しておけば、気に入らない変更を破棄できます
- **将来的にUndo/Redoに拡張**: 現在の実装は将来のUndo/Redo機能の基盤となります

---

## 使い方

### 📸 基本的な使い方

```
1. ノードを配置している状態で「スナップショット」メニューをクリック
   ├→ 「📸 スナップショット」メニュー
   └→ 「📸 スナップショット作成」を選択

2. スナップショット作成完了のメッセージが表示される

3. 試しにノードを配置・移動・削除してみる
   └→ オートセーブは通常通り動作（memory.jsonに保存される）

4. 元に戻したい場合
   ├→ 「📸 スナップショット」メニュー
   ├→ 「↩️ スナップショットから復元」を選択
   ├→ 確認ダイアログで「はい」をクリック
   └→ スナップショット作成時の状態に戻る

5. 気に入った場合
   └→ 何もしない（そのまま使い続ける）
```

---

## ユースケース

### ケース1: 大きな変更を試す前に

```
現在の状態:
├─ ノード10個配置済み
└─ 動作確認済み

やりたいこと:
└─ 新しいループ構造を追加してみたい

手順:
1. 📸 スナップショット作成
2. ループノードを配置
3. 試しに実行してみる
4. 結果を確認
   ├─ うまくいった → そのまま使う
   └─ うまくいかなかった → ↩️ 復元
```

### ケース2: 複数のパターンを試したい

```
現在の状態:
└─ 基本的なワークフロー完成

やりたいこと:
└─ 条件分岐とループ、どちらが良いか試したい

手順:
1. 📸 スナップショット作成（パターンA保存）
2. 条件分岐で実装
3. 実行して確認
4. ↩️ 復元（元に戻す）
5. ループで実装
6. 実行して確認
7. どちらか良い方を選択
   ├─ 条件分岐が良い → もう一度 ↩️ 復元 → 条件分岐で実装
   └─ ループが良い → そのまま使う
```

### ケース3: 誤操作から復旧

```
現在の状態:
└─ 大量のノードを配置している最中

事故:
└─ 誤って大量のノードを削除してしまった

復旧手順:
1. 落ち着く
2. 📸 スナップショット → ↩️ 復元
3. 削除前の状態に戻る
```

---

## テスト手順

### テスト1: スナップショット作成

1. UIpowershellを起動
2. 適当なノードを2-3個配置
3. ツールバーの「📸 スナップショット」メニューをクリック
4. 「📸 スナップショット作成」を選択
5. ✅ 「スナップショット作成完了」メッセージが表示されることを確認
6. ✅ `個々の履歴/{フォルダ名}/memory_snapshot.json` が作成されていることを確認
7. ✅ `個々の履歴/{フォルダ名}/コード_snapshot.json` が作成されていることを確認
8. ✅ `個々の履歴/{フォルダ名}/snapshot_info.json` が作成されていることを確認

### テスト2: スナップショット復元（変更あり）

1. テスト1の続きから
2. 新しいノードを2個追加
3. 既存のノードを1個削除
4. 既存のノードを移動
5. ツールバーの「📸 スナップショット」メニューをクリック
6. 「↩️ スナップショットから復元」を選択
7. ✅ 確認ダイアログが表示されることを確認
8. 「はい」をクリック
9. ✅ 「復元完了」メッセージが表示されることを確認
10. ✅ テスト1の手順2で配置したノードのみが表示されることを確認
11. ✅ 追加したノードが消えていることを確認
12. ✅ 削除したノードが復元されていることを確認
13. ✅ 移動したノードが元の位置に戻っていることを確認

### テスト3: スナップショット復元（スナップショットなし）

1. UIpowershellを起動
2. 新しいフォルダを作成
3. ノードを配置せずに、「↩️ スナップショットから復元」を選択
4. ✅ 「スナップショットが存在しません」警告が表示されることを確認

### テスト4: スナップショット復元（キャンセル）

1. スナップショット作成済みの状態
2. ノードを変更
3. 「↩️ スナップショットから復元」を選択
4. 確認ダイアログで「いいえ」をクリック
5. ✅ 復元されず、変更が保持されていることを確認

### テスト5: 複数レイヤーでの動作

1. レイヤー1にノードを配置
2. スナップショット作成
3. レイヤー1のノードを変更
4. レイヤー2に移動してノードを配置
5. 復元を実行
6. ✅ レイヤー1が元の状態に戻ることを確認
7. ✅ レイヤー2の変更も元に戻ることを確認

---

## ファイル構造

スナップショット作成時に以下のファイルが作成されます：

```
個々の履歴/{フォルダ名}/
├── memory.json              # 現在の状態（オートセーブで更新される）
├── memory_snapshot.json     # スナップショット時の状態
├── コード.json              # 現在のコードスニペット
├── コード_snapshot.json     # スナップショット時のコードスニペット
└── snapshot_info.json       # スナップショット情報（作成日時等）
```

### snapshot_info.json の内容例

```json
{
  "作成日時": "2025/11/01 14:30:25",
  "説明": "スナップショット",
  "タイプ": "手動"
}
```

---

## 注意事項

### ⚠️ スナップショットは1つだけ

- 現在の実装では、スナップショットは1つしか保存できません
- 新しくスナップショットを作成すると、古いスナップショットは上書きされます
- 複数のスナップショットを保存したい場合は、手動で `memory_snapshot_backup.json` のようにファイルをコピーしてください

### ⚠️ variables.jsonは復元されない

- 現在のバージョンでは、`variables.json`（実行時変数）は復元されません
- 必要に応じて手動でバックアップしてください

### ⚠️ 異なるレイヤー間での復元

- スナップショット作成時とは異なるレイヤーにいる場合でも、復元は可能です
- 復元後、現在表示中のレイヤーのノードが再読み込みされます
- 他のレイヤーも復元されていますが、そのレイヤーに移動するまで表示されません

---

## トラブルシューティング

### Q: 復元ボタンを押しても何も変わらない

**A:** 以下を確認してください：
1. スナップショットを作成しましたか？
2. スナップショット作成後に実際にノードを変更しましたか？
3. 正しいワークフローフォルダにいますか？

### Q: 「UIリロードエラー」が表示される

**A:** 以下を確認してください：
1. `memory_snapshot.json` が壊れている可能性があります
2. 手動でファイルを編集した場合、JSON形式が正しいか確認してください
3. 問題が解決しない場合は、スナップショットファイルを削除して再作成してください

### Q: スナップショット作成時にエラーが出る

**A:** 以下を確認してください：
1. ワークフローフォルダが存在しますか？
2. ファイルへの書き込み権限がありますか？
3. ディスク容量は十分ですか？

---

## 将来の拡張: Undo/Redo

現在のスナップショット機能は、将来的に以下のUndo/Redo機能に拡張される予定です：

### 予定機能

```
操作履歴スタック:
├─ 操作1: ノード追加 (100-1)
├─ 操作2: ノード移動 (100-1, Y=20 → Y=50)
├─ 操作3: ノード削除 (101-1)
├─ 操作4: 条件分岐追加 (102-1, 102-2, 102-3)
└─ 操作5: ノード設定変更 (100-1, テキスト変更)
         ↑ 現在位置

Ctrl+Z (Undo) → 操作5を取り消す
Ctrl+Y (Redo) → 操作5をやり直す
```

### 実装予定の機能

- **Ctrl+Z**: 操作を1つ戻す
- **Ctrl+Y**: 操作を1つ進める
- **操作履歴表示**: 過去20件の操作履歴を表示
- **任意の時点に復元**: 履歴から任意の操作を選択して復元

### 現在の準備状況

`16_スナップショット機能.ps1` には、将来のUndo/Redo実装のためのコメントが含まれています：

```powershell
# 将来のUndo/Redo機能用の構造（現時点では未実装）
# グローバル変数（将来用）
# $global:操作履歴 = @()  # 操作履歴スタック
# $global:履歴位置 = 0    # 現在の履歴位置
```

これらのコメントは、将来の拡張時に参照されます。

---

## まとめ

スナップショット機能を使うことで：

✅ 試行錯誤が安心してできる
✅ 誤操作から簡単に復旧できる
✅ 複数のパターンを試して比較できる
✅ オートセーブの便利さはそのまま

ぜひ活用してください！
