# デバッグログ使用ガイド

## 目的
レイヤー2以降でスクリプト化したノードが、レイヤー移動後に展開しない問題を特定するため、詳細なデバッグログを追加しました。

## 影響を受けるファイル
- `02_メインフォームUI_foam関数.ps1`
  - `script:ボタンクリック情報表示` 関数（行1268-1409）
  - `PINKからボタン作成` 関数（行1429-1525）

## ログ出力内容

### 1. ボタンクリック時のログ（10段階）

#### [1] ノード基本情報
```
ボタン名: [ボタン名]
テキスト: [テキスト]
親パネル: [パネル名]
Tag.script: [スクリプト内容またはNull]
```

#### [2] 親レイヤー番号の取得
```
親パネル名: [パネル名]
抽出レイヤー番号: [番号]
```

#### [3] 次パネルの検証
```
次パネル名: [パネル名]
次パネル存在: True/False
次パネル可視: True/False
次パネル位置: X=[X座標], Y=[Y座標]
次パネルサイズ: Width=[幅], Height=[高さ]
```

#### [4] 現在の可視パネル状態
```
可視左パネル: [パネル名]
可視右パネル: [パネル名]
不可視右の右パネル: [パネル名]
```

#### [5] Pink選択配列の更新
```
更新前の配列サイズ: [サイズ]
更新前の値: [値のリスト]
更新後の配列サイズ: [サイズ]
更新後の値: [値のリスト]
```

#### [6] パネルのクリア
```
クリア対象: [パネル名]
クリア前のボタン数: [数]
クリア後のボタン数: [数]
```

#### [7] コードエントリの取得
```
取得成功: True/False
エントリ内容プレビュー: [最初の100文字]
エントリ総文字数: [文字数]
```
または
```
エラー: エントリが見つかりませんでした
```

#### [8] PINKからボタン作成
```
展開先パネル: [パネル名]
```

#### [9] レイヤー深度の更新
```
現在の深度: [深度]
増減: +1 または -1
更新後の深度: [深度]
```

#### [10] 矢印処理
```
矢印処理対象: [パネル名]
```

### 2. PINKからボタン作成のログ

```
========== [PINKからボタン作成] 開始 ==========
  展開先パネル名: [パネル名]
  展開先パネル位置: X=[X座標], Y=[Y座標]
  展開先パネル可視: True/False
  文字列プレビュー: [最初の100文字]
    作成: [ボタン名] [テキスト] (通常ボタン/中間ボタン) Y=[Y座標] 色=[色名]
    作成: [ボタン名] [テキスト] (通常ボタン/中間ボタン) Y=[Y座標] 色=[色名]
    ...
  合計作成ボタン数: [数]
  最終パネル内ボタン総数: [数]
  矢印処理を実行...
========== [PINKからボタン作成] 完了 ==========
```

## バグ再現手順とログ確認方法

### 1. テスト準備
1. PowerShellターミナルを開く
2. UIpowershellプロジェクトのディレクトリに移動
3. `.\01_メインフォーム_メイン.ps1` を実行

### 2. バグ再現手順
1. **レイヤー1でスクリプト化を作成**
   - レイヤー1でノードを複数配置
   - それらをスクリプト化（ピンク選択）
   - 正常に展開できることを確認

2. **レイヤー2以降でスクリプト化を作成**
   - レイヤー1のスクリプト化ノードをクリックしてレイヤー2へ移動
   - レイヤー2でノードを複数配置
   - それらをスクリプト化（ピンク選択）
   - 正常に展開できることを確認 ✅

3. **レイヤーを戻る**
   - 左矢印ボタンでレイヤー1に戻る

4. **再度レイヤー2のスクリプト化ノードをクリック**
   - レイヤー2のスクリプト化ノードをクリック
   - **ここで展開されない** ❌

### 3. ログの確認ポイント

バグが発生した際、以下の点をログから確認してください：

#### A. Tag.scriptは保持されているか？
```
[1] ノード基本情報:
    Tag.script: [値が表示されるか確認]
```
- ✅ 値がある → Tag.scriptは保持されている
- ❌ Nullまたは空 → Tag.scriptが失われている

#### B. 次パネルは正しく取得されているか？
```
[3] 次パネルの検証:
    次パネル存在: True
    次パネル可視: True
```
- ✅ 両方True → パネルは正常
- ❌ どちらかFalse → パネル取得に問題

#### C. Pink選択配列は更新されているか？
```
[5] Pink選択配列の更新:
    更新前の配列サイズ: [数]
    更新後の配列サイズ: [数]
```
- ✅ サイズが増加している → 正常に更新
- ❌ サイズが同じまたは減少 → 更新に失敗

#### D. コードエントリは取得できているか？
```
[7] コードエントリの取得:
    取得成功: True
    エントリ内容プレビュー: [内容]
```
- ✅ 取得成功 → コードエントリは正常
- ❌ エラー表示 → コードエントリが見つからない

#### E. ボタンは作成されているか？
```
[PINKからボタン作成] 開始
  合計作成ボタン数: [数]
```
- ✅ 0より大きい → ボタンは作成された
- ❌ 0 → ボタンが作成されていない

#### F. レイヤー深度は正しく更新されているか？
```
[9] レイヤー深度の更新:
    現在の深度: [数]
    更新後の深度: [数]
```
- ✅ 深度が増加している → 正常
- ❌ 深度が同じまたは減少 → 更新に失敗

## 予想される原因とログの対応関係

| 原因仮説 | 確認すべきログ | 期待される結果 | 異常時の結果 |
|---------|--------------|--------------|------------|
| Tag.scriptが失われている | [1] Tag.script | 値が表示される | Null/空 |
| Pink選択配列がクリアされていない | [5] 配列サイズ | レイヤー移動前：大きい値<br>移動後：0 | 移動後も大きい値のまま |
| 次パネルの取得失敗 | [3] 次パネル検証 | 存在:True, 可視:True | どちらかFalse |
| コードエントリが見つからない | [7] 取得成功 | True | False |
| ボタン作成の失敗 | [8] 作成ボタン数 | 0より大きい | 0 |

## ログ収集方法

1. PowerShellターミナルで実行
2. 上記「バグ再現手順」を実施
3. ターミナルに表示されるログをすべてコピー
4. テキストファイルに保存するか、直接確認

### ログを保存する場合
```powershell
# ログをファイルに出力しながら実行
.\01_メインフォーム_メイン.ps1 *>&1 | Tee-Object -FilePath "debug_log.txt"
```

## 次のステップ

1. ログを収集
2. 上記「ログの確認ポイント」A-Fを確認
3. どの段階で異常が発生しているか特定
4. 原因に応じた修正を実施

## 補足：正常時のログ例

正常にスクリプト化ノードが展開される場合、以下のような流れになります：

```
========== [ボタンクリック情報表示] 開始 ==========
[1] ノード基本情報:
    Tag.script: AAAA_235-1;SpringGreen;条件分岐 開始;...
[2] 親レイヤー番号: 1
[3] 次パネル検証: 存在:True, 可視:True
[4] 可視パネル: 可視左=フレームパネル0, 可視右=フレームパネル1
[5] Pink選択配列: サイズ 0 → 1
[6] パネルクリア: 3個 → 0個
[7] エントリ取得: 成功
[8] PINKからボタン作成: 開始
    作成: [235-1] 条件分岐 開始 Y=20
    作成: [237-1] 順次 Y=70
    ...
    合計: 7個
[9] レイヤー深度: 1 → 2
[10] 矢印処理完了
========== [ボタンクリック情報表示] 完了 ==========
```

## ログ削除方法

バグ修正後、デバッグログが不要になった場合は、以下のWrite-Host行を削除またはコメントアウトしてください：
- `02_メインフォームUI_foam関数.ps1` 行1268-1409のWrite-Host行
- `02_メインフォームUI_foam関数.ps1` 行1435-1524のWrite-Host行
