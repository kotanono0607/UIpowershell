<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIpowershell - Visual RPA Platform (Phase 4)</title>

    <!-- React Flow CSS -->
    <link rel="stylesheet" href="libs/reactflow.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ */
        nav {
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            padding: 0;
        }

        nav .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        nav .menu-item:hover {
            background: #3e3e42;
        }

        nav .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #3e3e42;
            min-width: 200px;
            z-index: 1000;
        }

        nav .menu-item:hover .menu-dropdown {
            display: block;
        }

        nav .menu-dropdown-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        nav .menu-dropdown-item:hover {
            background: #3e3e42;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        header {
            background: #252526;
            padding: 10px 20px;
            border-bottom: 2px solid #007acc;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        header h1 {
            font-size: 18px;
            margin-right: 20px;
            color: #007acc;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #005a9e;
        }

        button:active {
            background: #004578;
        }

        button.danger {
            background: #d32f2f;
        }

        button.danger:hover {
            background: #b71c1c;
        }

        button.success {
            background: #4caf50;
        }

        button.success:hover {
            background: #388e3c;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        #sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            padding: 20px;
            overflow-y: auto;
        }

        #sidebar h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #007acc;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .layer-item {
            background: #3e3e42;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .layer-item:hover {
            background: #4e4e52;
        }

        .layer-item.active {
            background: #007acc;
            font-weight: bold;
        }

        /* React Flowã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #flow-container {
            flex: 1;
            background: #1e1e1e;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        footer {
            background: #007acc;
            color: white;
            padding: 5px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #007acc;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            background: #3e3e42;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* å¤‰æ•°ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3e3e42;
        }

        table th {
            background: #3e3e42;
            color: #007acc;
        }

        table tr:hover {
            background: #3e3e42;
        }

        table button {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ React Flowãƒãƒ¼ãƒ‰ */
        .react-flow__node-default {
            background: #007acc;
            color: white;
            border: 2px solid #005a9e;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 12px;
            min-width: 120px;
            text-align: center;
        }

        .react-flow__node-default:hover {
            border-color: #ffffff;
        }

        .react-flow__node-default.selected {
            border-color: #ffeb3b;
            box-shadow: 0 0 10px #ffeb3b;
        }

        /* ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¥ã®è‰² */
        .node-conditional {
            background: #4caf50 !important;
            border-color: #388e3c !important;
        }

        .node-loop {
            background: #ffeb3b !important;
            border-color: #fbc02d !important;
            color: #000 !important;
        }

        .node-start,
        .node-end {
            background: #9e9e9e !important;
            border-color: #616161 !important;
        }

        .react-flow__edge-path {
            stroke: #007acc;
            stroke-width: 2;
        }

        .react-flow__edge.selected .react-flow__edge-path {
            stroke: #ffeb3b;
            stroke-width: 3;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º */
        .progress-container {
            background: #3e3e42;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #555;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ -->
        <nav>
            <div class="menu-item">
                ãƒ•ã‚¡ã‚¤ãƒ«
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="menuAction('file_new')">æ–°è¦</div>
                    <div class="menu-dropdown-item" onclick="menuAction('file_open')">é–‹ã</div>
                    <div class="menu-dropdown-item" onclick="menuAction('file_save')">ä¿å­˜</div>
                </div>
            </div>
            <div class="menu-item">
                ç·¨é›†
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="menuAction('edit_undo')">å…ƒã«æˆ»ã™</div>
                    <div class="menu-dropdown-item" onclick="menuAction('edit_redo')">ã‚„ã‚Šç›´ã—</div>
                </div>
            </div>
            <div class="menu-item">
                è¡¨ç¤º
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="menuAction('view_zoom_in')">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</div>
                    <div class="menu-dropdown-item" onclick="menuAction('view_zoom_out')">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ</div>
                    <div class="menu-dropdown-item" onclick="menuAction('view_fit')">å…¨ä½“è¡¨ç¤º</div>
                </div>
            </div>
        </nav>

        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <header>
            <h1>UIpowershell - Phase 4 <span id="app-version" style="font-size: 0.7em; color: #ccc; font-weight: normal;">v1.0.149</span></h1>
            <button onclick="showAddNodeModal()">â• ãƒãƒ¼ãƒ‰è¿½åŠ </button>
            <button onclick="deleteSelectedNodes()" class="danger">ğŸ—‘ï¸ å‰Šé™¤</button>
            <button id="btn-copy" onclick="copyNode(getSelectedNodeId())" title="é¸æŠã—ãŸãƒãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ (Ctrl+C)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button id="btn-paste" onclick="pasteNode()" title="ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ (Ctrl+V)">ğŸ“„ è²¼ã‚Šä»˜ã‘</button>
            <button id="btn-undo" onclick="undoOperation()" title="å…ƒã«æˆ»ã™ (Ctrl+Z)">â†¶ Undo</button>
            <button id="btn-redo" onclick="redoOperation()" title="ã‚„ã‚Šç›´ã— (Ctrl+Y)">â†· Redo</button>
            <button onclick="showVariableModal()">ğŸ“Š å¤‰æ•°ç®¡ç†</button>
            <button onclick="showFolderModal()">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€</button>
            <button onclick="generateCode()" class="success">â–¶ï¸ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
            <button onclick="testApiConnection()">ğŸ”Œ APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="main-container">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <aside id="sidebar">
                <div class="sidebar-section">
                    <h2>ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ</h2>
                    <div class="layer-item active" data-layer="1" onclick="switchLayer(1)">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 1</div>
                    <div class="layer-item" data-layer="2" onclick="switchLayer(2)">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 2</div>
                    <div class="layer-item" data-layer="3" onclick="switchLayer(3)">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 3</div>
                </div>

                <div class="sidebar-section">
                    <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</h2>
                    <div id="project-info" style="font-size: 12px; color: #cccccc;">
                        <p>ãƒ•ã‚©ãƒ«ãƒ€: æœªé¸æŠ</p>
                        <p>ãƒãƒ¼ãƒ‰æ•°: 0</p>
                    </div>
                </div>
            </aside>

            <!-- React Flowã‚­ãƒ£ãƒ³ãƒã‚¹ -->
            <div id="flow-container"></div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <footer>
            <span id="status-layer">ãƒ¬ã‚¤ãƒ¤ãƒ¼: 1</span>
            <span id="status-nodes">ãƒãƒ¼ãƒ‰æ•°: 0</span>
            <span id="status-api">API: æœªæ¥ç¶š</span>
            <span id="status-session">ã‚»ãƒƒã‚·ãƒ§ãƒ³: -</span>
        </footer>
    </div>

    <!-- ãƒãƒ¼ãƒ‰è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-add-node" class="modal">
        <div class="modal-content">
            <h2>æ–°ã—ã„ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ </h2>
            <form id="form-add-node" onsubmit="addNode(event)">
                <div class="form-group">
                    <label>ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—</label>
                    <select id="input-type" onchange="onNodeTypeChange()" required>
                        <option value="start">é–‹å§‹</option>
                        <option value="process">å‡¦ç†</option>
                        <option value="conditional">æ¡ä»¶åˆ†å²</option>
                        <option value="loop">ãƒ«ãƒ¼ãƒ—</option>
                        <option value="end">çµ‚äº†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ</label>
                    <input type="text" id="input-text" placeholder="ä¾‹: Excelã‚’é–‹ã" required>
                </div>

                <!-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰ -->
                <div id="node-params-container" style="display:none;">
                    <h3 style="font-size: 14px; margin-top: 15px; margin-bottom: 10px; color: #007acc;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                    <div id="node-params-inputs">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="form-group">
                    <label>ã‚³ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <textarea id="input-code" rows="4" placeholder="PowerShellã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›...ã¾ãŸã¯é–¢æ•°ãŒè‡ªå‹•ç”Ÿæˆã—ã¾ã™"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit">è¿½åŠ </button>
                    <button type="button" onclick="closeModal('modal-add-node')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¤‰æ•°ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-variables" class="modal">
        <div class="modal-content">
            <h2>å¤‰æ•°ç®¡ç†</h2>
            <button onclick="showAddVariableForm()">â• æ–°ã—ã„å¤‰æ•°ã‚’è¿½åŠ </button>
            <div id="variable-list-container">
                <p style="color: #888;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('modal-variables')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å¤‰æ•°è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="modal-add-variable" class="modal">
        <div class="modal-content">
            <h2>å¤‰æ•°ã‚’è¿½åŠ </h2>
            <form id="form-add-variable" onsubmit="addVariable(event)">
                <div class="form-group">
                    <label>å¤‰æ•°å</label>
                    <input type="text" id="var-name" placeholder="ä¾‹: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹" required>
                </div>
                <div class="form-group">
                    <label>å€¤</label>
                    <input type="text" id="var-value" placeholder="ä¾‹: C:\data\file.xlsx" required>
                </div>
                <div class="form-group">
                    <label>ã‚¿ã‚¤ãƒ—</label>
                    <select id="var-type">
                        <option value="å˜ä¸€å€¤">å˜ä¸€å€¤</option>
                        <option value="ä¸€æ¬¡å…ƒ">ä¸€æ¬¡å…ƒé…åˆ—</option>
                        <option value="äºŒæ¬¡å…ƒ">äºŒæ¬¡å…ƒé…åˆ—</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="submit">è¿½åŠ </button>
                    <button type="button" onclick="closeModal('modal-add-variable')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-folders" class="modal">
        <div class="modal-content">
            <h2>ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†</h2>
            <button onclick="showCreateFolderForm()">â• æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</button>
            <div id="folder-list-container">
                <p style="color: #888;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('modal-folders')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="modal-create-folder" class="modal">
        <div class="modal-content">
            <h2>ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</h2>
            <form id="form-create-folder" onsubmit="createFolder(event)">
                <div class="form-group">
                    <label>ãƒ•ã‚©ãƒ«ãƒ€å</label>
                    <input type="text" id="folder-name" placeholder="ä¾‹: Project1" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit">ä½œæˆ</button>
                    <button type="button" onclick="closeModal('modal-create-folder')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-generate" class="modal">
        <div class="modal-content">
            <h2>PowerShellã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h2>
            <div class="progress-container">
                <p id="generate-status">æº–å‚™ä¸­...</p>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="generate-progress" style="width: 0%"></div>
                </div>
            </div>
            <div id="generate-result" style="margin-top: 20px; display: none;">
                <h3 style="color: #4caf50;">âœ“ ç”ŸæˆæˆåŠŸ</h3>
                <p id="generate-output-path"></p>
                <p id="generate-node-count"></p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('modal-generate')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- æ¡ä»¶åˆ†å²ãƒ“ãƒ«ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="condition-builder-modal" class="modal">
        <div class="modal-content" style="width: 900px; max-height: 80vh; overflow-y: auto;">
            <h2>æ¡ä»¶å¼ã®è¨­å®š</h2>

            <div id="condition-items-container" style="margin-bottom: 20px;">
                <!-- æ¡ä»¶å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>

            <button id="btn-add-condition" class="button" style="margin-bottom: 20px;">æ¡ä»¶è¿½åŠ </button>

            <div style="margin-bottom: 20px;">
                <label>æ¡ä»¶å¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</label>
                <textarea id="condition-preview" readonly style="width: 100%; height: 120px; padding: 10px; font-family: monospace; background-color: #f5f5f5;"></textarea>
            </div>

            <div class="modal-buttons">
                <button id="btn-condition-save" class="button">ä¿å­˜</button>
                <button id="btn-condition-cancel" class="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒ—ãƒ“ãƒ«ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="loop-builder-modal" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80vh; overflow-y: auto;">
            <h2>ãƒ«ãƒ¼ãƒ—æ§‹æ–‡ã®è¨­å®š</h2>

            <div style="margin-bottom: 20px;">
                <label>ãƒ«ãƒ¼ãƒ—ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:</label>
                <select id="loop-type-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="for">å›ºå®šå›æ•°ãƒ«ãƒ¼ãƒ—</option>
                    <option value="foreach">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ—</option>
                    <option value="while">æ¡ä»¶ä»˜ããƒ«ãƒ¼ãƒ—</option>
                </select>
            </div>

            <div id="loop-settings-container" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px;">
                <!-- ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="margin-bottom: 20px;">
                <label>ãƒ«ãƒ¼ãƒ—æ§‹æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</label>
                <textarea id="loop-preview" readonly style="width: 100%; height: 120px; padding: 10px; font-family: monospace; background-color: #f5f5f5;"></textarea>
            </div>

            <div class="modal-buttons">
                <button id="btn-loop-save" class="button">ä¿å­˜</button>
                <button id="btn-loop-cancel" class="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- React, ReactDOM, React Flow -->
    <script crossorigin src="libs/react.production.min.js"></script>
    <script crossorigin src="libs/react-dom.production.min.js"></script>
    <script src="libs/reactflow.min.js"></script>

    <script src="app.js"></script>
</body>
</html>
