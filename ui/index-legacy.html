<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIpowershell - Visual RPA Platform (レイヤーナビゲーション)</title>
    <link rel="stylesheet" href="style-legacy.css?v=1.0.200">
    <link rel="icon" type="image/png" href="robo.png">
</head>
<body>
    <!-- ローディングオーバーレイ（サーバー接続待ち） -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">サーバーに接続中...</p>
            <p class="loading-subtext">しばらくお待ちください</p>
        </div>
    </div>

    <!-- ヘッダー: 40px -->
    <div id="header">
        <!-- メニューバー -->
        <div id="menubar">
            <div class="menu-item menu-brand">UIpowershell <span id="app-version">v1.2.4</span></div>
            <div class="menu-item menu-accent" onclick="executeCode()">▶ コード生成</div>
            <div class="menu-item menu-accent-light" onclick="openPartialExecuteDialog()">⏯ 部分実行</div>
            <div class="menu-item menu-danger" onclick="deleteAllNodes()">🗑 全削除</div>
            <div class="menu-item disabled" id="btn-undo" onclick="undoOperation()">⬅ Undo</div>
            <div class="menu-item disabled" id="btn-redo" onclick="redoOperation()">➡ Redo</div>
            <div class="menu-dropdown">
                <div class="menu-item">🧰 道具箱 ▼</div>
                <div class="menu-dropdown-content">
                    <div class="menu-dropdown-item" onclick="openVariableModal()">📊 変数</div>
                    <div class="menu-dropdown-item" onclick="folderManagement()">📁 フォルダ切替</div>
                    <div class="menu-dropdown-item" onclick="createSnapshot()">📸 スナップショット</div>
                    <div class="menu-dropdown-item" onclick="restoreSnapshot()">↩ 復元</div>
                </div>
            </div>
            <div class="menu-item" onclick="openDebugModal()">🐛 デバッグ</div>
            <div class="menu-item" onclick="openHelpModal()">❓ ヘルプ</div>
            <div class="menu-item menu-danger" onclick="exitApplication()">⏹ 終了</div>
        </div>

        <!-- ダークモード切り替え（Neumorphismデザインでは非対応のためコメントアウト）
        <button id="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="dark-mode-icon">🌙</span>
            <span id="dark-mode-text">ダーク</span>
        </button>
        -->

        <!-- ツールバー -->
        <div id="toolbar">
            <!-- ツールバーは空（メニューバーで操作） -->
        </div>
    </div>

    <!-- パンくずリスト -->
    <div class="breadcrumb-bar" id="breadcrumb">
        <div class="breadcrumb-item current" data-layer="1">
            📍 メインフロー
        </div>
    </div>

    <!-- メインコンテナ: 2ペイン構成（レイヤーナビゲーション） -->
    <div id="main-container">
        <!-- 左側：操作パネル（タブ式） -->
        <div id="left-panel">
            <!-- タブヘッダー -->
            <div id="left-panel-tabs">
                <div class="left-panel-tab active" data-tab="nodes" onclick="switchLeftPanelTab('nodes')">🧩 ノード</div>
                <div class="left-panel-tab" data-tab="functions" onclick="switchLeftPanelTab('functions')">🔷 関数</div>
                <div class="left-panel-tab" data-tab="variables" onclick="switchLeftPanelTab('variables')">📦 変数</div>
                <div class="left-panel-tab" data-tab="connection" onclick="switchLeftPanelTab('connection')">🔌 接続</div>
                <div class="left-panel-tab" data-tab="robot" onclick="switchLeftPanelTab('robot')">🤖 ロボット</div>
            </div>

            <!-- タブコンテンツ: ノード -->
            <div id="tab-content-nodes" class="left-panel-tab-content active">
                <!-- カテゴリー切り替えボタン（カテゴリ設定.jsonから動的生成） -->
                <div id="category-buttons">
                    <!-- カテゴリ設定.jsonから動的に生成 -->
                </div>

                <!-- ノード追加ボタンパネル（カテゴリ設定.jsonから動的生成） -->
                <div id="node-buttons-container">
                    <!-- カテゴリ設定.jsonから動的に生成 -->
                </div>
            </div>

            <!-- タブコンテンツ: 関数 -->
            <div id="tab-content-functions" class="left-panel-tab-content">
                <div class="functions-panel">
                    <!-- ヘッダー: インポートボタン -->
                    <div class="functions-header">
                        <span class="functions-title">関数一覧</span>
                        <button class="functions-import-btn" onclick="importFunction()">📥 インポート</button>
                    </div>

                    <!-- 検索ボックス -->
                    <div class="functions-search">
                        <input type="text" id="functions-search-input" placeholder="関数を検索..." oninput="filterFunctions(this.value)">
                    </div>

                    <!-- 関数リスト -->
                    <div class="functions-list" id="functions-list">
                        <!-- 動的に生成 -->
                        <div class="functions-empty-message" id="functions-empty-message">
                            関数がありません。<br>
                            ノードを選択して右クリック→「関数化」で作成できます。
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブコンテンツ: 変数 -->
            <div id="tab-content-variables" class="left-panel-tab-content">
                <div class="variables-panel">
                    <!-- ヘッダー: 追加ボタン -->
                    <div class="variables-header">
                        <span class="variables-title">変数一覧</span>
                        <button class="variables-add-btn" onclick="showVariableEditor(null)">＋ 追加</button>
                    </div>

                    <!-- 変数リスト -->
                    <div class="variables-list" id="variables-list">
                        <!-- 動的に生成 -->
                    </div>

                    <!-- 変数エディタ（モーダル風） -->
                    <div class="variable-editor" id="variable-editor" style="display: none;">
                        <div class="variable-editor-header">
                            <span id="variable-editor-title">変数を追加</span>
                            <button class="variable-editor-close" onclick="hideVariableEditor()">✕</button>
                        </div>
                        <div class="variable-editor-body">
                            <div class="variable-editor-field">
                                <label>変数名</label>
                                <input type="text" id="variable-name-input" placeholder="変数名を入力">
                            </div>
                            <div class="variable-editor-field">
                                <label>データ型</label>
                                <select id="variable-type-select" onchange="onVariableTypeChange()">
                                    <option value="単一値">単一値</option>
                                    <option value="一次元">一次元</option>
                                    <option value="二次元">二次元</option>
                                </select>
                            </div>
                            <!-- 単一値・一次元用テキストエリア -->
                            <div class="variable-editor-field" id="variable-value-field">
                                <label>値</label>
                                <textarea id="variable-value-input" placeholder="値を入力（一次元の場合は改行区切り）"></textarea>
                            </div>
                            <!-- 二次元用グリッドエディタ -->
                            <div class="variable-editor-field" id="variable-grid-field" style="display: none;">
                                <label>二次元配列</label>
                                <div class="grid-editor-controls">
                                    <button onclick="addGridRow()">＋行</button>
                                    <button onclick="addGridCol()">＋列</button>
                                    <button onclick="removeGridRow()">－行</button>
                                    <button onclick="removeGridCol()">－列</button>
                                </div>
                                <div class="grid-editor-container">
                                    <table class="grid-editor-table" id="grid-editor-table">
                                        <tbody id="grid-editor-body">
                                            <!-- 動的に生成 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="variable-editor-footer">
                            <button class="variable-editor-cancel" onclick="hideVariableEditor()">キャンセル</button>
                            <button class="variable-editor-save" onclick="saveVariable()">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブコンテンツ: 接続 -->
            <div id="tab-content-connection" class="left-panel-tab-content">
                <div class="connection-panel">
                    <!-- Excel接続セクション -->
                    <div class="connection-section">
                        <div class="connection-section-header">
                            <span class="connection-icon">📊</span>
                            <span class="connection-section-title">Excel接続</span>
                            <span class="connection-badge disconnected" id="excel-connection-badge">未接続</span>
                        </div>

                        <!-- ファイル選択 -->
                        <div class="connection-field">
                            <label>Excelファイル</label>
                            <div class="connection-file-input">
                                <input type="text" id="excel-file-path" placeholder="ファイルを選択..." readonly>
                                <button class="connection-browse-btn" onclick="browseExcelFile()">参照</button>
                            </div>
                        </div>

                        <!-- シート選択 -->
                        <div class="connection-field">
                            <label>シート</label>
                            <select id="excel-sheet-select" disabled>
                                <option value="">シートを選択...</option>
                            </select>
                        </div>

                        <!-- 変数名 -->
                        <div class="connection-field">
                            <label>変数名</label>
                            <input type="text" id="excel-variable-name" value="Excel2次元配列" placeholder="格納先の変数名">
                        </div>

                        <!-- 接続ボタン -->
                        <div class="connection-actions">
                            <button class="connection-btn connect" id="excel-connect-btn" onclick="connectExcel()" disabled>接続</button>
                            <button class="connection-btn disconnect" id="excel-disconnect-btn" onclick="disconnectExcel()" style="display:none">切断</button>
                        </div>

                        <!-- 接続情報 -->
                        <div class="connection-info" id="excel-connection-info" style="display:none">
                            <div class="connection-info-item">
                                <span class="info-label">行数:</span>
                                <span class="info-value" id="excel-row-count">-</span>
                            </div>
                            <div class="connection-info-item">
                                <span class="info-label">列数:</span>
                                <span class="info-value" id="excel-col-count">-</span>
                            </div>
                            <div class="connection-info-item">
                                <span class="info-label">ヘッダー:</span>
                                <span class="info-value" id="excel-headers">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 他の接続（将来拡張用） -->
                    <div class="connection-section disabled">
                        <div class="connection-section-header">
                            <span class="connection-icon">🌐</span>
                            <span class="connection-section-title">ブラウザ</span>
                            <span class="connection-badge disconnected">未対応</span>
                        </div>
                    </div>

                    <div class="connection-section disabled">
                        <div class="connection-section-header">
                            <span class="connection-icon">🗄️</span>
                            <span class="connection-section-title">データベース</span>
                            <span class="connection-badge disconnected">未対応</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブコンテンツ: ロボット -->
            <div id="tab-content-robot" class="left-panel-tab-content">
                <div class="robot-profile-card">
                    <!-- ロボット画像 -->
                    <div class="robot-avatar-section">
                        <div class="robot-avatar" id="robot-avatar" onclick="selectRobotImage()">
                            <img src="robo.png" class="robot-avatar-img" id="robot-avatar-img">
                            <div class="robot-avatar-overlay">
                                <span>📷</span>
                            </div>
                        </div>
                        <input type="file" id="robot-image-input" accept="image/*" style="display:none" onchange="updateRobotImage(this)">
                        <!-- 背景色選択 -->
                        <div class="robot-bgcolor-presets">
                            <div class="robot-bgcolor-circle selected" data-color="#e8f4fc" onclick="selectRobotBgColor(this)" style="background:#e8f4fc"></div>
                            <div class="robot-bgcolor-circle" data-color="#2196F3" onclick="selectRobotBgColor(this)" style="background:#2196F3"></div>
                            <div class="robot-bgcolor-circle" data-color="#4CAF50" onclick="selectRobotBgColor(this)" style="background:#4CAF50"></div>
                            <div class="robot-bgcolor-circle" data-color="#FF9800" onclick="selectRobotBgColor(this)" style="background:#FF9800"></div>
                            <div class="robot-bgcolor-circle" data-color="#E91E63" onclick="selectRobotBgColor(this)" style="background:#E91E63"></div>
                            <div class="robot-bgcolor-circle" data-color="#9C27B0" onclick="selectRobotBgColor(this)" style="background:#9C27B0"></div>
                            <div class="robot-bgcolor-circle" data-color="#607D8B" onclick="selectRobotBgColor(this)" style="background:#607D8B"></div>
                        </div>
                    </div>

                    <!-- 実行オプション -->
                    <div class="robot-options-section">
                        <label class="robot-option-item">
                            <input type="checkbox" id="robot-has-voice" checked>
                            <span>音声あり</span>
                        </label>
                        <label class="robot-option-item">
                            <input type="checkbox" id="robot-has-display" checked>
                            <span>表示あり</span>
                        </label>
                    </div>

                    <!-- ロボット情報 -->
                    <div class="robot-info-section">
                        <div class="robot-info-item">
                            <span class="robot-info-label">名前</span>
                            <input type="text" class="robot-info-input" id="robot-name" value="ロボくん" placeholder="ロボットの名前">
                        </div>
                        <div class="robot-info-item">
                            <span class="robot-info-label">作成者</span>
                            <input type="text" class="robot-info-input" id="robot-author" value="" placeholder="作成者名">
                        </div>
                        <div class="robot-info-item">
                            <span class="robot-info-label">役割</span>
                            <input type="text" class="robot-info-input" id="robot-role" value="" placeholder="このロボットの役割">
                        </div>
                        <div class="robot-info-item">
                            <span class="robot-info-label">ノード数</span>
                            <span class="robot-info-value" id="robot-node-count">0</span>
                        </div>
                        <div class="robot-info-item">
                            <span class="robot-info-label">バージョン</span>
                            <span class="robot-info-value" id="robot-version">1.0.0.0</span>
                        </div>
                        <div class="robot-info-item robot-memo-item">
                            <span class="robot-info-label">メモ</span>
                            <textarea class="robot-info-textarea" id="robot-memo" placeholder="メモを入力..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中央：左右2パネル表示（レイヤーナビゲーション） -->
        <div id="center-container">
            <!-- メインレイヤーパネル -->
            <div id="left-layer-panel" class="main-layer-panel">
                <div id="layer-0" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー0</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-1" class="layer-panel" style="display: block;">
                    <div class="layer-label">レイヤー1</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-2" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー2</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-3" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー3</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-4" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー4</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-5" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー5</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-6" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー6</div>
                    <div class="node-list-container"></div>
                </div>
            </div>

            <!-- ドリルダウンパネル（ピンクノードクリック時に表示） -->
            <div id="right-layer-panel" class="drilldown-panel empty">
                <!-- レイヤーコンテンツはここに動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 説明エリア（左下固定） -->
    <div id="description-panel">
        <div class="panel-label">説明</div>
        <div id="description-text">ここに説明文が表示されます。</div>
    </div>

    <!-- フッター: 28px -->
    <div id="hierarchy-path">
        📍 階層パス: <span id="path-text">レイヤー1</span>
    </div>

    <!-- ホバープレビュー -->
    <div class="hover-preview" id="hoverPreview">
        <div class="hover-preview-header">
            <span>🔍</span>
            <span id="previewTitle">プレビュー</span>
        </div>
        <div class="hover-preview-content" id="previewContent">
            <!-- 動的に生成 -->
        </div>
    </div>

    <!-- ESCキーヒント -->
    <div class="esc-hint" id="escHint">
        ESCキーで戻る
    </div>

    <!-- 右クリックメニュー（ノード用） -->
    <div id="context-menu" class="context-menu">
        <div id="layerize-menu-item" class="context-menu-item" onclick="layerizeNode()" style="background-color: pink; font-weight: bold; display: none;">📦 レイヤー化</div>
        <div id="functionize-menu-item" class="context-menu-item" onclick="functionizeNodes()" style="background-color: rgb(127, 255, 212); font-weight: bold; display: none;">🔷 関数化</div>
        <div class="context-menu-item" onclick="openNodeSettingsFromContextMenu()">⚙️ ノード設定</div>
        <div class="context-menu-item" onclick="renameNode()">✏️ 名前変更</div>
        <div class="context-menu-item" onclick="editScript()">📝 スクリプト編集</div>
        <div class="context-menu-item" onclick="executeScript()">▶️ スクリプト実行</div>
        <div class="context-menu-item" onclick="executeNodeCode()" style="color: #ff6600; font-weight: bold;">🔥 ノード発火</div>
        <div class="context-menu-item" onclick="toggleRedBorder()">🔴 レイヤー化対象に追加/解除</div>
        <div class="context-menu-item" onclick="applyRedBorderToGroup()">🔴 同グループを一括選択</div>
        <div class="context-menu-separator"></div>
        <div id="groupize-menu-item" class="context-menu-item" onclick="groupizeNodes()" style="background-color: rgb(255, 230, 180); font-weight: bold; display: none;">📁 グループ化</div>
        <div id="ungroup-menu-item" class="context-menu-item" onclick="ungroupNodes()" style="display: none;">📂 グループ解除</div>
        <div id="toggle-group-menu-item" class="context-menu-item" onclick="toggleGroupCollapse()" style="display: none;">🔽 グループ折りたたみ/展開</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="copyNodeFromContextMenu()">📋 コピー</div>
        <div class="context-menu-item" onclick="pasteNodeFromContextMenu()">📄 貼り付け</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteNode()">🗑️ 削除</div>
    </div>

    <!-- 右クリックメニュー（ボード用） -->
    <div id="board-context-menu" class="context-menu">
        <div class="context-menu-item" onclick="pasteNodeFromBoardMenu()">📄 貼り付け</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="clearAllRedBorders()">🔲 選択を全て解除</div>
    </div>

    <!-- 変数管理モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    変数管理UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/variables/manage
    - PowerShell関数: 変数管理を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: openVariableModal()を修正してAPI呼び出しに変更
    - 追加・編集・削除すべての操作をPowerShell Windows Formsダイアログ内で実行
    -->

    <!-- フォルダ切替モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    フォルダ切替UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/folders/switch-dialog
    - PowerShell関数: フォルダ切替を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: switchFolder()を修正してAPI呼び出しに変更
    - フォルダ選択と新規作成を統合ダイアログ内で実行
    - ListBoxダブルクリックで即座に選択可能
    -->

    <!-- スクリプト編集モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    スクリプト編集UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/node/edit-script
    - PowerShell関数: 複数行テキストを編集 (13_コードサブ汎用関数.ps1)
    - JavaScript: editScript()を修正してAPI呼び出しに変更

    理由:
    - 他のパラメータ入力UI（条件分岐、ループ等）との一貫性向上
    - コードの統一化によるメンテナンス性向上
    -->

    <!-- ノード詳細設定モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    ノード設定UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/node/settings
    - PowerShell関数: ノード設定を編集 (13_コードサブ汎用関数.ps1)
    - JavaScript: openNodeSettings()を修正してAPI呼び出しに変更
    - カスタムフィールド（条件分岐、ループ）も含めて完全移行
    -->

    <!-- コード生成結果モーダル -->
    <!-- コード結果モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    コード結果UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/code-result/show
    - PowerShell関数: コード結果を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: executeCode()を修正してコード生成後にAPI呼び出しを追加
    - リサイズ可能なダイアログ（900x700、最小700x500）
    - Consolasフォントでコードプレビュー表示
    - コピーボタン（クリップボードにコピー）
    - ファイルを開くボタン（Start-Processで開く）
    -->

    <!-- ============================================ -->
    <!-- 条件分岐・ループダイアログ (廃止) -->
    <!-- ============================================ -->
    <!--
    [移行完了] 2025-11-15
    条件分岐・ループの編集UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - 条件分岐: ShowConditionBuilder → 1_2 (00_code/1-2.ps1)
    - ループ: ShowLoopBuilder → 1_3 (00_code/1-3.ps1)

    理由:
    - 他のパラメータ入力UI (3-1.ps1, 5-1.ps1, 1-8.ps1など) との一貫性向上
    - コードの統一化によるメンテナンス性向上

    以下のモーダルダイアログは使用されなくなりました:
    - condition-builder-modal
    - loop-builder-modal
    -->

    <!-- レイヤー詳細モーダル -->
    <div id="layer-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">📋</span>
                    <span id="modal-layer-title">レイヤー詳細</span>
                    <span id="modal-parent-info" class="modal-parent-badge"></span>
                </div>
                <button class="modal-close-btn" onclick="closeLayerDetailModal()">✕</button>
            </div>
            <div class="modal-content">
                <div class="layer-panel">
                    <div class="layer-label" id="modal-layer-label">レイヤー読み込み中...</div>
                    <div class="modal-node-container" id="modal-node-container">
                        <canvas id="modal-arrow-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 関数エディタモーダル -->
    <div id="function-editor-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container function-editor-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">🔷</span>
                    <span>関数の編集</span>
                </div>
                <button class="modal-close-btn" onclick="closeFunctionEditor()">✕</button>
            </div>
            <div class="modal-content function-editor-content">
                <!-- 関数名編集 -->
                <div class="function-editor-name-section">
                    <label>関数名:</label>
                    <input type="text" id="function-editor-name" placeholder="関数名を入力">
                </div>

                <!-- ノード一覧 -->
                <div class="function-editor-nodes-section">
                    <div class="function-editor-nodes-header">
                        <span>ノード一覧</span>
                        <span id="function-editor-node-count" class="node-count-badge">0個</span>
                    </div>
                    <div class="function-editor-nodes-list" id="function-editor-nodes-list">
                        <!-- 動的に生成 -->
                    </div>
                    <button class="function-editor-add-btn" onclick="addNodeToFunction()">＋ ノード追加</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="function-editor-save-btn" onclick="saveFunctionEdits()">保存</button>
                <button class="function-editor-cancel-btn" onclick="closeFunctionEditor()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- ノード選択パレットダイアログ（関数エディタ用） -->
    <div id="node-palette-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container node-palette-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">📦</span>
                    <span>ノードを選択</span>
                </div>
                <button class="modal-close-btn" onclick="closeNodePalette()">✕</button>
            </div>
            <div class="modal-content node-palette-content">
                <div class="node-palette-buttons" id="node-palette-buttons">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- ヘルプモーダル -->
    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container help-modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">❓</span>
                    <span>ヘルプ - UIpowershell の使い方</span>
                </div>
                <button class="modal-close-btn" onclick="closeHelpModal()">✕</button>
            </div>
            <div class="modal-content help-modal-content">
                <div class="help-section">
                    <h3>📌 基本操作</h3>
                    <ul>
                        <li><strong>ノードの追加:</strong> 左パネルの「ノード」タブからカテゴリを選択し、ノードボタンをクリック</li>
                        <li><strong>ノードの接続:</strong> ノードをドラッグして並べ替え、自動的に矢印で接続されます</li>
                        <li><strong>ノードの編集:</strong> ノードをダブルクリックでスクリプトを編集</li>
                        <li><strong>ノードの削除:</strong> ノードを選択して Delete キーまたは右クリックメニュー</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>▶ コード生成・実行</h3>
                    <ul>
                        <li><strong>コード生成:</strong> メニューの「▶ コード生成」をクリックでPowerShellスクリプトを生成・実行</li>
                        <li><strong>部分実行:</strong> 特定のノードだけを実行したい場合は「⏯ 部分実行」を使用</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>🔷 関数機能</h3>
                    <ul>
                        <li><strong>関数化:</strong> 複数ノードを選択して右クリック→「関数化」で再利用可能な関数を作成</li>
                        <li><strong>関数の編集:</strong> 左パネル「関数」タブから関数を選択し「✏ 編集」ボタン</li>
                        <li><strong>関数の使用:</strong> 関数リストの「＋ 追加」ボタンでボードに配置</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>📦 変数機能</h3>
                    <ul>
                        <li><strong>変数の追加:</strong> 左パネル「変数」タブで「＋ 追加」ボタン</li>
                        <li><strong>データ型:</strong> 単一値、一次元配列、二次元配列をサポート</li>
                        <li><strong>変数の使用:</strong> スクリプト内で <code>$変数名</code> として参照</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>🧰 道具箱メニュー</h3>
                    <ul>
                        <li><strong>変数:</strong> 変数モーダルを開く</li>
                        <li><strong>フォルダ切替:</strong> 作業フォルダを変更</li>
                        <li><strong>スナップショット:</strong> 現在の状態を保存</li>
                        <li><strong>復元:</strong> 保存した状態を復元</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>⬅➡ Undo/Redo</h3>
                    <ul>
                        <li><strong>Undo:</strong> 直前の操作を取り消し</li>
                        <li><strong>Redo:</strong> 取り消した操作をやり直し</li>
                        <li><strong>ショートカット:</strong> Ctrl+Z (Undo) / Ctrl+Y (Redo)</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>🎨 ノードの色について</h3>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: #555;">
                        ノードの色は、その役割や状態を示しています。
                    </p>
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #444;">動作タイプによる色分け</h4>
                    <div class="help-color-list">
                        <div class="help-color-item"><span class="help-color-box" style="background: rgb(255, 220, 180);"></span><strong>薄オレンジ</strong> - アクション系（外部に変化を与える操作）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: rgb(200, 230, 250);"></span><strong>薄シアン</strong> - 読み込み・取得系（外部から情報を取得）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: white; border: 1px solid #999;"></span><strong>白 (White)</strong> - その他（ダイアログ、内部処理、待機など）</div>
                    </div>
                    <h4 style="margin: 16px 0 8px 0; font-size: 14px; color: #444;">特殊なノードの色</h4>
                    <div class="help-color-list">
                        <div class="help-color-item"><span class="help-color-box" style="background: springgreen;"></span><strong>黄緑 (SpringGreen)</strong> - 条件分岐の開始/終了ノード</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: gray;"></span><strong>灰色 (Gray)</strong> - 条件分岐の中間ノード（ElseIf等）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: salmon;"></span><strong>サーモン (Salmon)</strong> - 条件分岐のFalse側（Else分岐）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: rgb(200, 220, 255);"></span><strong>水色 (LightBlue)</strong> - 条件分岐のTrue側（If分岐）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: lemonchiffon;"></span><strong>レモン色 (LemonChiffon)</strong> - ループの開始/終了ノード</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: pink;"></span><strong>ピンク (Pink)</strong> - スクリプト化ノード（レイヤー化で作成）</div>
                        <div class="help-color-item"><span class="help-color-box" style="background: aquamarine;"></span><strong>アクアマリン (Aquamarine)</strong> - 関数ノード</div>
                    </div>
                    <p style="margin: 12px 0 0 0; font-size: 13px; color: #666;">
                        ※ 条件分岐内に配置したノードは自動的にSalmon（False側）またはLightBlue（True側）に色が変わります。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- arrow-drawing.jsの内容はapp-legacy.jsに統合されました -->
    <script src="app-legacy.js?v=1.1.0"></script>
    <!-- Aurora Arrow Patch: Neumorphism + Auroraデザインのグラデーション矢印 -->
    <script src="arrow-patch-hybrid.js?v=1.0.0"></script>
    <!-- レイヤー詳細モーダル機能 -->
    <script>
// ============================================
// レイヤー詳細モーダル（window.open の代替）
// ============================================

let modalCurrentLayer = null;
let modalCurrentNodes = [];

function showLayerDetailModal(layer, nodes, parentNode) {
    console.log(`[モーダル] === showLayerDetailModal 呼び出し ===`);
    console.log(`[モーダル] レイヤー: ${layer}, ノード数: ${nodes.length}`);
    console.log(`[モーダル] ノードデータ:`, nodes);

    modalCurrentLayer = layer;
    modalCurrentNodes = nodes;

    // モーダル要素を取得
    const modal = document.getElementById('layer-detail-modal');
    const layerTitle = document.getElementById('modal-layer-title');
    const layerLabel = document.getElementById('modal-layer-label');
    const parentInfo = document.getElementById('modal-parent-info');
    const container = document.getElementById('modal-node-container');

    console.log(`[モーダル] DOM要素チェック:`);
    console.log(`[モーダル]   - modal: ${modal ? '✓' : '✗'}`);
    console.log(`[モーダル]   - layerTitle: ${layerTitle ? '✓' : '✗'}`);
    console.log(`[モーダル]   - container: ${container ? '✓' : '✗'}`);

    // タイトル設定
    if (layerTitle) {
        layerTitle.textContent = `レイヤー${layer} 詳細`;
    }

    if (layerLabel) {
        layerLabel.textContent = `レイヤー${layer}`;
    }

    // 親ノード情報
    if (parentInfo && parentNode) {
        parentInfo.textContent = `親: ${parentNode.text || parentNode.id}`;
        parentInfo.style.display = 'inline-block';
    } else if (parentInfo) {
        parentInfo.style.display = 'none';
    }

    // コンテナをクリア（Canvasは残す）
    if (container) {
        console.log(`[モーダル] コンテナをクリアしてノードを描画開始`);
        const canvas = document.getElementById('modal-arrow-canvas');
        container.innerHTML = '';
        if (canvas) {
            container.appendChild(canvas);
        }

        // ノードを描画
        console.log(`[モーダル] ${nodes.length}個のノードを描画中...`);
        nodes.forEach((node, index) => {
            console.log(`[モーダル] ノード${index + 1}: text="${node.text}", x=${node.x}, y=${node.y}, color=${node.color}`);
            const btn = document.createElement('div');
            btn.className = 'node-button';

            // テキストの省略表示（20文字以上は省略）
            const displayText = node.text.length > 20 ? node.text.substring(0, 20) + '...' : node.text;
            btn.textContent = displayText;

            // 位置とサイズ設定
            btn.style.position = 'absolute';
            btn.style.left = `${node.x || 90}px`;
            btn.style.top = `${node.y || 10}px`;
            btn.style.width = `${node.width || 120}px`;
            btn.style.height = `${node.height || 40}px`;
            btn.style.backgroundColor = node.color || 'white';

            // 赤枠
            if (node.redBorder) {
                btn.style.border = '3px solid red';
            }

            // モーダル内のノードはクリック不可にする
            btn.style.cursor = 'default';
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`[モーダル] ノードクリック（読み取り専用）: ${node.text}`);
            };

            container.appendChild(btn);
            console.log(`[モーダル] ノード${index + 1}をコンテナに追加: ${btn.textContent}`);
        });

        console.log(`[モーダル] コンテナの子要素数: ${container.children.length}`);

        // Canvas初期化と矢印描画
        setTimeout(() => {
            console.log(`[モーダル] Canvas初期化と矢印描画を開始`);
            initializeModalCanvas();
            drawModalArrows(nodes);
        }, 100);
    } else {
        console.error(`[モーダル] エラー: containerが見つかりません！`);
    }

    // モーダル表示
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 背景スクロール防止
    }

    console.log(`[モーダル] レイヤー${layer}に${nodes.length}個のノード表示完了`);
}

function closeLayerDetailModal() {
    console.log('[モーダル] モーダルを閉じます');

    const modal = document.getElementById('layer-detail-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // 背景スクロール復元
    }

    modalCurrentLayer = null;
    modalCurrentNodes = [];
}

function initializeModalCanvas() {
    const canvas = document.getElementById('modal-arrow-canvas');
    const container = document.getElementById('modal-node-container');

    if (!canvas || !container) {
        console.warn('[モーダル] CanvasまたはContainerが見つかりません');
        return;
    }

    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    console.log(`[モーダル] Canvas初期化: ${canvas.width}x${canvas.height}`);
}

function drawModalArrows(nodes) {
    const canvas = document.getElementById('modal-arrow-canvas');
    if (!canvas) {
        console.warn('[モーダル] Canvasが見つかりません');
        return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('[モーダル] Canvas 2Dコンテキストの取得に失敗');
        return;
    }

    // Canvasをクリア
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ノードをY座標でソート
    const sortedNodes = [...nodes].sort((a, b) => (a.y || 0) - (b.y || 0));

    // ノード間に矢印を描画
    for (let i = 0; i < sortedNodes.length - 1; i++) {
        const fromNode = sortedNodes[i];
        const toNode = sortedNodes[i + 1];

        const fromX = fromNode.x + (fromNode.width / 2);
        const fromY = fromNode.y + fromNode.height;
        const toX = toNode.x + (toNode.width / 2);
        const toY = toNode.y;

        // Auroraグラデーション矢印
        const gradient = ctx.createLinearGradient(fromX, fromY, toX, toY);
        gradient.addColorStop(0.0, '#667eea');
        gradient.addColorStop(0.25, '#f472b6');
        gradient.addColorStop(0.5, '#06b6d4');
        gradient.addColorStop(0.75, '#10b981');
        gradient.addColorStop(1.0, '#fbbf24');

        ctx.strokeStyle = gradient;
        ctx.lineWidth = 3;
        ctx.setLineDash([]);

        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.stroke();
    }

    console.log(`[モーダル] ${sortedNodes.length - 1}本の矢印を描画`);
}

// オーバーレイクリックで閉じる
document.addEventListener('click', (e) => {
    const modal = document.getElementById('layer-detail-modal');
    if (modal && e.target === modal) {
        closeLayerDetailModal();
    }
});

// Escapeキーで閉じる
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('layer-detail-modal');
        if (modal && modal.style.display === 'flex') {
            closeLayerDetailModal();
        }
    }
});
    </script>
</body>
</html>
