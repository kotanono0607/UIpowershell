<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIpowershell - Visual RPA Platform (レイヤーナビゲーション)</title>
    <link rel="stylesheet" href="style-legacy.css?v=1.0.200">
</head>
<body>
    <!-- ヘッダー: 40px -->
    <div id="header">
        <!-- メニューバー -->
        <div id="menubar">
            <div class="menu-item" style="font-weight: bold; color: #007acc; cursor: default;">UIpowershell <span id="app-version" style="font-size: 0.85em; color: #666;">v1.0.234</span></div>
            <div class="menu-item" onclick="executeCode()">実行</div>
            <div class="menu-item" onclick="openVariableModal()">変数</div>
            <div class="menu-item" onclick="createFolder()">フォルダ作成</div>
            <div class="menu-item" onclick="switchFolder()">フォルダ切替</div>
            <div class="menu-item" onclick="deleteAllNodes()" style="color: #dc3545;">🗑️ 全削除</div>
            <div class="menu-item" onclick="createSnapshot()">📸 スナップショット</div>
            <div class="menu-item" onclick="restoreSnapshot()">↩️ 復元</div>
        </div>

        <!-- ダークモード切り替え（Neumorphismデザインでは非対応のためコメントアウト）
        <button id="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="dark-mode-icon">🌙</span>
            <span id="dark-mode-text">ダーク</span>
        </button>
        -->

        <!-- ツールバー -->
        <div id="toolbar">
            <!-- ツールバーは空（メニューバーで操作） -->
        </div>
    </div>

    <!-- パンくずリスト -->
    <div class="breadcrumb-bar" id="breadcrumb">
        <div class="breadcrumb-item current" data-layer="1">
            📍 メインフロー
        </div>
    </div>

    <!-- メインコンテナ: 2ペイン構成（レイヤーナビゲーション） -->
    <div id="main-container">
        <!-- 左側：操作パネル（10カテゴリー切り替え） -->
        <div id="left-panel">
            <!-- カテゴリー切り替えボタン -->
            <div id="category-buttons">
                <button onclick="switchCategory(1)" class="category-btn" style="background-color: rgb(180, 180, 180);">制御構文</button>
                <button onclick="switchCategory(2)" class="category-btn" style="background-color: rgb(250, 215, 220);">マウス操作</button>
                <button onclick="switchCategory(3)" class="category-btn" style="background-color: rgb(210, 255, 240);">キーボード操作</button>
                <button onclick="switchCategory(4)" class="category-btn" style="background-color: rgb(225, 245, 230);">UIAutomation</button>
                <button onclick="switchCategory(5)" class="category-btn" style="background-color: rgb(250, 250, 230);">ファイル操作</button>
                <button onclick="switchCategory(6)" class="category-btn" style="background-color: rgb(240, 230, 250);">データ処理</button>
                <button onclick="switchCategory(7)" class="category-btn" style="background-color: rgb(245, 245, 245);">スクリプト実行</button>
                <button onclick="switchCategory(8)" class="category-btn" style="background-color: rgb(220, 235, 255);">Excel処理</button>
                <button onclick="switchCategory(9)" class="category-btn" style="background-color: rgb(255, 250, 220);">ウインドウ操作</button>
                <button onclick="switchCategory(10)" class="category-btn" style="background-color: rgb(255, 235, 240);">画像処理</button>
            </div>

            <!-- ノード追加ボタンパネル（カテゴリーごとに切り替わる） -->
            <div id="node-buttons-container">
                <!-- カテゴリー1：制御構文 -->
                <div id="category-panel-1" class="category-panel active">
                    <!-- ボタン設定.jsonから動的に生成 -->
                </div>
                <!-- カテゴリー2：マウス操作 -->
                <div id="category-panel-2" class="category-panel">
                    <!-- ボタン設定.jsonから動的に生成 -->
                </div>
                <!-- カテゴリー3-10も同様 -->
                <div id="category-panel-3" class="category-panel"></div>
                <div id="category-panel-4" class="category-panel"></div>
                <div id="category-panel-5" class="category-panel"></div>
                <div id="category-panel-6" class="category-panel"></div>
                <div id="category-panel-7" class="category-panel"></div>
                <div id="category-panel-8" class="category-panel"></div>
                <div id="category-panel-9" class="category-panel"></div>
                <div id="category-panel-10" class="category-panel"></div>
            </div>
        </div>

        <!-- 中央：左右2パネル表示（レイヤーナビゲーション） -->
        <div id="center-container">
            <!-- メインレイヤーパネル -->
            <div id="left-layer-panel" class="main-layer-panel">
                <div id="layer-0" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー0</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-1" class="layer-panel" style="display: block;">
                    <div class="layer-label">レイヤー1</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-2" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー2</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-3" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー3</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-4" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー4</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-5" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー5</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-6" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー6</div>
                    <div class="node-list-container"></div>
                </div>
            </div>

            <!-- ドリルダウンパネル（ピンクノードクリック時に表示） -->
            <div id="right-layer-panel" class="drilldown-panel empty">
                <div class="empty-message">
                    <span>🟣 ピンクノードをクリックすると詳細が表示されます</span>
                </div>
                <!-- レイヤーコンテンツはここに動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 説明エリア（左下固定） -->
    <div id="description-panel">
        <div class="panel-label">説明</div>
        <div id="description-text">ここに説明文が表示されます。</div>
    </div>

    <!-- フッター: 28px -->
    <div id="hierarchy-path">
        📍 階層パス: <span id="path-text">レイヤー1</span>
    </div>

    <!-- ホバープレビュー -->
    <div class="hover-preview" id="hoverPreview">
        <div class="hover-preview-header">
            <span>🔍</span>
            <span id="previewTitle">プレビュー</span>
        </div>
        <div class="hover-preview-content" id="previewContent">
            <!-- 動的に生成 -->
        </div>
    </div>

    <!-- ESCキーヒント -->
    <div class="esc-hint" id="escHint">
        ESCキーで戻る
    </div>

    <!-- 右クリックメニュー -->
    <div id="context-menu" class="context-menu">
        <div id="layerize-menu-item" class="context-menu-item" onclick="layerizeNode()" style="background-color: pink; font-weight: bold; display: none;">📦 レイヤー化</div>
        <div class="context-menu-item" onclick="openNodeSettingsFromContextMenu()">⚙️ ノード設定</div>
        <div class="context-menu-item" onclick="renameNode()">名前変更</div>
        <div class="context-menu-item" onclick="editScript()">スクリプト編集</div>
        <div class="context-menu-item" onclick="executeScript()">スクリプト実行</div>
        <div class="context-menu-item" onclick="toggleRedBorder()">赤枠トグル</div>
        <div class="context-menu-item" onclick="applyRedBorderToGroup()">赤枠グループ適用</div>
        <div class="context-menu-item" onclick="deleteNode()">削除</div>
    </div>

    <!-- 変数管理モーダル -->
    <div id="variable-modal" class="modal">
        <div class="modal-content">
            <h2>変数管理</h2>
            <button class="modal-close" onclick="closeVariableModal()">×</button>
            <div class="modal-body">
                <button onclick="addVariablePrompt()">➕ 新しい変数を追加</button>
                <table id="variable-table">
                    <thead>
                        <tr>
                            <th>変数名</th>
                            <th>値</th>
                            <th>タイプ</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="variable-list">
                        <!-- 変数がここに表示される -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- フォルダ切替モーダル -->
    <div id="folder-modal" class="modal">
        <div class="modal-content">
            <h2>フォルダ切替</h2>
            <button class="modal-close" onclick="closeFolderModal()">×</button>
            <div class="modal-body">
                <select id="folder-select" size="10">
                    <!-- フォルダ一覧が表示される -->
                </select>
                <button onclick="selectFolder()">選択</button>
            </div>
        </div>
    </div>

    <!-- スクリプト編集モーダル -->
    <div id="script-modal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 800px;">
            <h2>スクリプト編集: <span id="script-node-name"></span></h2>
            <button class="modal-close" onclick="closeScriptModal()">×</button>
            <div class="modal-body">
                <textarea id="script-editor" rows="20" style="width: 100%; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px;"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="saveScript()">💾 保存</button>
                    <button onclick="closeScriptModal()">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ノード詳細設定モーダル -->
    <div id="node-settings-modal" class="modal">
        <div class="modal-content" style="width: 70%; max-width: 700px;">
            <h2>ノード設定: <span id="settings-node-name"></span></h2>
            <button class="modal-close" onclick="closeNodeSettingsModal()">×</button>
            <div class="modal-body">
                <!-- 基本設定 -->
                <div style="margin-bottom: 15px;">
                    <label><strong>ノード名:</strong></label>
                    <input type="text" id="settings-node-text" style="width: 100%; padding: 5px;" />
                </div>

                <!-- 外観設定 -->
                <div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                    <label><strong>外観設定:</strong></label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div>
                            <label>背景色:</label>
                            <select id="settings-node-color" style="width: 100%; padding: 5px;">
                                <option value="White">白 (White)</option>
                                <option value="Pink">ピンク (Pink)</option>
                                <option value="LightGray">灰色 (LightGray)</option>
                                <option value="LightBlue">水色 (LightBlue)</option>
                                <option value="LightGreen">緑 (LightGreen)</option>
                                <option value="LightYellow">黄色 (LightYellow)</option>
                                <option value="LightCoral">コーラル (LightCoral)</option>
                                <option value="Lavender">ラベンダー (Lavender)</option>
                            </select>
                        </div>
                        <div>
                            <label>幅:</label>
                            <input type="number" id="settings-node-width" min="80" max="500" style="width: 100%; padding: 5px;" />
                        </div>
                        <div>
                            <label>高さ:</label>
                            <input type="number" id="settings-node-height" min="30" max="200" style="width: 100%; padding: 5px;" />
                        </div>
                        <div>
                            <label>X座標:</label>
                            <input type="number" id="settings-node-x" min="0" max="2000" style="width: 100%; padding: 5px;" />
                        </div>
                        <div>
                            <label>Y座標:</label>
                            <input type="number" id="settings-node-y" min="0" max="5000" style="width: 100%; padding: 5px;" />
                        </div>
                    </div>
                </div>

                <div id="settings-custom-fields">
                    <!-- 処理番号に応じたカスタムフィールドがここに表示される -->
                </div>

                <div style="margin-top: 15px;">
                    <label><strong>スクリプト:</strong></label>
                    <textarea id="settings-node-script" rows="10" style="width: 100%; font-family: 'Consolas', 'Courier New', monospace; font-size: 12px;"></textarea>
                </div>

                <div style="margin-top: 15px;">
                    <button onclick="saveNodeSettings()">💾 保存</button>
                    <button onclick="closeNodeSettingsModal()">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- コード生成結果モーダル -->
    <div id="code-result-modal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 900px;">
            <h2>✅ コード生成完了</h2>
            <button class="modal-close" onclick="closeCodeResultModal()">×</button>
            <div class="modal-body">
                <div id="code-result-info" style="margin-bottom: 15px;">
                    <!-- 結果情報（ノード数、出力先など） -->
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">生成されたコード:</label>
                </div>
                <textarea id="code-result-preview" rows="20" readonly style="width: 100%; font-family: 'Consolas', 'Courier New', monospace; font-size: 12px; background: #f5f5f5; border: 1px solid #ccc; padding: 10px;"></textarea>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="copyGeneratedCode()">📋 コピー</button>
                    <button onclick="openGeneratedFile()">📂 ファイルを開く</button>
                    <button onclick="closeCodeResultModal()">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 条件分岐ダイアログ -->
    <!-- ============================================ -->
    <div id="condition-builder-modal" class="modal">
        <div class="modal-content" style="width: 900px; max-height: 80vh; overflow-y: auto;">
            <h2>条件式の設定</h2>

            <div id="condition-items-container" style="margin-bottom: 20px;">
                <!-- 条件入力フィールドが動的に追加される -->
            </div>

            <button id="btn-add-condition" class="button" style="margin-bottom: 20px;">条件追加</button>

            <div style="margin-bottom: 20px;">
                <label>条件式プレビュー:</label>
                <textarea id="condition-preview" readonly style="width: 100%; height: 120px; padding: 10px; font-family: monospace; background-color: #f5f5f5;"></textarea>
            </div>

            <div class="modal-buttons">
                <button id="btn-condition-save" class="button">保存</button>
                <button id="btn-condition-cancel" class="button">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ループダイアログ -->
    <!-- ============================================ -->
    <div id="loop-builder-modal" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80vh; overflow-y: auto;">
            <h2>ループ構文の設定</h2>

            <div style="margin-bottom: 20px;">
                <label>ループの種類を選択してください:</label>
                <select id="loop-type-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="for">固定回数ループ</option>
                    <option value="foreach">コレクションのループ</option>
                    <option value="while">条件付きループ</option>
                </select>
            </div>

            <div id="loop-settings-container" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px;">
                <!-- ループタイプに応じた設定フィールドが動的に表示される -->
            </div>

            <div style="margin-bottom: 20px;">
                <label>ループ構文プレビュー:</label>
                <textarea id="loop-preview" readonly style="width: 100%; height: 120px; padding: 10px; font-family: monospace; background-color: #f5f5f5;"></textarea>
            </div>

            <div class="modal-buttons">
                <button id="btn-loop-save" class="button">保存</button>
                <button id="btn-loop-cancel" class="button">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- レイヤー詳細モーダル -->
    <div id="layer-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">📋</span>
                    <span id="modal-layer-title">レイヤー詳細</span>
                    <span id="modal-parent-info" class="modal-parent-badge"></span>
                </div>
                <button class="modal-close-btn" onclick="closeLayerDetailModal()">✕</button>
            </div>
            <div class="modal-content">
                <div class="layer-panel">
                    <div class="layer-label" id="modal-layer-label">レイヤー読み込み中...</div>
                    <div class="modal-node-container" id="modal-node-container">
                        <canvas id="modal-arrow-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- arrow-drawing.jsの内容はapp-legacy.jsに統合されました -->
    <script src="app-legacy.js?v=1.0.234"></script>
    <!-- Aurora Arrow Patch: Neumorphism + Auroraデザインのグラデーション矢印 -->
    <script src="arrow-patch-hybrid.js?v=1.0.0"></script>
    <!-- レイヤー詳細モーダル機能 -->
    <script>
// ============================================
// レイヤー詳細モーダル（window.open の代替）
// ============================================

let modalCurrentLayer = null;
let modalCurrentNodes = [];

function showLayerDetailModal(layer, nodes, parentNode) {
    console.log(`[モーダル] === showLayerDetailModal 呼び出し ===`);
    console.log(`[モーダル] レイヤー: ${layer}, ノード数: ${nodes.length}`);
    console.log(`[モーダル] ノードデータ:`, nodes);

    modalCurrentLayer = layer;
    modalCurrentNodes = nodes;

    // モーダル要素を取得
    const modal = document.getElementById('layer-detail-modal');
    const layerTitle = document.getElementById('modal-layer-title');
    const layerLabel = document.getElementById('modal-layer-label');
    const parentInfo = document.getElementById('modal-parent-info');
    const container = document.getElementById('modal-node-container');

    console.log(`[モーダル] DOM要素チェック:`);
    console.log(`[モーダル]   - modal: ${modal ? '✓' : '✗'}`);
    console.log(`[モーダル]   - layerTitle: ${layerTitle ? '✓' : '✗'}`);
    console.log(`[モーダル]   - container: ${container ? '✓' : '✗'}`);

    // タイトル設定
    if (layerTitle) {
        layerTitle.textContent = `レイヤー${layer} 詳細`;
    }

    if (layerLabel) {
        layerLabel.textContent = `レイヤー${layer}`;
    }

    // 親ノード情報
    if (parentInfo && parentNode) {
        parentInfo.textContent = `親: ${parentNode.text || parentNode.id}`;
        parentInfo.style.display = 'inline-block';
    } else if (parentInfo) {
        parentInfo.style.display = 'none';
    }

    // コンテナをクリア（Canvasは残す）
    if (container) {
        console.log(`[モーダル] コンテナをクリアしてノードを描画開始`);
        const canvas = document.getElementById('modal-arrow-canvas');
        container.innerHTML = '';
        if (canvas) {
            container.appendChild(canvas);
        }

        // ノードを描画
        console.log(`[モーダル] ${nodes.length}個のノードを描画中...`);
        nodes.forEach((node, index) => {
            console.log(`[モーダル] ノード${index + 1}: text="${node.text}", x=${node.x}, y=${node.y}, color=${node.color}`);
            const btn = document.createElement('div');
            btn.className = 'node-button';

            // テキストの省略表示（20文字以上は省略）
            const displayText = node.text.length > 20 ? node.text.substring(0, 20) + '...' : node.text;
            btn.textContent = displayText;

            // 位置とサイズ設定
            btn.style.position = 'absolute';
            btn.style.left = `${node.x || 90}px`;
            btn.style.top = `${node.y || 10}px`;
            btn.style.width = `${node.width || 120}px`;
            btn.style.height = `${node.height || 40}px`;
            btn.style.backgroundColor = node.color || 'white';

            // 赤枠
            if (node.redBorder) {
                btn.style.border = '3px solid red';
            }

            // モーダル内のノードはクリック不可にする
            btn.style.cursor = 'default';
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`[モーダル] ノードクリック（読み取り専用）: ${node.text}`);
            };

            container.appendChild(btn);
            console.log(`[モーダル] ノード${index + 1}をコンテナに追加: ${btn.textContent}`);
        });

        console.log(`[モーダル] コンテナの子要素数: ${container.children.length}`);

        // Canvas初期化と矢印描画
        setTimeout(() => {
            console.log(`[モーダル] Canvas初期化と矢印描画を開始`);
            initializeModalCanvas();
            drawModalArrows(nodes);
        }, 100);
    } else {
        console.error(`[モーダル] エラー: containerが見つかりません！`);
    }

    // モーダル表示
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 背景スクロール防止
    }

    console.log(`[モーダル] レイヤー${layer}に${nodes.length}個のノード表示完了`);
}

function closeLayerDetailModal() {
    console.log('[モーダル] モーダルを閉じます');

    const modal = document.getElementById('layer-detail-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // 背景スクロール復元
    }

    modalCurrentLayer = null;
    modalCurrentNodes = [];
}

function initializeModalCanvas() {
    const canvas = document.getElementById('modal-arrow-canvas');
    const container = document.getElementById('modal-node-container');

    if (!canvas || !container) {
        console.warn('[モーダル] CanvasまたはContainerが見つかりません');
        return;
    }

    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    console.log(`[モーダル] Canvas初期化: ${canvas.width}x${canvas.height}`);
}

function drawModalArrows(nodes) {
    const canvas = document.getElementById('modal-arrow-canvas');
    if (!canvas) {
        console.warn('[モーダル] Canvasが見つかりません');
        return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('[モーダル] Canvas 2Dコンテキストの取得に失敗');
        return;
    }

    // Canvasをクリア
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ノードをY座標でソート
    const sortedNodes = [...nodes].sort((a, b) => (a.y || 0) - (b.y || 0));

    // ノード間に矢印を描画
    for (let i = 0; i < sortedNodes.length - 1; i++) {
        const fromNode = sortedNodes[i];
        const toNode = sortedNodes[i + 1];

        const fromX = fromNode.x + (fromNode.width / 2);
        const fromY = fromNode.y + fromNode.height;
        const toX = toNode.x + (toNode.width / 2);
        const toY = toNode.y;

        // Auroraグラデーション矢印
        const gradient = ctx.createLinearGradient(fromX, fromY, toX, toY);
        gradient.addColorStop(0.0, '#667eea');
        gradient.addColorStop(0.25, '#f472b6');
        gradient.addColorStop(0.5, '#06b6d4');
        gradient.addColorStop(0.75, '#10b981');
        gradient.addColorStop(1.0, '#fbbf24');

        ctx.strokeStyle = gradient;
        ctx.lineWidth = 3;
        ctx.setLineDash([]);

        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.stroke();
    }

    console.log(`[モーダル] ${sortedNodes.length - 1}本の矢印を描画`);
}

// オーバーレイクリックで閉じる
document.addEventListener('click', (e) => {
    const modal = document.getElementById('layer-detail-modal');
    if (modal && e.target === modal) {
        closeLayerDetailModal();
    }
});

// Escapeキーで閉じる
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('layer-detail-modal');
        if (modal && modal.style.display === 'flex') {
            closeLayerDetailModal();
        }
    }
});
    </script>
</body>
</html>
