<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIpowershell - Visual RPA Platform (レイヤーナビゲーション)</title>
    <link rel="stylesheet" href="style-legacy.css?v=1.0.200">
</head>
<body>
    <!-- ヘッダー: 40px -->
    <div id="header">
        <!-- メニューバー -->
        <div id="menubar">
            <div class="menu-item" style="font-weight: bold; color: #007acc; cursor: default;">UIpowershell <span id="app-version" style="font-size: 0.85em; color: #666;">v1.0.236</span></div>
            <div class="menu-item" onclick="executeCode()">実行</div>
            <div class="menu-item" onclick="openVariableModal()">変数</div>
            <div class="menu-item" onclick="createFolder()">フォルダ作成</div>
            <div class="menu-item" onclick="switchFolder()">フォルダ切替</div>
            <div class="menu-item" onclick="deleteAllNodes()" style="color: #dc3545;">🗑️ 全削除</div>
            <div class="menu-item" onclick="createSnapshot()">📸 スナップショット</div>
            <div class="menu-item" onclick="restoreSnapshot()">↩️ 復元</div>
        </div>

        <!-- ダークモード切り替え（Neumorphismデザインでは非対応のためコメントアウト）
        <button id="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="dark-mode-icon">🌙</span>
            <span id="dark-mode-text">ダーク</span>
        </button>
        -->

        <!-- ツールバー -->
        <div id="toolbar">
            <!-- ツールバーは空（メニューバーで操作） -->
        </div>
    </div>

    <!-- パンくずリスト -->
    <div class="breadcrumb-bar" id="breadcrumb">
        <div class="breadcrumb-item current" data-layer="1">
            📍 メインフロー
        </div>
    </div>

    <!-- メインコンテナ: 2ペイン構成（レイヤーナビゲーション） -->
    <div id="main-container">
        <!-- 左側：操作パネル（10カテゴリー切り替え） -->
        <div id="left-panel">
            <!-- カテゴリー切り替えボタン -->
            <div id="category-buttons">
                <button onclick="switchCategory(1)" class="category-btn" style="background-color: rgb(180, 180, 180);">制御構文</button>
                <button onclick="switchCategory(2)" class="category-btn" style="background-color: rgb(250, 215, 220);">マウス操作</button>
                <button onclick="switchCategory(3)" class="category-btn" style="background-color: rgb(210, 255, 240);">キーボード操作</button>
                <button onclick="switchCategory(4)" class="category-btn" style="background-color: rgb(225, 245, 230);">UIAutomation</button>
                <button onclick="switchCategory(5)" class="category-btn" style="background-color: rgb(250, 250, 230);">ファイル操作</button>
                <button onclick="switchCategory(6)" class="category-btn" style="background-color: rgb(240, 230, 250);">データ処理</button>
                <button onclick="switchCategory(7)" class="category-btn" style="background-color: rgb(245, 245, 245);">スクリプト実行</button>
                <button onclick="switchCategory(8)" class="category-btn" style="background-color: rgb(220, 235, 255);">Excel処理</button>
                <button onclick="switchCategory(9)" class="category-btn" style="background-color: rgb(255, 250, 220);">ウインドウ操作</button>
                <button onclick="switchCategory(10)" class="category-btn" style="background-color: rgb(255, 235, 240);">画像処理</button>
            </div>

            <!-- ノード追加ボタンパネル（カテゴリーごとに切り替わる） -->
            <div id="node-buttons-container">
                <!-- カテゴリー1：制御構文 -->
                <div id="category-panel-1" class="category-panel active">
                    <!-- ボタン設定.jsonから動的に生成 -->
                </div>
                <!-- カテゴリー2：マウス操作 -->
                <div id="category-panel-2" class="category-panel">
                    <!-- ボタン設定.jsonから動的に生成 -->
                </div>
                <!-- カテゴリー3-10も同様 -->
                <div id="category-panel-3" class="category-panel"></div>
                <div id="category-panel-4" class="category-panel"></div>
                <div id="category-panel-5" class="category-panel"></div>
                <div id="category-panel-6" class="category-panel"></div>
                <div id="category-panel-7" class="category-panel"></div>
                <div id="category-panel-8" class="category-panel"></div>
                <div id="category-panel-9" class="category-panel"></div>
                <div id="category-panel-10" class="category-panel"></div>
            </div>
        </div>

        <!-- 中央：左右2パネル表示（レイヤーナビゲーション） -->
        <div id="center-container">
            <!-- メインレイヤーパネル -->
            <div id="left-layer-panel" class="main-layer-panel">
                <div id="layer-0" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー0</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-1" class="layer-panel" style="display: block;">
                    <div class="layer-label">レイヤー1</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-2" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー2</div>
                    <div class="node-list-container">
                        <!-- ノードが縦に並ぶ -->
                    </div>
                </div>
                <div id="layer-3" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー3</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-4" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー4</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-5" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー5</div>
                    <div class="node-list-container"></div>
                </div>
                <div id="layer-6" class="layer-panel" style="display: none;">
                    <div class="layer-label">レイヤー6</div>
                    <div class="node-list-container"></div>
                </div>
            </div>

            <!-- ドリルダウンパネル（ピンクノードクリック時に表示） -->
            <div id="right-layer-panel" class="drilldown-panel empty">
                <!-- レイヤーコンテンツはここに動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 説明エリア（左下固定） -->
    <div id="description-panel">
        <div class="panel-label">説明</div>
        <div id="description-text">ここに説明文が表示されます。</div>
    </div>

    <!-- フッター: 28px -->
    <div id="hierarchy-path">
        📍 階層パス: <span id="path-text">レイヤー1</span>
    </div>

    <!-- ホバープレビュー -->
    <div class="hover-preview" id="hoverPreview">
        <div class="hover-preview-header">
            <span>🔍</span>
            <span id="previewTitle">プレビュー</span>
        </div>
        <div class="hover-preview-content" id="previewContent">
            <!-- 動的に生成 -->
        </div>
    </div>

    <!-- ESCキーヒント -->
    <div class="esc-hint" id="escHint">
        ESCキーで戻る
    </div>

    <!-- 右クリックメニュー -->
    <div id="context-menu" class="context-menu">
        <div id="layerize-menu-item" class="context-menu-item" onclick="layerizeNode()" style="background-color: pink; font-weight: bold; display: none;">📦 レイヤー化</div>
        <div class="context-menu-item" onclick="openNodeSettingsFromContextMenu()">⚙️ ノード設定</div>
        <div class="context-menu-item" onclick="renameNode()">名前変更</div>
        <div class="context-menu-item" onclick="editScript()">スクリプト編集</div>
        <div class="context-menu-item" onclick="executeScript()">スクリプト実行</div>
        <div class="context-menu-item" onclick="toggleRedBorder()">赤枠トグル</div>
        <div class="context-menu-item" onclick="applyRedBorderToGroup()">赤枠グループ適用</div>
        <div class="context-menu-item" onclick="deleteNode()">削除</div>
    </div>

    <!-- 変数管理モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    変数管理UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/variables/manage
    - PowerShell関数: 変数管理を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: openVariableModal()を修正してAPI呼び出しに変更
    - 追加・編集・削除すべての操作をPowerShell Windows Formsダイアログ内で実行
    -->

    <!-- フォルダ切替モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    フォルダ切替UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/folders/switch-dialog
    - PowerShell関数: フォルダ切替を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: switchFolder()を修正してAPI呼び出しに変更
    - フォルダ選択と新規作成を統合ダイアログ内で実行
    - ListBoxダブルクリックで即座に選択可能
    -->

    <!-- スクリプト編集モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    スクリプト編集UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/node/edit-script
    - PowerShell関数: 複数行テキストを編集 (13_コードサブ汎用関数.ps1)
    - JavaScript: editScript()を修正してAPI呼び出しに変更

    理由:
    - 他のパラメータ入力UI（条件分岐、ループ等）との一貫性向上
    - コードの統一化によるメンテナンス性向上
    -->

    <!-- ノード詳細設定モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    ノード設定UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/node/settings
    - PowerShell関数: ノード設定を編集 (13_コードサブ汎用関数.ps1)
    - JavaScript: openNodeSettings()を修正してAPI呼び出しに変更
    - カスタムフィールド（条件分岐、ループ）も含めて完全移行
    -->

    <!-- コード生成結果モーダル -->
    <!-- コード結果モーダル (廃止) -->
    <!--
    [移行完了] 2025-11-15
    コード結果UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - API: POST /api/code-result/show
    - PowerShell関数: コード結果を表示 (13_コードサブ汎用関数.ps1)
    - JavaScript: executeCode()を修正してコード生成後にAPI呼び出しを追加
    - リサイズ可能なダイアログ（900x700、最小700x500）
    - Consolasフォントでコードプレビュー表示
    - コピーボタン（クリップボードにコピー）
    - ファイルを開くボタン（Start-Processで開く）
    -->

    <!-- ============================================ -->
    <!-- 条件分岐・ループダイアログ (廃止) -->
    <!-- ============================================ -->
    <!--
    [移行完了] 2025-11-15
    条件分岐・ループの編集UIをWeb UIモーダルからPowerShell Windows Forms版に移行しました。

    変更内容:
    - 条件分岐: ShowConditionBuilder → 1_2 (00_code/1-2.ps1)
    - ループ: ShowLoopBuilder → 1_3 (00_code/1-3.ps1)

    理由:
    - 他のパラメータ入力UI (3-1.ps1, 5-1.ps1, 1-8.ps1など) との一貫性向上
    - コードの統一化によるメンテナンス性向上

    以下のモーダルダイアログは使用されなくなりました:
    - condition-builder-modal
    - loop-builder-modal
    -->

    <!-- レイヤー詳細モーダル -->
    <div id="layer-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">📋</span>
                    <span id="modal-layer-title">レイヤー詳細</span>
                    <span id="modal-parent-info" class="modal-parent-badge"></span>
                </div>
                <button class="modal-close-btn" onclick="closeLayerDetailModal()">✕</button>
            </div>
            <div class="modal-content">
                <div class="layer-panel">
                    <div class="layer-label" id="modal-layer-label">レイヤー読み込み中...</div>
                    <div class="modal-node-container" id="modal-node-container">
                        <canvas id="modal-arrow-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- arrow-drawing.jsの内容はapp-legacy.jsに統合されました -->
    <script src="app-legacy.js?v=1.0.242"></script>
    <!-- Aurora Arrow Patch: Neumorphism + Auroraデザインのグラデーション矢印 -->
    <script src="arrow-patch-hybrid.js?v=1.0.0"></script>
    <!-- レイヤー詳細モーダル機能 -->
    <script>
// ============================================
// レイヤー詳細モーダル（window.open の代替）
// ============================================

let modalCurrentLayer = null;
let modalCurrentNodes = [];

function showLayerDetailModal(layer, nodes, parentNode) {
    console.log(`[モーダル] === showLayerDetailModal 呼び出し ===`);
    console.log(`[モーダル] レイヤー: ${layer}, ノード数: ${nodes.length}`);
    console.log(`[モーダル] ノードデータ:`, nodes);

    modalCurrentLayer = layer;
    modalCurrentNodes = nodes;

    // モーダル要素を取得
    const modal = document.getElementById('layer-detail-modal');
    const layerTitle = document.getElementById('modal-layer-title');
    const layerLabel = document.getElementById('modal-layer-label');
    const parentInfo = document.getElementById('modal-parent-info');
    const container = document.getElementById('modal-node-container');

    console.log(`[モーダル] DOM要素チェック:`);
    console.log(`[モーダル]   - modal: ${modal ? '✓' : '✗'}`);
    console.log(`[モーダル]   - layerTitle: ${layerTitle ? '✓' : '✗'}`);
    console.log(`[モーダル]   - container: ${container ? '✓' : '✗'}`);

    // タイトル設定
    if (layerTitle) {
        layerTitle.textContent = `レイヤー${layer} 詳細`;
    }

    if (layerLabel) {
        layerLabel.textContent = `レイヤー${layer}`;
    }

    // 親ノード情報
    if (parentInfo && parentNode) {
        parentInfo.textContent = `親: ${parentNode.text || parentNode.id}`;
        parentInfo.style.display = 'inline-block';
    } else if (parentInfo) {
        parentInfo.style.display = 'none';
    }

    // コンテナをクリア（Canvasは残す）
    if (container) {
        console.log(`[モーダル] コンテナをクリアしてノードを描画開始`);
        const canvas = document.getElementById('modal-arrow-canvas');
        container.innerHTML = '';
        if (canvas) {
            container.appendChild(canvas);
        }

        // ノードを描画
        console.log(`[モーダル] ${nodes.length}個のノードを描画中...`);
        nodes.forEach((node, index) => {
            console.log(`[モーダル] ノード${index + 1}: text="${node.text}", x=${node.x}, y=${node.y}, color=${node.color}`);
            const btn = document.createElement('div');
            btn.className = 'node-button';

            // テキストの省略表示（20文字以上は省略）
            const displayText = node.text.length > 20 ? node.text.substring(0, 20) + '...' : node.text;
            btn.textContent = displayText;

            // 位置とサイズ設定
            btn.style.position = 'absolute';
            btn.style.left = `${node.x || 90}px`;
            btn.style.top = `${node.y || 10}px`;
            btn.style.width = `${node.width || 120}px`;
            btn.style.height = `${node.height || 40}px`;
            btn.style.backgroundColor = node.color || 'white';

            // 赤枠
            if (node.redBorder) {
                btn.style.border = '3px solid red';
            }

            // モーダル内のノードはクリック不可にする
            btn.style.cursor = 'default';
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`[モーダル] ノードクリック（読み取り専用）: ${node.text}`);
            };

            container.appendChild(btn);
            console.log(`[モーダル] ノード${index + 1}をコンテナに追加: ${btn.textContent}`);
        });

        console.log(`[モーダル] コンテナの子要素数: ${container.children.length}`);

        // Canvas初期化と矢印描画
        setTimeout(() => {
            console.log(`[モーダル] Canvas初期化と矢印描画を開始`);
            initializeModalCanvas();
            drawModalArrows(nodes);
        }, 100);
    } else {
        console.error(`[モーダル] エラー: containerが見つかりません！`);
    }

    // モーダル表示
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 背景スクロール防止
    }

    console.log(`[モーダル] レイヤー${layer}に${nodes.length}個のノード表示完了`);
}

function closeLayerDetailModal() {
    console.log('[モーダル] モーダルを閉じます');

    const modal = document.getElementById('layer-detail-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // 背景スクロール復元
    }

    modalCurrentLayer = null;
    modalCurrentNodes = [];
}

function initializeModalCanvas() {
    const canvas = document.getElementById('modal-arrow-canvas');
    const container = document.getElementById('modal-node-container');

    if (!canvas || !container) {
        console.warn('[モーダル] CanvasまたはContainerが見つかりません');
        return;
    }

    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    console.log(`[モーダル] Canvas初期化: ${canvas.width}x${canvas.height}`);
}

function drawModalArrows(nodes) {
    const canvas = document.getElementById('modal-arrow-canvas');
    if (!canvas) {
        console.warn('[モーダル] Canvasが見つかりません');
        return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('[モーダル] Canvas 2Dコンテキストの取得に失敗');
        return;
    }

    // Canvasをクリア
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ノードをY座標でソート
    const sortedNodes = [...nodes].sort((a, b) => (a.y || 0) - (b.y || 0));

    // ノード間に矢印を描画
    for (let i = 0; i < sortedNodes.length - 1; i++) {
        const fromNode = sortedNodes[i];
        const toNode = sortedNodes[i + 1];

        const fromX = fromNode.x + (fromNode.width / 2);
        const fromY = fromNode.y + fromNode.height;
        const toX = toNode.x + (toNode.width / 2);
        const toY = toNode.y;

        // Auroraグラデーション矢印
        const gradient = ctx.createLinearGradient(fromX, fromY, toX, toY);
        gradient.addColorStop(0.0, '#667eea');
        gradient.addColorStop(0.25, '#f472b6');
        gradient.addColorStop(0.5, '#06b6d4');
        gradient.addColorStop(0.75, '#10b981');
        gradient.addColorStop(1.0, '#fbbf24');

        ctx.strokeStyle = gradient;
        ctx.lineWidth = 3;
        ctx.setLineDash([]);

        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.stroke();
    }

    console.log(`[モーダル] ${sortedNodes.length - 1}本の矢印を描画`);
}

// オーバーレイクリックで閉じる
document.addEventListener('click', (e) => {
    const modal = document.getElementById('layer-detail-modal');
    if (modal && e.target === modal) {
        closeLayerDetailModal();
    }
});

// Escapeキーで閉じる
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('layer-detail-modal');
        if (modal && modal.style.display === 'flex') {
            closeLayerDetailModal();
        }
    }
});
    </script>
</body>
</html>
